<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
]>
<appendix id="app-ha-migration">
 <title>Upgrading Your Cluster and Updating Software Packages</title>
 <abstract>
  <para>
   This chapter covers two different scenarios: upgrading a cluster to
   another version of &productnamereg; (either a major release or a service
   pack) as opposed to updating individual packages on cluster nodes.
  </para>
 </abstract>
 
 <sect1 id="sec-ha-migration-terminology">
  <title>Terminology</title>
  
  <para>
   In the following, find definitions of the most important terms used in
   this chapter:
  </para>
  
  <!--taroth 2014-08-19: CAVE - the following is copied from SLE 12 SVN: sle_update.xml,
   sec.update.terminology-->
  
  <variablelist>
   <varlistentry>
    <term>Major Release</term>
    <term>General Availability (GA) Version</term>
    <listitem>
     <para>
      The Major Release of &sle; (or any software product) is a new version
      which brings new features and tools, decommissions previously
      deprecated components and comes with backward incompatible changes.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Service Pack (SP)</term>
    <listitem>
     <para>
      Combines several patches into a form which is easy to install or
      deploy. Service packs are numbered and usually contain security fixes,
      updates, upgrades, or enhancements of programs.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Update</term>
    <listitem>
     <para>
      Installation of a newer <emphasis>minor</emphasis> version of a
      package.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Upgrade</term>
    <listitem>
     <para>
      Installation of a newer <emphasis>major</emphasis> version of a
      package or distribution, which brings <emphasis>new
       features</emphasis>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 
 <sect1 id="sec-ha-migration-upgrade">
  <title>Upgrading your Cluster to the Latest Product Version</title>
  
  <para>
   Which upgrade path is supported and how to perform the upgrade depends on
   the current product version your cluster is running on and on the target
   version you want to migrate to. For general information on this, see the
   <citetitle>&sls;&nbsp;11 &deploy;</citetitle>, chapter
   <citetitle>Updating &sle;</citetitle>. It is available at
   &suse-onlinedoc;.
  </para>
  
  <important>
   <title>Required Preparations Before Upgrading</title>
   <itemizedlist>
    <listitem>
     <para>
      Ensure that your system backup is up to date and restorable.
     </para>
    </listitem>
    <listitem>
     <para>
      Test the upgrade procedure on a staging instance of your cluster
      setup first, before performing it in a production environment.
     </para>
     <para>
      This gives you an estimation of the time frame required for the
      maintenance window. It also helps to detect and solve any unexpected
      problems that might arise.
     </para>
    </listitem>
   </itemizedlist>
  </important>
 <sect2 id="sec-ha-migration-sle11">
  <title>Upgrading from SLES&nbsp;10 to SLE&nbsp;HA&nbsp;11</title>

   <important>
    <title>Taking Cluster Offline is Required</title>
    <para> For migrating from &sls; 10 to &sls; 11 (any service pack),
     all cluster nodes must be <emphasis>offline</emphasis> and the cluster must
     be migrated as a whole&mdash;mixed clusters running on &sls;
     10/&sls; 11 are not supported. </para>
   </important>

  <para>
   For convenience, &productname; includes a
   <filename>hb2openais.sh</filename> script with which to convert your data
   while moving from the &hb; to the &ais; cluster stack. The script parses
   the configuration stored in <filename>/etc/ha.d/ha.cf</filename> and
   generates a new configuration file for the &ais; cluster stack.
   Furthermore, it adjusts the CIB to match the &ais; conventions, converts
   the OCFS2 file system and replaces EVMS with cLVM. Any EVMS2 containers
   are converted to cLVM2 volumes. For volume groups referenced in existing
   resources in the CIB, new LVM resources are created.
  </para>

  <para>
   To successfully migrate your cluster from &sls; 10&nbsp;SP4 to &sls; 11,
   you need to execute the following steps:
  </para>

  <orderedlist>
   <listitem>
    <para>
     <xref linkend="pro-ha-migration-sle11-prep" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="pro-ha-migration-sle11-install" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="pro-ha-migration-sle11-test" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="pro-ha-migration-sle11-convert" xrefstyle="select:title"/>
    </para>
   </listitem>
  </orderedlist>

  <para>
   After the conversion has been successfully completed, you can bring the
   upgraded cluster online again.
  </para>

  <note>
   <title>Reverting after Upgrade</title>
   <para>
    After the upgrade process to &sls; 11, reverting back to &sls; 10 is
    <emphasis>not</emphasis> supported.
   </para>
  </note>

  <sect3 id="sec-ha-migration-sle11-prep">
   <title>Preparation and Backup</title>
   <para>
    Before upgrading your cluster to the next product version and converting
    the data accordingly, you need to prepare your current cluster.
   </para>
   <procedure id="pro-ha-migration-sle11-prep">
    <title>Preparing your &sls; 10&nbsp;SP4 Cluster</title>
    <step>
     <para>
      Log in to the cluster.
     </para>
    </step>
    <step>
     <para>
      Review the Heartbeat configuration file
      <filename>/etc/ha.d/ha.cf</filename> and check that all communication
      media support multicasting.
     </para>
    </step>
    <step>
     <para>
      Make sure the following files are equal on all nodes:
      <filename>/etc/ha.d/ha.cf</filename> and
      <filename>/var/lib/heartbeat/crm/cib.xml</filename>.
     </para>
    </step>
    <step>
     <para>
      Take all nodes offline by executing
      <command>rcheartbeat&nbsp;stop</command> on each node.
     </para>
    </step>
    <step>
     <para>
      In addition to the general system backup recommended before updating
      to the latest version, back up the following files, as you need them
      for running the conversion script after the upgrade to &sls; 11:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <filename>/var/lib/heartbeat/crm/cib.xml</filename>
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/var/lib/heartbeat/hostcache</filename>
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/ha.d/ha.cf </filename>
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/logd.cf</filename>
       </para>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>
      If you have EVMS2 resources, convert non-LVM EVMS2 volumes to
      compatibility volumes on &sls; 10. During the conversion process (see
      <xref linkend="sec-ha-migration-sle11-convert"/>), these are then
      turned into LVM2 volume groups. After conversion, make sure to mark
      each volume group as a member of the &ha; cluster with
      <command>vgchange -c y</command>.
<!--taroth 091113: fix for https://bugzilla.novell.com/show_bug.cgi?id=548093#c29-->
     </para>
    </step>
   </procedure>
  </sect3>

  <sect3 id="sec-ha-migration-sle11-install">
   <title>Upgrade/Installation</title>
   <para>
    After preparing the cluster and backing up the files, do a fresh
    installation of &sle; 11 on your cluster nodes.
   </para>
   <procedure id="pro-ha-migration-sle11-install">
    <title>Upgrading to &sle; 11</title>
    <step>
     <para>
      Freshly install &sls; 11 on all cluster nodes.
     </para>
    </step>
    <step>
     <para>
      On all cluster nodes, install &productname; 11 as add-on on top of
      &sls;. For detailed information, see
      <xref
       linkend="sec-ha-installation-add-on"/>.
     </para>
    </step>
   </procedure>
  </sect3>

  <sect3 id="sec-ha-migration-sle11-convert">
   <title>Data Conversion</title>
   <para>
    After having installed &sls; 11 and the &hasi;, you can start with the
    data conversion. The conversion script shipped with the &hasi; has been
    set up with care, but it cannot handle all set-ups in fully automatic
    mode. It alerts you of the changes it makes, but needs interaction and
    decisions from your side. You need to know your cluster in
    detail&mdash;it is up to you to verify that the changes are meaningful.
    The conversion script is located in
    <filename>/usr/lib/heartbeat</filename> (or in
    <filename>/usr/lib64/heartbeat</filename>, if you are using a 64-bit
    system).
   </para>
   <note>
    <title>Executing Test Runs</title>
    <para>
     To make yourself familiar with the conversion process, we highly
     recommend that you test the conversion first (without making any
     changes). You can use the same test directory to do repeated test runs,
     but you only need to copy the files once.
    </para>
   </note>
   <procedure id="pro-ha-migration-sle11-test">
    <title>Testing the Conversion</title>
    <step>
     <para>
      On one of the nodes, create a test directory and copy the backup files
      to the test directory:
     </para>
<screen>$ mkdir /tmp/hb2openais-testdir
$ cp /etc/ha.d/ha.cf /tmp/hb2openais-testdir
$ cp /var/lib/heartbeat/hostcache /tmp/hb2openais-testdir
$ cp /etc/logd.cf /tmp/hb2openais-testdir
$ sudo cp /var/lib/heartbeat/crm/cib.xml /tmp/hb2openais-testdir</screen>
    </step>
    <step>
     <para>
      Start the test run with
     </para>
<screen>$ /usr/lib/heartbeat/hb2openais.sh -T /tmp/hb2openais-testdir -U</screen>
     <para>
      or with the following command, if you are using a 64-bit system:
     </para>
<screen>$ /usr/lib64/heartbeat/hb2openais.sh -T /tmp/hb2openais-testdir -U</screen>
    </step>
    <step>
     <para>
      Read and verify the resulting <filename>openais.conf</filename> and
      <filename>cib-out.xml</filename> files:
     </para>
<screen>$ cd  /tmp/hb2openais-testdir 
$ less openais.conf 
$ crm_verify -V -x cib-out.xml</screen>
    </step>
   </procedure>
   <para>
    For detailed information about the conversion stages, refer to
    <filename>/usr/share/doc/packages/pacemaker/README.hb2openais</filename>
    in your installed &hasi;.
   </para>
   <procedure id="pro-ha-migration-sle11-convert">
    <title>Converting the Data</title>
    <para>
     After doing a test run and checking the output, you can now start with
     the data conversion. You only need to run the conversion on
     <emphasis>one</emphasis> node. The main cluster configuration (the CIB)
     is automatically replicated to the other nodes. All other files that
     need to be replicated are automatically copied by the conversion
     script.
    </para>
    <step>
     <para>
      Make sure that <systemitem class="daemon">sshd</systemitem> is running
      on all nodes with access allowed for &rootuser; in order for the
      conversion script to successfully copy the files to the other cluster
      nodes.
     </para>
    </step>
    <step>
     <para>
      Make sure that all ocfs2 file systems are unmounted.
     </para>
    </step>
    <step>
     <para>
      The &hasi; ships with a default &ais; configuration file. If you want
      to prevent the default configuration from being overwritten during the
      following steps, make a copy of the
      <filename>/etc/ais/openais.conf</filename> configuration file.
     </para>
    </step>
    <step>
     <para>
      Start the conversion script as &rootuser;. If using sudo, specify the
      privileged user using the <option>-u</option> option:
     </para>
<screen>$ /usr/lib/heartbeat/hb2openais.sh -u root</screen>
     <para>
      Based on the configuration stored in
      <filename>/etc/ha.d/ha.cf</filename>, the script will generate a new
      configuration file for the &ais; cluster stack,
      <filename>/etc/ais/openais.conf</filename>. It will also analyze the
      CIB configuration and let you know if your cluster configuration
      requires changes, due to the change from &hb; to &ais;. All file
      processing is done on the node where conversion runs and replicated to
      the other nodes.
     </para>
    </step>
    <step>
     <para>
      Follow the instructions on the screen.
     </para>
    </step>
   </procedure>
   <para>
    After the conversion has been finished successfully, start the new
    cluster stack as described in
    <xref linkend="sec-ha-installation-start"/>.
   </para>
   <para>
    After the upgrade process, reverting back to &sls; 10 is not supported.
   </para>
<!-- <note>
   <title>Reverting the Conversion</title>
   <para>The conversion procedure creates backups of all affected files,
    thus allowing you to revert to the version from the time of backup.</para>
   <para>If you need to revert, run the following command on the node
    where you started the conversion script:</para>
<screen>$ /usr/lib/heartbeat/hb2openais.sh revert</screen>
  </note>-->
  </sect3>

  <sect3 id="sec-ha-migration-sle11-more">
   <title>For More Information</title>
   <para>
    For more details about the conversion script and the stages of the
    conversion, refer to
    <filename>/usr/share/doc/packages/pacemaker/README.hb2openais</filename>
    in your installed &hasi;.
   </para>
  </sect3>
 </sect2>
 <sect2 id="sec-ha-migration-sle11-sp1">
  <title>Upgrading from SLE&nbsp;HA&nbsp;11 to SLE&nbsp;HA&nbsp;11&nbsp;SP1</title>

   <note>
    <title>Rolling Upgrade Between Service Pack Versions</title>
    <para>To successfully migrate an existing cluster from one service pack
     version to the next one, you can do a <quote>rolling upgrade</quote>,
     meaning upgrading one node after the other.</para>
   </note>
   <para>As the main cluster configuration
   file has changed from <filename>/etc/ais/openais.conf</filename> to
   <filename>/etc/corosync/corosync.conf</filename> with &productname;
   11&nbsp;SP1, a script takes care of the necessary conversions. They are
   executed automatically when the
   <systemitem class="resource"
    >openais</systemitem> package is
   updated.
  </para>

<!--https://fate.novell.com/305304-->

  <procedure id="pro-ha-migration-rolling-upgrade">
   <title>Performing a Rolling Upgrade</title>
<!--https://bugzilla.novell.com/show_bug.cgi?id=573817#c6-->
    <warning>
     <title>Active Cluster Stack During Update</title>
     <para> To update any software packages on a node that is part of a running
      cluster, <emphasis>stop</emphasis> the cluster stack <emphasis>on that node</emphasis> before starting the software
      update. In some cases (see <xref linkend="il-ha-update-cond"/>, you can
      alternatively put the cluster into maintenance mode (which is available since
      &productname; 11 SP4). </para>
     <para>
      If the cluster resource manager on a node is active during the software
      update, this can lead to unpredictable results like fencing of active
      nodes.
     </para>
    </warning>
   <step>
    <para>
     Log in as &rootuser; on the node that you want to upgrade and stop
     &ais;:
    </para>
<screen>rcopenais&nbsp;stop</screen>
   </step>
   <step>
    <para>
     Check that your system backup is up-to-date and restorable.
    </para>
   </step>
   <step id="step-ha-migration-upgrade-tolatest">
    <para>
     Perform an upgrade from &sls; 11 to &sls; 11&nbsp;SP1 and from
     &productname; 11 to &productname; 11&nbsp;SP1.
<!--  <remark>taroth 090512:
      need to use hard-coded link here as the target is not included in the same
      set</remark>-->
     For information on how to upgrade your product, refer to the &sls;
     11&nbsp;SP1 &deploy;, chapter <citetitle>Updating &sle;</citetitle>.
    </para>
   </step>
   <step id="step-ha-migration-upgrade-ais">
    <para>
     Restart &ais;/&corosync; on the upgraded node to make the node rejoin
     the cluster:
    </para>
<screen>rcopenais&nbsp;start</screen>
   </step>
   <step>
    <para>
     Take the next node offline and repeat the procedure for that node.
    </para>
   </step>
  </procedure>
 </sect2>
 <sect2 id="sec-ha-migration-sle11-sp2">
  <title>Upgrading from SLE&nbsp;HA&nbsp;11&nbsp;SP1 to SLE&nbsp;HA&nbsp;11&nbsp;SP2</title>

  <para>
   Migrating an existing cluster from &productname; 11&nbsp;SP1 to
   11&nbsp;SP2 is done via a <literal>rolling upgrade</literal>, similar to
   the upgrade procedure from version 11 to 11&nbsp;SP1.
  </para>

  <para>
   Proceed as described in
   <xref linkend="pro-ha-migration-rolling-upgrade"
   /> with the following
   two deviations:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     In
     <xref linkend="step-ha-migration-upgrade-tolatest"
      xrefstyle="select:name"/>,
     upgrade from &sls; 11&nbsp; SP1 to &sls; 11&nbsp;SP2 and from
     &productname; 11&nbsp;SP1 to &productname; 11&nbsp;SP2.
    </para>
<!--taroth 2011-11-23: bnc#730468-->
    <para>
     As Xen Hypervisor is discontinued for 32-bit architectures, you might
     need to solve dependencies for the package
     <systemitem class="resource"
      >drbd-xen</systemitem> manually.
     Note that cross-platform clusters are not supported.
    </para>
   </listitem>
   <listitem>
    <para>
     Because of the Kernel update shipped with SP2, reboot the node between
     <xref linkend="step-ha-migration-upgrade-tolatest"
      xrefstyle="select:name"/>
     and <xref linkend="step-ha-migration-upgrade-ais"/>.
    </para>
   </listitem>
  </itemizedlist>

  <important>
   <title>Time Limit for Rolling Upgrade</title>
   <para>
    The new features shipped with &productname; 11&nbsp;SP2 will only be
    available after <emphasis>all</emphasis> cluster nodes have been
    upgraded to the latest product version. Mixed SP1/SP2 clusters are only
    supported for a short time frame during the rolling upgrade. Complete
    the rolling upgrade within one week.
   </para>
  </important>
 </sect2>
 <sect2 id="sec-ha-migration-sle11-sp3">
  <title>Upgrading from SLE&nbsp;HA&nbsp;11&nbsp;SP2 to SLE&nbsp;HA&nbsp;11&nbsp;SP3</title>

  <para>
   Migrating an existing cluster from &productname; 11&nbsp;SP2 to
   11&nbsp;SP3 is done via a <literal>rolling upgrade</literal>, similar to
   the upgrade procedure from version 11 to 11&nbsp;SP1.
  </para>

  <para>
   Proceed as described in
   <xref
    linkend="pro-ha-migration-rolling-upgrade"/> with the following
   deviation: In
   <xref linkend="step-ha-migration-upgrade-tolatest" xrefstyle="select:name"
   />,
   upgrade from &sls; 11&nbsp; SP2 to &sls; 11&nbsp;SP3 and from
   &productname; 11&nbsp;SP2 to &productname; 11&nbsp;SP3.
  </para>

  <important>
   <title>Time Limit for Rolling Upgrade</title>
   <para>
    The new features shipped with &productname; 11&nbsp;SP3 will only be
    available after <emphasis>all</emphasis> cluster nodes have been
    upgraded to the latest product version. Mixed SP2/SP3 clusters are only
    supported for a short time frame during the rolling upgrade. Complete
    the rolling upgrade within one week.
   </para>
  </important>
 </sect2>
  
  <sect2 id="sec-ha-migration-sle11-sp4">
   <title>Upgrading from SLE&nbsp;HA&nbsp;11&nbsp;SP3 to
    SLE&nbsp;HA&nbsp;11&nbsp;SP4</title>
   
   <para>
    Migrating an existing cluster from &productname; 11&nbsp;SP3 to
    11&nbsp;SP4 is done via a <literal>rolling upgrade</literal>, similar to
    the upgrade procedure from version 11 to 11&nbsp;SP1.
   </para>
   
   <para>
    Proceed as described in
    <xref
     linkend="pro-ha-migration-rolling-upgrade"/> with the following
    deviation: In
    <xref linkend="step-ha-migration-upgrade-tolatest" xrefstyle="select:name"
    />,
    upgrade from &sls; 11&nbsp; SP3 to &sls; 11&nbsp;SP4 and from
    &productname; 11&nbsp;SP3 to &productname; 11&nbsp;SP4.
   </para>
   
   <note id="note-ha-cib-upgrade">
    <title>Upgrading the CIB Syntax Version</title>
    <para>Tags (for grouping resources) and some ACL features only work with the
     CIB syntax version <literal>pacemaker-2.0</literal> or higher. (To check
     your version, run <command>cibadmin -Q |grep validate-with</command>). If
     you have upgraded from &productname; 11 SP3, your CIB version will
      <emphasis>not</emphasis> be upgraded by default. To manually upgrade to
     the latest CIB version use one of the following commands:</para>
    <screen>&prompt.root;cibadmin --upgrade --force</screen>
    <para>or</para>
    <screen>&prompt.root;crm configure upgrade force</screen>
   </note>
   
   <important>
    <title>Time Limit for Rolling Upgrade</title>
    <para>
     The new features shipped with &productname; 11&nbsp;SP4 will only be
     available after <emphasis>all</emphasis> cluster nodes have been
     upgraded to the latest product version. Mixed SP3/SP4 clusters are only
     supported for a short time frame during the rolling upgrade. Complete
     the rolling upgrade within one week.
    </para>
   </important>
  </sect2>
  
 </sect1>
 <sect1 id="sec-ha-update">
  <title>Updating Software Packages on Cluster Nodes</title>
  
  <warning>
   <title>Active Cluster Stack During Update</title>
   <para> To update any software packages on a node that is part of a running
    cluster, <emphasis>stop</emphasis> the cluster stack <emphasis>on that node</emphasis> before starting the software
    update. In some cases (see <xref linkend="il-ha-update-cond"/>, you can
    alternatively put the cluster into maintenance mode (which is available since
    &productname; 11 SP4). </para>
   <para>
    If the cluster resource manager on a node is active during the software
    update, this can lead to unpredictable results like fencing of active
    nodes.
   </para>
  </warning>
  
  <para>
   Before installing any package updates on a node, check the following:
  </para>
  
  <itemizedlist id="il-ha-update-cond">
   <title>Conditions for Stopping the Cluster Stack</title>
   <listitem>
    <para>
     Does the update affect any packages belonging to &productname; or the
     &hageo; add-on? If yes: Stop the cluster stack on the node before
     starting the software update.
    </para>
    <screen>&prompt.root;rcopenais&nbsp;stop</screen>
   </listitem>
   <listitem>
    <para>
     Does the package update require a reboot? If yes: Stop the cluster
     stack on the node before starting the software update:
    </para>
    <screen>&prompt.root;rcopenais&nbsp;stop</screen>
   </listitem>
  </itemizedlist>
  
  <para>
   If none of the situations above apply, you do not need to stop the
   cluster stack. In that case, put the cluster into maintenance mode before
   starting the software update:
  </para>
  
  <screen>&prompt.root;<command>crm</command> configure property maintenance-mode=true</screen>
  
  <para>
   For more details on maintenance mode, see
   <xref
    linkend="sec-ha-config-basics-maint-mode"/>.
  </para>
  
  
  <para>
   After the update has been successfully installed, remove the cluster
   maintenance mode:
  </para>
  
  <screen>&prompt.root;<command>crm</command> configure property maintenance-mode=false</screen>
  
  <para>
   or restart the cluster stack on the respective node with:
  </para>
  
  <screen>&prompt.root;rcopenais&nbsp;start</screen>
 </sect1>
 
 <sect1 id="sec-ha-migration-more">
  <title>For More Information</title>

  <para>
   For detailed information about any changes and new features of the
   product you are upgrading to, refer to its release notes. They are
   available from <ulink url="https://www.suse.com/releasenotes/"/>.
  </para>
 </sect1>
</appendix>
