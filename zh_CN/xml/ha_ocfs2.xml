<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE chapter>
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="ha_ocfs2.xml" xml:id="cha-ha-ocfs2"><title>OCFS2</title><info><abstract>
  <para>
   Oracle Cluster File System 2 (OCFS2) 是一个自 Linux 2.6 内核以来完全集成的通用日记文件系统。OCFS2 可将应用程序二进制文件、数据文件和数据库储存到共享储存设备。群集中的所有节点对文件系统都有并行的读和写权限。用户空间控制守护程序（由克隆资源管理）提供与 HA 堆栈的集成，尤其是与 OpenAIS/Corosync 和分布式锁管理器 (DLM) 的集成。
  </para>
 </abstract></info>
 <indexterm class="startofrange" xml:id="idx-filesystems-ocfs2"> <primary>文件系统</primary> <secondary>OCFS2</secondary> </indexterm>
 
 <section xml:id="sec-ha-ocfs2-features">
  <title>功能和优点</title>

  <para>
   OCFS2 可用于以下储存解决方案，例如：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     一般应用程序和工作负荷.
    </para>
   </listitem>
   <listitem>
    <para>
     群集中的 Xen 映像存储。Xen 虚拟机和虚拟服务器可存储于由群集服务器安装的 OCFS2 卷中。它提供了 Xen 虚拟机在各服务器之间的快速便捷的可移植性。
    </para>
   </listitem>
   <listitem>
    <para>
     LAMP (Linux、Apache、MySQL 和 PHP | Perl | Python) 堆栈。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   作为高性能、非对称的并行群集文件系统，OCFS2 支持以下功能：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     应用程序文件对群集中的所有节点均可用。用户只需在群集中的 OCFS2 上安装它一次。
    </para>
   </listitem>
   <listitem>
    <para>
     所有节点都可以通过标准文件系统接口直接并行读写至储存区，从而方便地管理运行于群集上的应用程序。
    </para>
   </listitem>
   <listitem>
    <para>
     文件访问通过 DLM 协调。DLM 控制在多数情况下都运行良好，但如果应用程序的设计与 DLM 争夺对文件访问的协调，则此设计可能会限制可伸缩性。
    </para>
   </listitem>
   <listitem>
    <para>
     所有后端储存上都可以使用储存备份功能。可以方便地创建共享应用程序文件的图形，它能够帮助提供有效的故障恢复。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   OCFS2 还提供以下功能：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     元数据缓存。
    </para>
   </listitem>
   <listitem>
    <para>
     元数据日记。
    </para>
   </listitem>
   <listitem>
    <para>
     跨节点的文件数据一致性。
    </para>
   </listitem>


   <listitem>
    <para>
     支持多达 4 KB 的多个块大小、多达 1 MB 的群集大小，最大卷大小为 4 PB (Petabyte)。
    </para>
   </listitem>
   <listitem>
    <para>
     支持最多 32 个群集节点。
    </para>
   </listitem>


   <listitem>
    <para>
     对于数据库文件的异步和直接 I/O 支持，提高了数据库性能。
    </para>
   </listitem>
  </itemizedlist>
 </section>
 <section xml:id="sec-ha-ocfs2-utils">
  <title>OCFS2 包和管理实用程序</title>

  <para>
   OCFS2 内核模块（<literal>ocfs2</literal>）自动安装到 SUSE® Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">11 SP4</phrase></phrase> 中的 High Availability Extension 上。要使用 OCFS2，请确保在群集中的每个节点上安装以下包：<systemitem class="resource">ocfs2-tools</systemitem> 和与内核匹配的 <systemitem class="resource">ocfs2-kmp-*</systemitem> 包。
  </para>

  <para>
   <systemitem class="resource">ocfs2-tools</systemitem> 包提供以下实用程序，用于管理 OFS2 卷。有关语法信息，请参见其手册页。
  </para>

  <table>
   <title>OCFS2 实用程序</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 实用程序
       </para>
      </entry>
      <entry>
       <para>
        描述
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        debugfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        为了调试检查 OCFS 文件系统的状态
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        fsck.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        检查文件系统的错误并进行选择性的修改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mkfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        在某个设备上创建 OCFS2 文件系统，通常是共享物理或逻辑磁盘上的某个分区。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mounted.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        检测并列出群集系统上所有的 OCFS2 卷。检测并列出已经安装了 OCFS2 设备的系统上的所有节点或列出所有的 OCFS2 设备。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        tunefs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        更改 OCFS2 文件系统参数，包括卷标、节点槽号、所有节点槽的日志大小和卷大小。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </section>
 <section xml:id="sec-ha-ocfs2-create-service">
  <title>配置 OCFS2 服务和 STONITH 资源</title>



  <para>
   您在可以创建 OCFS2 卷之前，必须在群集中配置以下资源作为服务：DLM、O2CB 和 STONITH 资源。OCFS2 使用运行于用户空间中的 Pacemaker 提供的群集成员资格服务。因此，DLM 和 O2CB 需要配置为存在于群集中每个节点上的克隆资源。
  </para>

  <para>
   以下过程使用 <command>crm</command> 外壳配置群集资源。或者，您还可以使用 Pacemaker GUI 配置该资源。
  </para>

  <note>
   <title>cLVM 和 OCFS2 的 DLM 资源</title>
   <para>
    cLVM 和 OCFS2 需要一个在群集中的所有节点上运行的 DLM 资源，因此通常被配置为克隆资源。如果您的设置中既包含 OCFS2 也包含 cLVM，则为 OCFS2 和 cLVM 配置<emphasis>一个</emphasis> DLM 资源就足够了。
   </para>
  </note>

  <procedure xml:id="pro-ocfs2-resources">
   <title>配置 DLM 和 O2CB 资源</title>
   <para>
    这种配置由包含多个原始资源的基本组和一个基本克隆构成。基本组和基本克隆随后可以用于各种方案（例如，用于 OCFS2 和 cLVM）。您只需根据需要用相应的原始资源扩展基本组。由于基本组具有内部共置和排序功能，您不必指定许多单个组、克隆及其依赖性，方便了总体设置。
   </para>
   <para>
    对群集中的一个节点执行以下步骤：
   </para>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option>configure</option>。
    </para>
   </step>
   <step>
    <para>
     输入以下命令创建 DLM 和 O2CB 的原始资源：
    </para>

<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> dlm ocf:pacemaker:controld \
      op monitor interval="60" timeout="60"
<command>primitive</command> o2cb ocf:ocfs2:o2cb \
      op monitor interval="60" timeout="60"
</screen>
    <para>
     <literal>dlm</literal> 克隆资源会控制分布式锁管理器服务，并确保此服务在群集中的所有节点上都启动。由于基本组具有内部共置和排序功能，<literal>o2cb</literal> 服务仅在已有一个 <literal>dlm</literal> 服务副本在运行的节点上启动。
    </para>
   </step>
   <step>
    <para>
     输入以下命令以创建基本组和基本克隆：

    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>group</command> base-group dlm o2cb 
<command>clone</command> base-clone base-group \
      meta interleave="true"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 复查更改。
    </para>
   </step>
   <step>
    <para>
     如果全部都正确，请使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
   </step>
  </procedure>

  <procedure xml:id="pro-ocfs2-stonith">
   <title>配置 STONITH 资源</title>
   <note>
    <title>所需的 STONITH 设备</title>
    <para>
     您需要配置屏蔽设备。没有一个适当的 STONITH 机制（如 <literal>external/sbd</literal>），则配置会失败。
    </para>
   </note>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     如<xref linkend="pro-ha-storage-protect-sbd-create"/>中所述，创建 SBD 分区。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option>configure</option>。
    </para>
   </step>
   <step>
    <para>
     在将 <literal>/dev/sdb2</literal> 作为共享储存区上用于检测信号和屏蔽的专用分区的同时，将 <literal>external/sdb</literal> 配置为屏蔽设备：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> sbd_stonith stonith:external/sbd \
      params pcmk_delay_max="15" \
      op monitor interval="15" timeout="15"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 复查更改。
    </para>
   </step>
   <step>
    <para>
     如果全部内容都正确，请使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
   </step>
  </procedure>
 </section>
 <section xml:id="sec-ha-ocfs2-create">
  <title>创建 OCFS2 卷</title>

  <para>
   按<xref linkend="sec-ha-ocfs2-create-service"/>中所述将 DLM 和 O2CB 配置为群集资源后，配置系统以使用 OCFS2 并创建 OCFs2 卷。
  </para>

  <note>
   <title>适用于应用程序和数据文件的 OCFS2 卷</title>
   <para>
    我们建议您通常将应用程序文件和数据文件储存在不同的 OCFS2 卷上。如果应用程序卷和数据卷具有不同的装入要求，则必须将它们储存在不同的卷上。
   </para>
  </note>

  <para>
   开始之前要准备计划用于 OCFS2 卷的块设备。将这些设备留作可用空间。
  </para>

  <para>
   然后，按<xref linkend="pro-ocfs2-volume"/>中所述使用 <command>mkfs.ocfs2</command> 创建和格式化 OCFS2 卷。此命令最重要的参数列于<xref linkend="tab-ha-ofcs2-mkfs-ocfs2-params"/>中。有关此命令的更多信息和命令语法，请参见 <command>mkfs.ocfs2</command> 手册页。
  </para>

  <table xml:id="tab-ha-ofcs2-mkfs-ocfs2-params">
   <title>重要的 OCFS2 参数</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 参数
       </para>
      </entry>
      <entry>
       <para>
        描述和建议
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        卷标 (<option>-L</option>)
       </para>
      </entry>
      <entry>
       <para>
        卷的描述性名称能够在不同节点上安装卷时唯一标识它。使用 <command>tunefs.ocfs2</command> 实用程序根据需要修改该卷标。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        群集大小 (<option>-C</option>)
       </para>
      </entry>
      <entry>
       <para>
        群集大小是分配给文件以保存数据的最小空间单元。有关可用选项和推荐的信息，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        节点槽数 (<option>-N</option>)
       </para>
      </entry>
      <entry>
       <para>
        可以同时安装卷的最大节点数。OCFS2 会为每个节点创建单独的系统文件（如日记）。访问卷的节点可以是小尾端结构（如 x86 x86-64 和 ia64）和大尾端结构（如 ppc64 和 s390x)的组合。
       </para>
       <para>
        特定于节点的文件作为本地文件。节点槽号附加到该本地文件。例如：<literal>journal:0000</literal> 属于指派到槽号 <literal>0</literal> 的所有节点。
       </para>
       <para>
        根据预期有多少个节点并行装入卷，在创建卷时设置每个卷的最大节点槽数。使用 <command>tunefs.ocfs2</command> 实用程序根据需要增加节点槽数。请注意，此值不能减小。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        块大小 (<option>-b</option>)
       </para>
      </entry>
      <entry>
       <para>
        文件系统可寻址的最小空间单元创建卷时请指定块大小。有关可用选项和推荐的信息，请参见 <command>mkfs.ocfs2</command> 手册页。

       </para>
      </entry>
     </row>

     <row>
      <entry>
       <para>
        打开/关闭特定功能 (<option>--fs-features</option>)
       </para>
      </entry>
      <entry>
       <para>
        可以提供功能标志的逗号分隔列表，<systemitem>mkfs.ocfs2</systemitem> 会尝试根据此列表创建具有那些功能的文件系统。要打开某功能，请将其加入列表。要关闭某功能，请在其名称前加 <literal>no</literal>。
       </para>
       <para>
        有关所有可用标志的概述，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        预定义功能 (<option>--fs-feature-level</option>)
       </para>
      </entry>
      <entry>
       <para>
        允许您从一组预定义文件系统功能中进行选择。有关可用选项的信息，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>



  <para>
   如果使用 <command>mkfs.ocfs2</command> 创建和格式化卷时未指定任何特定功能，则默认情况下将启用以下功能：<option>backup-super</option>、<option>sparse</option>、<option>inline-data</option>、<option>unwritten</option>、<option>metaecc</option>、<option>indexed-dirs</option> 和 <option>xattr</option>。
  </para>



  <procedure xml:id="pro-ocfs2-volume">
   <title>创建并格式化 OCFS2 卷</title>
   <para>
    只在群集节点之<emphasis>一</emphasis>上执行以下步骤。
   </para>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份打开终端窗口并登录。
    </para>
   </step>
   <step>
    <para>
     使用命令 <command>crm status</command> 检查群集是否联机。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mkfs.ocfs2</command> 实用程序创建并格式化卷。有关此命令语法的信息，请参见 <command>mkfs.ocfs2</command> 手册页。
    </para>
    <para>
     例如，要在 <filename>/dev/sdb1</filename> 上创建最多支持  32 个群集节点的新 OCFS2 文件系统，请输入以下命令：
    </para>
<screen><prompt role="root">root # </prompt> mkfs.ocfs2 -N 32 /dev/sdb1</screen>

   </step>
  </procedure>
 </section>
 <section xml:id="sec-ha-ocfs2-mount">
  <title>装入 OCFS2 卷</title>

  <para>
   可以手动装入 OCFS2 卷，也可以按<xref linkend="pro-ocfs2-mount-cluster"/>中所述使用群集管理器将其装入。
  </para>

  <procedure xml:id="pro-ocfs2-mount-manual">
   <title>手动装入 OCFS2 卷</title>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份打开终端窗口并登录。
    </para>
   </step>
   <step>
    <para>
     使用命令 <command>crm status</command> 检查群集是否联机。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mount</command> 命令从命令行装入卷。
    </para>
   </step>
  </procedure>

  <warning>
   <title>手动装入的 OCFS2 设备</title>
   <para>
    如果因方便测试而手动安装了 OCFS2 文件系统，则请务必在通过 OpenAIS 启动使用该文件系统之前再次将其卸载。
   </para>
  </warning>

  <procedure xml:id="pro-ocfs2-mount-cluster">
   <title>使用群集管理器装入 OCFS2 卷</title>
   <para>
    要为 High Availability 软件安装 OCFS2 卷，请在群集中配置 ocf 文件系统资源。以下过程使用 <command>crm</command> 外壳配置群集资源。或者，您还可以使用 Pacemaker GUI 配置该资源。
   </para>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option>configure</option>。
    </para>
   </step>
   <step>
    <para>
     配置 Pacemaker 以在群集中的每个节点上装入 OCFS2 文件系统：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ocfs2-1 ocf:heartbeat:Filesystem \
      params device="/dev/sdb1" directory="/mnt/shared" fstype="ocfs2" options="acl" \
      op monitor interval="20" timeout="40"</screen>
   </step>
   <step>
    <para>
     将文件系统原始资源添加到您在<xref linkend="pro-ocfs2-resources"/>中配置的基本组：
    </para>
    <substeps performance="required">
     <step>
      <para>
       输入
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>edit base-group</screen>
     </step>

     <step>
      <para>
       在打开的 vi 编辑器中，如下所示修改组并保存更改：
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>group base-group dlm o2cb ocfs2-1</screen>
      <para>
       由于基本组具有内部共置和排序功能，Pacemaker 将仅在也有 o2cb 资源已在运行的节点上启动 <systemitem class="resource">ocfs2-1</systemitem> 资源。
      </para>
     </step>
    </substeps>
   </step>

   <step>
    <para>
     使用 <command>show</command> 复查更改。要检查是否配置了所有需要的资源，另请参考<xref linkend="cha-ha-config-example"/>。
    </para>
   </step>
   <step>
    <para>
     如果全部都正确，则使用 <command>commit</command> 提交更改，并使用 <command>exit</command> 退出 crm 当前配置。
    </para>
   </step>
  </procedure>
 </section>
 <section xml:id="sec-ha-ocfs2-quota">
  <title>在 OCFS2 文件系统上使用定额</title>



  <para>
   要在 OCFS2 文件系统上使用定额，请分别使用相应的定额功能或装入选项创建和装入文件系统：<literal>ursquota</literal>（用于单独用户的定额）或 <literal>grpquota</literal>（用于组的定额）。这些功能也可以稍后使用 <command>tunefs.ocfs2</command> 在未装入的文件系统上启用。
  </para>

  <para>
   文件系统启用了相应的定额功能后，它会跟踪其元数据，查看每个用户（或组）使用的空间和文件数。由于 OCFS2 将定额信息视为文件系统内部元数据，因此您无需运行 <command>quotacheck</command>(8) 程序。所有功能都内置到 fsck.ocfs2 和文件系统驱动程序中。
  </para>

  <para>
   要实施强加于每个用户或组的限制，请如同在任何其他文件系统上一样运行 <command>quotaon</command>(8)。
  </para>





  <para>
   由于性能原因，每个群集节点都会在本地执行定额会计，并每 10 秒将此信息与通用中央储存同步一次。此间隔可使用 <command>tunefs.ocfs2</command> 及 <option>usrquota-sync-interval</option> 和 <option>grpquota-sync-interval</option> 选项调整。因此，定额信息可能不会始终都准确，因而在几个群集节点上并行操作时，用户或组可以稍微超出其定额限制。
  </para>
 </section>
 <section xml:id="sec-ha-ocfs2-more">
  <title>更多信息</title>

  <para>
   有关 OCFS2 的更多信息，请参见以下链接：
  </para>

  <variablelist>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/"/>
    </term>
    <listitem>
     <para>
      Oracle 上的 OCFS2 项目主页。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/documentation"/>
    </term>
    <listitem>
     <para>
      项目文档主页上的 <citetitle>OCFS2 User's Guide</citetitle>（《OCFS2 用户指南》） 
     </para>
    </listitem>
   </varlistentry>
  </variablelist><indexterm class="endofrange" startref="idx-filesystems-ocfs2"/>
 </section>
</chapter>
