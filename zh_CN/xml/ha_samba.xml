<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="ha_samba.xml" id="cha.ha.samba">
 <title>Samba 群集</title>
 <abstract>
  <para>
   群集 Samba 服务器提供异构网络的高可用性解决方案。本章说明了一些背景信息以及如何设置群集 Samba 服务器。
  </para>
 </abstract>
 <sect1 id="sec.ha.samba.overview">
  <title>概念概述</title>

  <para>
   Samba 使用 Trivial Database (TDB) 已经许多年了。它允许多个应用程序同时写入。为确保所有写操作都成功执行而不会彼此冲突，TDB 使用内部锁定机制。
  </para>

  <para>
   Cluster Trivial Database (CTDB) 是现有的 TDB 的小扩展。项目对 CTDB 的描述是：<quote>Samba 和其他项目用于储存临时数据的 TDB 数据库的群集实现</quote>。
  </para>

  <para>
   每个群集节点都运行本地 CTDB 守护程序。Samba 与其本地 CTDB 守护程序通讯，而非直接写入其 TDB。守护程序通过网络交换元数据，但实际的读写操作是在快速储存的本地副本上进行的。CTDB 的概念如<xref linkend="fig.ha.samba.overview"/>中所示。
  </para>

  <note>
   <title>CTDB 仅用于 Samba</title>
   <para>
    CTDB 资源代理的当前实现将 CTDB 配置为只管理 Samba。任何其他功能，包括 IP 故障转移，都应使用 Pacemaker 进行配置。
   </para>
   <para>
    CTDB 仅支持完全同类的群集。例如，群集中的所有节点都必须有相同的体系结构，不能混合 i586 与 x86_64。
   </para>
  </note>

  <figure id="fig.ha.samba.overview">
   <title>CTDB 群集的结构</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ha_samba.svg" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ha_samba.png" width="80%"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para>
   群集 Samba 服务器必须共享某些数据：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     将 Unix 用户和组 ID 与 Windows 用户和组关联的映射表。
    </para>
   </listitem>
   <listitem>
    <para>
     用户数据库必须在所有节点间同步。
    </para>
   </listitem>
   <listitem>
    <para>
     Windows 域中的成员服务器的连接信息必须在所有节点上都可用。
    </para>
   </listitem>
   <listitem>
    <para>
     元数据（如活动 SMB 会话、共享连接和各种锁）必须在所有节点上都可用。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   目标是：具有 N+1 个节点的群集 Samba 服务器比只有 N 个节点的快。一个节点不会比非群集 Samba 服务器慢。
  </para>
 </sect1>
 <sect1 id="sec.ha.samba.basicconf">
  <title>基本配置</title>
  
  <note>
   <title>已更改的配置文件</title>
   <para>
    CTDB 资源代理会自动更改 <filename>/etc/sysconfig/ctdb</filename> 和 <filename>/etc/samba/smb.conf</filename>。使用 <command>crm ra</command> <option>info CTDB</option> 列出可为 CTDB 资源指定的所有参数。
   </para>
  </note>

  <para>
   要设置群集 Samba 服务器，请按如下操作：
  </para>

  <procedure id="pro.ha.samba.basicconf">
   <title>设置基本的群集 Samba 服务器</title>
   <step performance="required">
    <para>
     准备群集：
    </para>
    <substeps performance="required">
     <step performance="required">
      <para>
       按照本指南的<xref linkend="part.config"/>中所述配置群集（OpenAIS、Pacemaker、OCFS2）。
      </para>
     </step>
     <step performance="required">
      <para>
       配置共享文件系统（如 OCFS2），并将其装入例如 <filename>/shared</filename> 的位置。
      </para>
     </step>
     <step performance="required">
      <para>
       要打开 POSIX ACL，请启用它：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <para>
         对新的 OCFS2 文件系统，使用：
        </para>
<screen><prompt role="root">root # </prompt><command>mkfs.ocfs2</command> --fs-features=xattr ...</screen>
       </listitem>
       <listitem>
        <para>
         对现有 OCFS2 文件系统，使用：
        </para>
        <screen><prompt role="root">root # </prompt><command>tunefs.ocfs2</command> --fs-feature=xattr<replaceable>DEVICE</replaceable></screen>
        <para>
         确保在文件系统资源中指定了 <option>acl</option> 选项。按如下方式使用 <command>crm</command> 外壳：
        </para>
<screen><prompt role="custom">crm(live)configure# </prompt> <command>primary</command> ocfs2-3 ocf:heartbeat:Filesystem options="acl" ...</screen>
       </listitem>
      </itemizedlist>
     </step>
     <step performance="required">
      <para>
       确保服务 <systemitem class="service">ctdb</systemitem>、<systemitem class="service">smb</systemitem>、<systemitem class="service">nmb</systemitem> 和 <systemitem class="service">winbind</systemitem> 已禁用：
      </para>
 <screen><prompt role="root">root # </prompt><command>chkconfig</command> ctdb off
<command>chkconfig</command> smb off
<command>chkconfig</command> nmb off
<command>chkconfig</command> winbind off</screen>
     </step>
    </substeps>
   </step>
   <step performance="required">
    <para>
     在共享文件系统上为 CTDB 锁定创建一个目录：
    </para>
    <screen><prompt role="root">root # </prompt><command>mkdir</command> -p /shared/samba/</screen>
   </step>
   <step performance="required">
    <para>
     在 <filename>/etc/ctdb/nodes</filename> 中插入包含群集中每个节点的所有私用 IP 地址的所有节点：
    </para>
<screen>192.168.1.10
192.168.1.11</screen>
   </step>
   <step performance="required">
    <para>
     使用 <command>csync2</command> 将配置文件复制到您的所有节点：
    </para>
    <screen><prompt role="root">root # </prompt>csync2 <option>-xv</option></screen>
    <para>
     有关详细信息，请参见 <xref linkend="pro.ha.installation.setup.csync2.start"/>。
    </para>
   </step>


   <step performance="required">
    <para>
     将 CTDB 资源添加到群集：
    </para>

<screen><command>crm</command> configure
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ctdb ocf:heartbeat:CTDB params \
    ctdb_manages_winbind="false" \ 
    ctdb_manages_samba="true" \
    ctdb_recovery_lock="/shared/samba/ctdb.lock" \
      op monitor interval="10" timeout="20" \
      op start interval="0" timeout="90" \
      op stop interval="0" timeout="100"
<prompt role="custom">crm(live)configure# </prompt><command>clone</command> ctdb-clone ctdb \
    meta globally-unique="false" interleave="true"
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> ctdb-with-fs inf: ctdb-clone fs-clone
<prompt role="custom">crm(live)configure# </prompt><command>order</command> start-ctdb-after-fs inf: fs-clone ctdb-clone
<prompt role="custom">crm(live)configure# </prompt><command>commit</command></screen>
   </step>
   <step performance="required">
    <para>
     添加群集 IP 地址：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip ocf:heartbeat:IPaddr2 params ip=192.168.2.222 \
  clusterip_hash="sourceip-sourceport" op monitor interval=60s
<prompt role="custom">crm(live)configure# </prompt><command>clone</command> ip-clone ip meta globally-unique="true"
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> ip-with-ctdb inf: ip-clone ctdb-clone
<prompt role="custom">crm(live)configure# </prompt><command>order</command> start-ip-after-ctdb inf: ctdb-clone ip-clone
<prompt role="custom">crm(live)configure# </prompt><command>commit</command></screen>
   </step>
   <step performance="required">
    <para>
     检查结果：
    </para>
<screen><prompt role="root">root # </prompt><command>crm</command> status
Clone Set: dlm-clone
     Started: [ hex-14 hex-13 ]
 Clone Set: o2cb-clone
     Started: [ hex-14 hex-13 ]
 Clone Set: c-ocfs2-3
     Started: [ hex-14 hex-13 ]
 Clone Set: ctdb-clone
     Started: [ hex-14 hex-13 ]
 Clone Set: ip-clone (unique)
     ip:0       (ocf::heartbeat:IPaddr2):       Started hex-13
     ip:1       (ocf::heartbeat:IPaddr2):       Started hex-14</screen>
   </step>
   <step performance="required">
    <para>从客户端计算机进行测试。在 Linux 客户端上，添加一个用于访问 Samba 的用户：
    </para>
    <screen><prompt role="root">root # </prompt><command>smbpasswd</command> <option>-a</option> <replaceable>USERNAME</replaceable></screen>
   </step>
   <step performance="required"><para>测试您是否可以连接到该新用户的主目录：</para>
    <screen><prompt role="root">root # </prompt>smbclient -u <replaceable>USERNAME</replaceable>//192.168.2.222/<replaceable>USERNAME</replaceable></screen>
   </step>


  </procedure>
 </sect1>
 <sect1 id="sec.ha.samba.ad">
  <title>加入 Active Directory 域</title>

  

  <para>
   Active Directory (AD) 是 Windows Server 系统的一项目录服务。
  </para>

  <para>
   下列说明概述了如何将 CTDB 群集加入到 Active Directory 域：
  </para>

  <procedure>
   <step performance="required">
    <para>
     有关如何设置 Active Directory 域的说明，请参考 Windows Server 文档。在此示例中，使用以下参数：
    </para>
    <informaltable>
     <tgroup cols="2">
      <tbody>
       <row>
        <entry>
         <para>
          AD 和 DNS 服务器
         </para>
        </entry>
        <entry>
<screen>win2k3.2k3test.example.com</screen>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          AD 域
         </para>
        </entry>
        <entry>
<screen>2k3test.example.com</screen>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          群集 AD 成员 NETBIOS 名称
         </para>
        </entry>
        <entry>
<screen>CTDB-SERVER</screen>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>

   </step>
   <step performance="required">
    <para>
     <xref linkend="pro.ha.samba.config.ctdb"/>
    </para>
   </step>
   <step performance="required">
    <para>
     <xref linkend="pro.ha.samba.config.join-ad"/>
    </para>
   </step>
  </procedure>

  <para>
   下一步是配置 CTDB：
  </para>

  <procedure id="pro.ha.samba.config.ctdb">
   <title>配置 CTDB</title>
   <step performance="required">
    <para>
     确保您已按<xref linkend="sec.ha.samba.basicconf"/>中所示配置群集。
    </para>
   </step>
   <step performance="required">
    <para>
     停止一个节点上的 CTDB 资源：
    </para>
<screen><prompt role="root">root # </prompt> crm resource stop ctdb-clone</screen>
   </step>
   <step performance="required">
    <para>
     打开 <filename>/etc/samba/smb.conf</filename> 配置文件、添加 NetBIOS 名称，然后关闭该文件：
    </para>
<screen>[global
    netbios name = CTDB-SERVER</screen>
    <para>
     安全性、工作组等其他设置通过 YaST 向导添加。
    </para>
   </step>
   <step performance="required">
    <para>
     更新所有节点上的 <filename>/etc/samba.conf</filename> 文件：
    </para>
<screen><prompt role="root">root # </prompt>csync2 -xv</screen>
   </step>
   <step performance="required">
    <para>
     重启动 CTDB 资源：
    </para>
<screen><prompt role="root">root # </prompt>crm resource start ctdb-clone</screen>
   </step>
  </procedure>

  <para>
   最后，将群集加入 Active Directory 服务器：
  </para>

  <procedure id="pro.ha.samba.config.join-ad">
   <title>加入 Active Directory</title>
   <step performance="required">
    <para>
     请确保 Csync2 的配置中包含下列文件，才可在所有群集主机上进行安装：
    </para>
<screen>/etc/samba/smb.conf
/etc/security/pam_winbind.conf
/etc/krb5.conf
/etc/nsswitch.conf
/etc/security/pam_mount.conf.xml
/etc/pam.d/common-session</screen>
    <para>
     您也可以为此任务使用 YaST 的<guimenu>配置 Csync2</guimenu> 模块，请参见<xref linkend="sec.ha.installation.setup.csync2"/>。
    </para>
   </step>
   <step performance="required">
    <para>
     按照<xref linkend="pro.ha.samba.basicconf"/>中所述创建 CTDB 资源。
    </para>
   </step>
   <step performance="required">
    <para>
     运行 YaST 并从<guimenu>网络服务</guimenu>项中打开 <guimenu>Windows 域成员资格</guimenu>模块。
    </para>
   </step>
   <step performance="required">
    <para>
     输入域或工作组设置然后单击<guimenu>确定</guimenu>完成设置。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec.ha.samba.testing">
  <title>调试和测试群集 Samba</title>

  <para>
   要调试群集 Samba 服务器，可使用以下作用于不同级别的工具：
  </para>

  <variablelist>
   <varlistentry>
    <term><command>ctdb_diagnostics</command>
    </term>
    <listitem>
     <para>
      运行此工具可诊断群集 Samba 服务器。详细的调试消息应有助于您跟踪任何可能存在的问题。
     </para>
     <para>
      <command>ctdb_diagnostics</command> 命令可搜索以下文件，这些文件必须在所有节点上都可用：
     </para>
<screen>/etc/krb5.conf
/etc/hosts
/etc/ctdb/nodes
/etc/sysconfig/ctdb
/etc/resolv.conf
/etc/nsswitch.conf
/etc/sysctl.conf
/etc/samba/smb.conf
/etc/fstab
/etc/multipath.conf
/etc/pam.d/system-auth
/etc/sysconfig/nfs
/etc/exports
/etc/vsftpd/vsftpd.conf</screen>
     <para>
      如果文件 <filename>/etc/ctdb/public_addresses</filename> 和 <filename>/etc/ctdb/static-routes</filename> 存在，它们也会被检查。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>ping_pong</command>
    </term>
    <listitem>
     <para>
      检查文件系统是否支持 CTDB 使用 <command>ping_pong</command>。它会对群集文件系统执行一致性和性能之类的特定测试（请参见 <ulink url="http://wiki.samba.org/index.php/Ping_pong"/>），从而给出群集在高负载下将会表现如何的一些指示。
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><command>send_arp</command> 工具和 <systemitem class="resource">SendArp</systemitem> 资源代理</term>
    <listitem>
     <para>
      <systemitem class="resource">SendArp</systemitem> 资源代理位于 <filename>/usr/lib/heartbeat/send_arp</filename>（或 <filename>/usr/lib64/heartbeat/send_arp</filename>）。<command>send_arp</command> 工具发出免费的 ARP（Address Resolution Protocol，地址解析协议）包，可用于更新其他计算机的 ARP 表。它可以帮助确定故障转移过程之后的通讯问题。 如果节点显示 Samba 的群集 IP 地址，但您却无法连接到该节点或 ping 它，请使用 <command>send_arp</command> 命令测试节点是否只需要更新 ARP 表。
     </para>
     <para>
      有关更多信息，请参见 <ulink url="http://wiki.wireshark.org/Gratuitous_ARP"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   要测试群集文件系统的某些方面，请如下继续操作：
  </para>

  <procedure>
   <title>测试群集文件系统的一致性和性能</title>
   <step performance="required">
    <para>
     在一个节点上启动命令 <command>ping_pong</command>，将占位符 <replaceable>N</replaceable> 替换为节点数 + 1。文件 <filename><replaceable>ABSPATH</replaceable>/data.txt</filename> 在共享存储区中提供，因此在所有节点（<replaceable>ABSPATH</replaceable> 表示绝对路径）上都可以访问到：
    </para>
<screen><command>ping_pong</command> <replaceable>ABSPATH</replaceable>/data.txt <replaceable>N</replaceable></screen>
    <para>
     应该会得到很高的锁定率，因为只运行一个节点。如果程序不打印锁定率，请替换群集文件系统。
    </para>
   </step>
   <step performance="required">
    <para>
     使用相同的参数在另一个节点上启动 <command>ping_pong</command> 的第二个副本。
    </para>
    <para>
     应该会看到锁定率急剧下降。如果以下任意情况适用于群集文件系统，请替换它：
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <command>ping_pong</command> 不打印每秒锁定率，
      </para>
     </listitem>
     <listitem>
      <para>
       两个实例中的锁定率并非几乎相等,
      </para>
     </listitem>
     <listitem>
      <para>
       启动第二个实例后锁定率未下降。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step performance="required">
    <para>
     启动 <command>ping_pong</command> 的第三个副本。添加另一个节点，注意锁定率的变化。
    </para>
   </step>
   <step performance="required">
    <para>
     逐个终止 <command>ping_pong</command> 命令。 应该观察到锁定率上升，直到回到单一节点的情况。如果没有看到预期行为，请参见<xref linkend="cha.ha.ocfs2"/> 中的详细信息。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec.ha.samba.moreinfo">
  <title>更多信息</title>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <ulink url="http://linux-ha.org/wiki/CTDB_(resource_agent)"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://wiki.samba.org/index.php/CTDB_Setup"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://ctdb.samba.org"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://wiki.samba.org/index.php/Samba_%26_Clustering"/>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
