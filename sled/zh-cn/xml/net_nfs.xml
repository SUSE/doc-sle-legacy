<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE chapter
[
   <!ENTITY % entities SYSTEM "entity-decl.ent">
   %entities;
]>


<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="net_nfs.xml" xml:id="cha-nfs"><title>通过 NFS 共享文件系统</title><info><abstract>
  <para>
   在企业环境中通过网络分发和共享文件系统是一项常见任务。久经验证的网络文件系统 (<emphasis>NFS</emphasis>) 与黄页协议 <emphasis>NIS</emphasis> 协同工作。要使用可以与 <emphasis>LDAP</emphasis> 协同工作并且也可以使用 Kerberos 的更安全协议，请选中 <emphasis>NFSv4</emphasis>。结合使用 pNFS，您可以突破性能瓶颈。
  </para>

  <para>
   NFS 与 NIS 一起使用时网络面向用户是透明的。利用 NFS，可以通过网络分发任意文件系统。进行适当的设置后，用户将发现自己始终处于同一环境中，而与当前使用的终端无关。
  </para>
 </abstract></info>
 <indexterm><primary>NFS</primary></indexterm><indexterm><primary>网络文件系统</primary><see>NFS</see></indexterm>
 
 
 <section xml:id="sec-nfs-term">
  <title>术语</title>

  <para>
   下面是 YaST 模块中使用的术语。
  </para>



  <variablelist>
   <varlistentry>
    <term>导出</term>
    <listitem>
     <para>
      由 NFS 服务器<emphasis>导出的</emphasis>目录，客户端可将其集成到系统中。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 客户端</term>
    <listitem>
     <para>
      NFS 客户端是通过网络文件系统协议使用来自 NFS 服务器的 NFS 服务的系统。TCP/IP 协议已集成到 Linux 内核中；无需再安装任何其他软件。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS 服务器</term>
    <listitem>
     <para>
      NFS 服务器向客户端提供 NFS 服务。运行中的服务器依赖于以下守护程序：<systemitem class="daemon">nfsd</systemitem>（工作）、<systemitem class="daemon">idmapd</systemitem>（到 ID 的用户和组名映射，反之亦然）、<systemitem class="daemon">statd</systemitem>（文件锁定）和 <systemitem class="daemon">mountd</systemitem>（装入请求）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
     <term>pNFS</term>
     <listitem>
       <para>并行 NFS，属于 NFSv4 的一种协议扩展。任何 pNFS 客户端都可以直接访问 NFS 服务器上的数据。</para>
     </listitem>
   </varlistentry>
  </variablelist>
 </section>
 <section xml:id="sec-nfs-installation">
  <title>安装 NFS 服务器</title>

  <para>
   NFS 服务器软件不会默认安装。如果您按照<xref linkend="sec-nfs-configuring-nfs-server"/>中的说明配置 NFS 服务器，则系统会自动提示您安装所需的包。或者，使用 YaST 或 zypper 安装包 <systemitem class="resource">nfs-kernel-server</systemitem>。
  </para>

  <para>
   与 NIS 一样，NFS 也是一个客户端/服务器系统。但是，一台计算机可充当这两种角色：它可以通过网络提供文件系统（导出），也可以从其他主机装入文件系统（导入）。
  </para>
 </section>
 <section xml:id="sec-nfs-configuring-nfs-server">
  <title>配置 NFS 服务器</title>

  <para>
   可通过 YaST 配置 NFS 服务器，也可以手动配置它。NFS 还可与 Kerberos 结合来进行身份验证。
  </para>

  

  

  <section xml:id="sec-nfs-kerberos">
   <title>采用 Kerberos 的 NFS</title>
   <para>
    要对 NFS 使用 Kerberos 身份验证，必须启用 GSS 安全性。在初始 YaST NFS 服务器对话框中选择<guimenu>启用 GSS 安全</guimenu>。必须具有一个有效的 Kerberos 服务器才能使用此功能。YaST 不会设置服务器，只是使用所提供的功能。如果希望使用 Kerberos 进行身份验证，则除了 YaST 配置外，还必须首先至少完成以下步骤，才能运行 NFS 配置：
   </para>
   <procedure>
    <step>
     <para>
      请确保服务器和客户端都在同一 Kerberos 域中。它们必须访问相同的 KDC（密钥分发中心）服务器并共享其 <filename>krb5.keytab</filename> 文件（在任何计算机上的默认位置是 <filename>/etc/krb5.keytab</filename>）。有关 Kerberos 的更多信息，请参见<xref linkend="cha-net-kerberos"/>。
     </para>
    </step>
    <step>
     <para>
      在客户端上用 <command>rcgssd start</command> 启动 gssd 服务。
     </para>
    </step>
    
   </procedure>
   <para>
    有关配置采用 Kerberos 的 NFS 的更多信息，请参见<xref linkend="sec-nfs-info" xrefstyle="SectTitleOnPage"/> 中的链接。
   </para>
  </section>
 </section>
 <section xml:id="sec-nfs-configuring-nfs-clients">
  <title>配置客户端</title>

  <para>
   要将主机配置为 NFS 客户端，无需安装其他软件。将默认安装所有需要的包。
  </para>

  <section xml:id="sec-nfs-import-yast2">
   <title>使用 Yast 导入文件系统</title><indexterm><primary>NFS</primary><secondary>客户端</secondary></indexterm>
    <para>授权用户可以用 YaST NFS 客户端模块从 NFS 服务器将 NFS 目录装入本地文件树。按如下所示继续：</para>
    
    <procedure xml:id="pro-nfs-import-yast2">
      <title>导入 NFS 目录</title>
      <step>
        <para>启动 YaST NFS 客户端模块。</para>
      </step>
      <step>
        <para>单击 <guimenu>NFS 共享</guimenu>选项卡中的<guimenu>添加</guimenu>。输入 NFS 服务器的主机名、要导入的目录以及用于装入此目录的本地安装点。 </para>
      </step>
      <step>
        <para>若要使用防火墙并允许从远程计算机访问服务，请启用 <guimenu>NFS 设置</guimenu>选项卡中的<guimenu>打开防火墙中的端口</guimenu>。防火墙状态将显示在复选框旁边。</para>
      </step>
      <step>
        <para>使用 NFSv4 时，请确保已选中<guimenu>启用 NFSv4</guimenu> 复选框，并且 <guimenu>NFSv4 域名</guimenu>包含 NFSv4 服务器所用的值。默认域为 <literal>localdomain</literal>。</para>
      </step>
      <step>
        <para>单击<guimenu>确定</guimenu>保存更改。
        </para>
      </step>
    </procedure>
   <para>
    配置写入<filename>/etc/fstab</filename>，并将装入指定的文件系统。当您稍后启动 YaST 配置客户端时，它还将读取此文件中的现有配置。
   </para>

  </section>

  <section xml:id="sec-nfs-import">
   <title>手动导入文件系统</title><indexterm><primary>NFS</primary><secondary>导入</secondary></indexterm><indexterm><primary>NFS</primary><secondary>装入</secondary></indexterm>
   <para>
    手动从 NFS 服务器导入文件系统的先决条件是运行 RPC 端口映射器。作为 <systemitem class="username">root</systemitem> 用户输入 <command>rcrpcbind</command> <option>start</option> 来启动它。然后就可以使用 <command>mount</command> 将远程文件系统像本地分区那样装入文件系统中：
   </para>
<screen>mount <replaceable>host</replaceable>:<replaceable>remote-path</replaceable><replaceable>local-path</replaceable></screen>
   <para>
    例如，要从 <systemitem>nfs.example.com</systemitem> 计算机导入用户目录，请使用：
   </para>
<screen>mount nfs.example.com:/home /home</screen>
   <section xml:id="sec-nfs-automount">
    <title>使用自动装入服务</title>
    <para>
     autofs 守护程序可用于自动装入远程文件系统。请在 <filename>/etc/auto.master</filename> 文件中添加以下条目：
    </para>
<screen>/nfsmounts /etc/auto.nfs</screen>
    <para>
     如果 <filename>auto.nfs</filename> 文件正确填充，<filename>/nfsmounts</filename> 目录将作为客户端上所有 NFS 装入的 root 目录。选择 <filename>auto.nfs</filename> 这个名称是为了方便起见，您可以选择任何名称。在 <filename>auto.nfs</filename> 中为所有 NFS 装入添加条目，如下所示：
    </para>
<screen>localdata -fstype=nfs server1:/data
nfs4mount -fstype=nfs4 server2:/</screen>
    <para>
     以 <systemitem class="username">root</systemitem> 身份运行 <command>rcautofs start </command> 以激活设置。对于此示例，<filename>/nfsmounts/localdata</filename>，<systemitem>server1</systemitem> 的 <filename>/data</filename> 目录将通过 NFS 装入，<systemitem>server2</systemitem> 的 <filename>/nfsmounts/nfs4mount</filename> 将通过 NFSv4 装入。
    </para>
    <para>
     如果在运行 autofs 服务时编辑 <filename>/etc/auto.master</filename> 文件，则必须用 <command>rcautofs restart</command> 重启动自动装入程序才能使更改生效。
    </para>
   </section>
   <section xml:id="sec-nfs-fstab">
    <title>手动编辑 <filename>/etc/fstab</filename></title>
    <para>
     通常，<filename>/etc/fstab</filename> 中的 NFSv3 装入项如下：
    </para>
<screen>nfs.example.com:/data /local/path nfs rw,noauto 0 0</screen>
    <para>
     也可以将 NFSv4 装入添加到 <filename>/etc/fstab</filename> 文件中。对于这些装入，请在第三列中使用 <literal>nfs4</literal> 而不是 <literal>nfs</literal>，并确保在第一列中的 <replaceable>nfs.example.com:</replaceable> 后面用 <filename>/</filename> 指定远程文件系统。<filename>/etc/fstab</filename> 中 NFSv4 装入的示例行如下所示：
    </para>
<screen>nfs.example.com:/ /local/pathv4 nfs4 rw,noauto 0 0</screen>
    <para>
     <literal>noauto</literal> 选项可禁止在启动时自动装入文件系统。如果您要手动安装各文件系统，可以缩短只指定安装点的安装命令：
    </para>
<screen>mount /local/path</screen>
    <para>
     请注意，如果您没有输入 <literal>noauto</literal> 选项，系统的初始化脚本将在启动时处理这些文件系统的装入。
    </para>
   </section>
  </section>
   
   <section xml:id="sec-nfs-pnfs">
     <title>并行 NFS (pNFS)</title>
     <para>NFS 是最老的协议之一，开发于上世纪八十年代。因此，如果您要共享小文件，NFS 通常能够满足需求。但是，如果您要传送大文件或有大量的客户端要访问数据，则 NFS 会陷入瓶颈并且严重影响系统性能。这是因为文件迅速变大，而以太网的相关速度没有完全跟上。 </para>
     <para>当您请求<quote>普通</quote> NFS 服务器中的文件时，服务器会查找文件元数据、收集所有数据并通过网络将数据传送到您的客户端。但是，无论文件的大小如何，性能瓶颈都会凸显出来：
     </para>
     
     <itemizedlist mark="bullet" spacing="normal">
       <listitem>
         <para>如果是小文件，则大部分时间都花在收集元数据上</para>
       </listitem>
       <listitem>
         <para>如果是大文件，则大部分时间花在将数据从服务器传送到客户端上</para>
       </listitem>
     </itemizedlist>
     
     <para>pNFS 或并行 NFS 则突破了此种限制，因为它将文件系统元数据从数据位置分离出来。因此，pNFS 需要两类服务器：</para>
      <itemizedlist mark="bullet" spacing="normal">
        <listitem>
          <para>一个 <emphasis>metadata</emphasis> 或<emphasis>控制服务器</emphasis>，用于处理所有与数据无关的通讯</para>
        </listitem>
        <listitem>
          <para>一或多个<emphasis>储存服务器</emphasis>，用于储存数据</para>
        </listitem>
      </itemizedlist>
     
     <para>元数据和储存服务器组成单独一个逻辑 NFS 服务器。当客户端要读取或写入时，元数据服务器会告诉 NFSv4 客户端使用哪个储存服务器访问文件块。客户端可以直接访问该服务器上的数据。
     </para>
     
     <para>SUSE Linux Enterprise 仅支持在客户端上的 pNFS。</para>
     
     <section xml:id="sec-nfs-pnfs-yast">
       <title>使用 YaST 配置 pNFS 客户端</title>
       <para>请执行<xref linkend="pro-nfs-import-yast2"/>中所述的步骤，但选中 <guimenu>pNFS (v4.1)</guimenu> 复选框以及可选的 <guimenu>NFSv4 共享</guimenu>。YaST 会执行所有必需的步骤，并且会在文件 <filename>/etc/exports</filename> 中写入所有必要选项。 </para>
     </section>
     
     <section xml:id="sec-nfs-pnfs-manual">
       <title>手动配置 pNFS 客户端</title>
       <para>请参阅<xref linkend="sec-nfs-import"/>着手配置。大多数配置通过 NFSv4 服务器完成。对于 pNFS，唯一的区别是将 <option>minorversion</option> 选项和元数据服务器 <replaceable>MDS_服务器</replaceable>添加到您的 <command>mount</command> 命令：</para>
       <screen>mount -t nfs4 -o minorversion=1 <replaceable>MDS_SERVER</replaceable> <replaceable>MOUNTPOINT</replaceable></screen>
       <para/>
       <para>为方便调试，请更改 <filename>/proc</filename> 文件系统中的值：</para>
       <screen>echo 32767 &gt; /proc/sys/sunrpc/nfsd_debug
echo 32767 &gt; /proc/sys/sunrpc/nfs_debug</screen>
     </section>
   </section>
   
 </section>
 <section xml:id="sec-nfs-info">
  <title>更多信息</title>

  <para>
   除了 <command>exports</command>、<command>nfs</command> 和 <command>mount</command> 的手册页外，还可在 <filename>/usr/share/doc/packages/nfsidmap/README</filename> 中找到关于配置 NFS 服务器和客户端的信息。有关更多联机文档，请参见以下网站：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     在 <link xlink:href="http://nfs.sourceforge.net/">SourceForge</link> 上联机查找详细的技术文档。
    </para>
   </listitem>
   <listitem>
    <para>
     关于设置采用 Kerberos 的 NFS 的描述，请参见 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/krb5-setup.html">NFS Version 4 Open Source Reference Implementation</link>。
    </para>
   </listitem>
   <listitem>
    <para>
     如果您对 NFSv4 有疑问，请参考 <link xlink:href="http://www.citi.umich.edu/projects/nfsv4/linux/faq/">Linux NFSv4 FAQ</link>（Linux NFSv4 常见问题）。
    </para>
   </listitem>
  </itemizedlist>
 </section>
</chapter>
