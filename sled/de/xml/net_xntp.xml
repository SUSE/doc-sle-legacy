<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE chapter
[
   <!ENTITY % entities SYSTEM "entity-decl.ent">
   %entities;
]>


<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="net_xntp.xml" xml:id="cha-netz-xntp"><title>Zeitsynchronisierung mit NTP</title><info><abstract>
  <para>
   Der NTP-(Network Time Protocol-)Mechanismus ist ein Protokoll für die Synchronisierung der Systemzeit über das Netzwerk. Erstens kann ein Computer die Zeit von einem Server abrufen, der als zuverlässige Zeitquelle gilt. Zweitens kann ein Computer selbst für andere Computer im Netzwerk als Zeitquelle fungieren. Es gibt zwei Ziele – das Aufrechterhalten der absoluten Zeit und das Synchronisieren der Systemzeit aller Computer im Netzwerk.
  </para>
 </abstract></info>


 <para>
  Das Aufrechterhalten der genauen Systemzeit ist in vielen Situationen wichtig. Die integrierte Hardware-Uhr erfüllt häufig nicht die Anforderungen bestimmter Anwendungen, beispielsweise Datenbanken oder Cluster. Die manuelle Korrektur der Systemzeit würde schwerwiegende Probleme nach sich ziehen; das Zurückstellen kann beispielsweise zu Fehlfunktionen wichtiger Anwendungen führen. Die Systemzeiten der in einem Netzwerk zusammengeschlossenen Computer müssen in der Regel synchronisiert werden. Es empfiehlt sich aber nicht, die Zeiten manuell anzugleichen. Vielmehr sollten Sie dazu NTP verwenden. Der NTP-Dienst passt die Systemzeit ständig anhand zuverlässiger Zeitserver im Netzwerk an. Zudem ermöglicht er die Verwaltung lokaler Referenzuhren, beispielsweise funkgesteuerter Uhren.
 </para>
 <note os="sled">
  <para>
   Folgen Sie den Anweisungen unter <xref linkend="proc-ad-join"/>, um die Zeitsynchronisierung mithilfe von Active Directory zu aktivieren.
  </para>
 </note>
 <section xml:id="sec-netz-xntp-yast">
  <title>Konfigurieren eines NTP-Client mit YaST</title>

  <para>
   Der NTP-Daemon (<systemitem class="daemon">ntpd</systemitem>) im <systemitem>ntp</systemitem>-Paket ist so voreingestellt, dass die Uhr des lokalen Computers als Zeitreferenz verwendet wird. Das Verwenden der Hardware-Uhr ist jedoch nur eine Ausweichlösung, wenn keine genauere Zeitquelle verfügbar ist. YaST erleichtert die Konfiguration von NTP-Clients.
  </para>

  <section xml:id="sec-net-ntp-yast-basic">
   <title>Grundlegende Konfiguration</title>
   <para>
    Die NTP-Client-Konfiguration mit YaST (<menuchoice><guimenu>Netzwerkdienste</guimenu> <guimenu>NTP-Konfiguration</guimenu></menuchoice>) benötigt zwei Dialogfelder. Legen Sie den Startmodus <systemitem class="daemon">ntpd</systemitem> und den abzufragenden Server auf dem Karteireiter <guimenu>Allgemein Einstellungen</guimenu> fest.
   </para>
   
   <variablelist>
    <varlistentry>
     <term><guimenu>Nur manuell</guimenu>
     </term>
     <listitem>
      <para>
       Wählen Sie <guimenu>Nur manuell</guimenu>, wenn der <systemitem class="daemon">ntpd</systemitem>-Daemon manuell gestartet werden soll.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>Jetzt und beim Booten</guimenu>
     </term>
     <listitem>
      <para>
       Wählen Sie <guimenu>Jetzt und beim Booten</guimenu>, um <systemitem class="daemon">ntpd</systemitem> automatisch beim Booten des Systems zu starten. Diese Einstellung wird dringend empfohlen. <phrase os="sled;sles">Konfigurieren Sie dann den Server entsprechend der Beschreibung <xref linkend="sec-net-ntp-yast-new-sync"/></phrase>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </section>



  <section xml:id="sec-net-ntp-yast-new-sync">
   <title>Ändern der Basiskonfiguration</title>
   <para>
    Die Server und anderen Zeitquellen für die Abfrage durch den Client sind im unteren Bereich im Karteireiter <guimenu>Allgemeine Einstellungen</guimenu> aufgelistet. Bearbeiten Sie diese Liste nach Bedarf mithilfe der Optionen <guimenu>Hinzufügen</guimenu>, <guimenu>Bearbeiten</guimenu> und <guimenu>Löschen</guimenu>. <guimenu>Mit </guimenu>Protokoll anzeigen können die Protokolldateien Ihres Clients angezeigt werden.
   </para>
   <para>
    Klicken Sie auf <guimenu>Hinzufügen</guimenu>, um eine neue Quelle für Zeitinformationen hinzuzufügen. Wählen Sie im nachfolgenden Dialogfeld den Quellentyp aus, mit dem die Zeitsynchronisierung vorgenommen werden soll. Mit den zur Verfügung stehenden Optionen können Sie
   </para>
   <figure xml:id="fig-yast-ntp-selserv">
    <title>YaST: NTP-Server</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast_ntp_selserv.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <variablelist>
    <varlistentry>
     <term>Server</term>
     <listitem>
      <para>
       Geben Sie in der Pulldown-Liste unter <guimenu>Auswählen</guimenu> (siehe <xref linkend="fig-yast-ntp-selserv"/>) an, ob die Zeitsynchronisierung anhand eines Zeitservers in Ihrem lokalen Netzwerk (<guimenu>Lokaler NTP-Server</guimenu>) oder eines Zeitservers im Internet erfolgen soll, der Ihre Zeitzone verwaltet (<guimenu>Öffentlicher NTP-Server</guimenu>). Bei einem lokalen Zeitserver klicken Sie auf <guimenu>Lookup</guimenu>, um eine SLP-Abfrage für verfügbare Zeitserver in Ihrem Netzwerk zu starten. Wählen Sie den am besten geeigneten Zeitserver in der Liste der Suchergebnisse aus und schließen Sie das Dialogfeld mit <guimenu>OK</guimenu>. Bei einem öffentlichen Zeitserver wählen Sie in der Liste unter <guimenu>Öffentlicher NTP-Server</guimenu> Ihr Land (Ihre Zeitzone) sowie einen geeigneten Server aus und schließen das Dialogfeld dann mit <guimenu>OK</guimenu>. Überprüfen Sie im Hauptdialogfeld die Verfügbarkeit des ausgewählten Servers mit <guimenu>Test</guimenu>. Unter <guimenu>Optionen</guimenu> können Sie weitere Optionen für <systemitem class="daemon">ntpd</systemitem> einstellen.
      </para>
      <para>
       Mit den <guimenu>Access Control Options</guimenu> (Zugriffskontrolloptionen) können Sie die Aktionen einschränken, die der entfernte Computer mit dem Daemon Ihres Computers ausführen kann. Dieses Feld ist nur aktiviert, wenn die Option <guimenu>Restrict NTP Service to Configured Servers Only</guimenu> (NTP-Dienst auf konfigurierte Server beschränken) auf dem Karteireiter <guimenu>Sicherheitseinstellungen</guimenu> aktiviert ist (siehe <xref linkend="fig-yast-ntp-adv-sec"/>). Die Optionen entsprechen den <literal>restrict</literal>-Klauseln der Datei <filename>/etc/ntp.conf</filename>. Die Klausel <literal>nomodify notrap noquery</literal> verhindert beispielsweise, dass der Server die NTP-Einstellungen Ihres Computers ändern und die Trap-Funktion (eine Fernprotokollierungsfunktion für Ereignisse) Ihres NTP-Daemons verwenden kann. Diese Einschränkungen werden besonders für Server außerhalb Ihrer Kontrolle empfohlen (z. B. im Internet).
      </para>
      <para>
       Ziehen Sie bezüglich detaillierter Informationen <filename>/usr/share/doc/packages/ntp-doc</filename> zurate (Bestandteil des <systemitem>ntp-doc</systemitem>-Pakets).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Peer</term>
     <listitem>
      <para>
       Ein Peer ist ein Computer, mit dem eine symmetrische Beziehung eingerichtet wird: Er fungiert sowohl als Zeitserver als auch als Client. Wenn Sie einen Peer im selben Netzwerk anstelle eines Servers verwenden möchten, geben Sie die Adresse des Systems ein. Der Rest des Dialogfelds ist mit dem Dialogfeld <guimenu>Server</guimenu> identisch.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Funkuhr</term>
     <listitem>
      <para>
       Wenn eine Funkuhr für die Zeitsynchronisierung in Ihrem System verwendet werden soll, geben Sie Uhrtyp, Gerätezahl, Gerätename und weitere Optionen in diesem Dialogfeld ein. Klicken Sie auf <guimenu>Treiber-Kalibirierung</guimenu>, um den Treiber genauer einzustellen. Detaillierte Informationen zum Betrieb einer lokalen Funkuhr finden Sie in <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Ausgangs-Broadcast</term>
     <listitem>
      <para>
       Zeitinformationen und Abfragen können im Netzwerk auch per Broadcast übermittelt werden. Geben Sie in diesem Dialogfeld die Adresse ein, an die Broadcasts gesendet werden sollen. Die Option für Broadcasts sollte nur aktiviert werden, wenn Ihnen eine zuverlässige Zeitquelle, etwa eine funkgesteuerte Uhr, zur Verfügung steht.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Eingangs-Broadcast</term>
     <listitem>
      <para>
       Wenn Ihr Client die entsprechenden Informationen per Broadcast erhalten soll, geben Sie in diesen Feldern die Adresse ein, von der die jeweiligen Pakete akzeptiert werden sollen.

      </para>
     </listitem>
    </varlistentry>
   </variablelist>



   <figure xml:id="fig-yast-ntp-adv-sec">
    <title>Erweiterte NTP-Konfiguration: Sicherheitseinstellungen</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata width="75%" fileref="yast2_xntp_adv_sec.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>
    Legen Sie auf dem Karteireiter <guimenu>Sicherheitseinstellungen</guimenu> (siehe <xref linkend="fig-yast-ntp-adv-sec"/>) fest, ob <systemitem class="daemon">ntpd</systemitem> in einem „Chroot Jail“ gestartet werden soll. Standardmäßig ist <guimenu>DHCP-Daemon in Chroot-Jail starten</guimenu> aktiviert. Hierdurch wird die Sicherheit im Falle eines Angriffs über <systemitem class="daemon">ntpd</systemitem> erhöht, da der Angreifer daran gehindert wird, das gesamte System zu beeinträchtigen.
   </para>
   <para>
    Die Option <guimenu>NTP-Dienst auf konfigurierte Server beschränken</guimenu> erhöht die Sicherheit Ihres Systems. Wenn gewählt, verhindert diese Option, dass entfernte Computer die NTP-Einstellungen Ihres Computers anzeigen und ändern und die Trap-Funktion für die Fernprotokollierung von Ereignissen verwenden können. Wenn gewählt, gelten diese Einschränkungen für alle entfernten Computer, es sei denn, Sie überschreiben die Zugriffskontrolloptionen für einzelne Computer in der Liste der Zeitquellen auf dem Karteireiter <guimenu>Allgemeine Einstellungen</guimenu>. Allen anderen entfernten Computern wird nur die Abfrage der lokalen Zeit erlaubt.
   </para>
   <para>
    Aktivieren Sie <guimenu>Firewall-Port öffnen</guimenu>, wenn SuSEfirewall2 aktiviert ist (Standardeinstellung). Wenn Sie den Port geschlossen lassen, können Sie keine Verbindung zum Zeitserver herstellen.
   </para>
  </section>
 </section>



 <section xml:id="sec-netz-xntp-netconf">
  <title>Manuelle Konfiguration von NTP im Netzwerk</title>

  <para>

   Die einfachste Art der Verwendung eines Zeitservers im Netzwerk besteht darin, Serverparameter festzulegen. Wenn beispielsweise ein Zeitserver mit der Bezeichnung <systemitem>ntp.example.com</systemitem> vom Netzwerk aus erreichbar ist, ergänzen Sie die Datei <filename>/etc/ntp.conf</filename> um seinen Namen, indem Sie die folgende Zeile hinzufügen:
  </para>

<screen>server ntp.example.com</screen>

  <para>
   Wenn Sie weitere Zeitserver hinzufügen möchten, fügen Sie zusätzliche Zeilen mit dem Schlüsselwort <literal>server</literal> ein. Nach der Initialisierung von <systemitem class="daemon">ntpd</systemitem> mit dem Kommando <command>rcntp</command> <option>start</option> dauert es etwa eine Stunde, bis die Zeit stabil ist und die Drift-Datei für das Korrigieren der lokalen Computeruhr erstellt wird. Mithilfe der Drift-Datei kann der systematische Fehler der Hardware-Uhr berechnet werden, sobald der Computer eingeschaltet wird. Die Korrektur kommt umgehend zum Einsatz und führt zu einer größeren Stabilität der Systemzeit.
  </para>

  <para>
   Es gibt zwei Möglichkeiten, den NTP-Mechanismus als Client zu verwenden: Erstens kann der Client in regelmäßigen Abständen die Zeit von einem bekannten Server abfragen. Wenn viele Clients vorhanden sind, kann dies zu einer starken Auslastung des Servers führen. Zweitens kann der Client auf NTP-Broadcasts warten, die von Broadcast-Zeitservern im Netzwerk gesendet werden. Dieser Ansatz hat den Nachteil, dass die Qualität des Servers unbekannt ist und dass ein Server, der falsche Informationen sendet, zu schwerwiegenden Problemen führen kann.
  </para>

  <para>
   Wenn die Zeit per Broadcast ermittelt wird, ist der Servername nicht erforderlich. Geben Sie in diesem Fall die Zeile <literal>broadcastclient</literal> in die Konfigurationsdatei <filename>/etc/ntp.conf</filename> ein. Wenn ein oder mehrere bekannte Zeitserver exklusiv verwendet werden sollen, geben Sie die Namen in der Zeile ein, die mit <literal>servers</literal> beginnt.
  </para>


 </section>



 <section xml:id="sec-netz-xntp-dynamic">
  <title>Dynamische Zeitsynchronisierung während der Laufzeit</title>



  <para>
   Wenn das System ohne Netzwerkverbindung startet, fährt <systemitem class="daemon">ntpd</systemitem> zwar hoch, kann jedoch nicht die DNS-Namen der in der Konfigurationsdatei festgelegten Zeitserver auflösen. Dies kann vorkommen, wenn Sie Network Manager mit einem verschlüsselten WLAN verwenden.
  </para>

  <para>
   Wenn <systemitem class="daemon">ntpd</systemitem> die DNS-Namen während der Laufzeit auflösen soll, müssen Sie die Option <systemitem>Dynamisch</systemitem> festlegen. Wenn das Netzwerk dann einige Zeit nach dem Start aufgebaut wird, überprüft <systemitem class="daemon">ntpd</systemitem> die Namen erneut und kann die Zeitserver zum Abrufen der Zeit erreichen.
  </para>

  <para>
   Bearbeiten Sie <filename>/etc/ntp.conf</filename> manuell und fügen Sie <systemitem>Dynamisch</systemitem> zu einem oder mehreren <systemitem>Server</systemitem>einträgen hinzu:
  </para>

<screen>server ntp.example.com dynamic</screen>

  <para>
   Oder verwenden Sie YaST, und gehen Sie folgendermaßen vor:
  </para>

  <procedure>
   <step>
    <para>
     Klicken Sie in YaST auf <menuchoice> <guimenu>Netzwerkdienste</guimenu> <guimenu>NTP-Konfiguration</guimenu> </menuchoice>.
    </para>
   </step>
   <step>
    <para>
     Wählen Sie den Server aus, der konfiguriert werden soll. Klicken Sie anschließend auf <guimenu>Bearbeiten</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Aktivieren Sie das Feld <guimenu>Optionen</guimenu> und fügen Sie <literal>Dynamisch</literal> hinzu. Verwenden Sie ein Leerzeichen zum Trennen, falls bereits andere Optionen eingetragen sind.
    </para>
   </step>
   <step>
    <para>
     Klicken Sie auf <guimenu>OK</guimenu>, um das Dialogfeld für die Bearbeitung zu schließen. Wiederholen Sie den vorherigen Schritt, um alle Server wunschgemäß zu ändern.
    </para>
   </step>
   <step>
    <para>
     Klicken Sie abschließend auf <guimenu>OK</guimenu>, um die Einstellungen zu speichern.
    </para>
   </step>
  </procedure>
 </section>



 <section xml:id="sec-netz-xntp-normal">
  <title>Einrichten einer lokalen Referenzuhr</title>

  <para>
   Das Software-Paket <systemitem class="daemon">ntpd</systemitem>enthält Treiber für das Verbinden lokaler Referenzuhren. Eine Liste unterstützter Uhren steht im Paket <systemitem class="resource">ntp-doc</systemitem> in der Datei <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> zur Verfügung. Jeder Treiber ist mit einer Nummer verknüpft. In NTP wird die eigentliche Konfiguration mit Pseudo-IP-Adressen durchgeführt. Die Uhren werden so in die Datei <filename>/etc/ntp.conf</filename> eingegeben, als ob sie im Netzwerk vorhanden wären. Zu diesem Zweck werden Ihnen spezielle IP-Adressen im Format <literal>127.127.<replaceable>t</replaceable>.<replaceable>u</replaceable></literal> zugewiesen. Hierbei steht <replaceable>t</replaceable> für den Uhrentyp und legt fest, welcher Treiber verwendet wird und <replaceable>u</replaceable> steht für die Einheit (unit), die die verwendete Schnittstelle bestimmt.

  </para>

  <para>
   Im Regelfall verfügen die einzelnen Treiber über spezielle Parameter, die die Konfigurationsdetails beschreiben. Die Datei <filename>/usr/share/doc/packages/ntp-doc/drivers/driver<replaceable>NN</replaceable>.html</filename> (<replaceable>NN</replaceable> steht für die Anzahl der Treiber) bietet Informationen zum jeweiligen Uhrentyp. Für die Uhr vom <quote>Typ 8</quote> (Funkuhr über serielle Schnittstelle) ist ein zusätzlicher Modus erforderlich, der die Uhr genauer angibt. Das Conrad DCF77-Empfängermodul weist beispielsweise Modus 5 auf. Wenn diese Uhr als bevorzugte Referenz verwendet werden soll, geben Sie das Schlüsselwort <literal>prefer</literal> an. Die vollständige <literal>server</literal>-Zeile für ein Conrad DCF77-Empfängermodul sieht folgendermaßen aus:
  </para>

<screen>server 127.127.8.0 mode 5 prefer</screen>

  <para>
   Für andere Uhren gilt dasselbe Schema. Nach der Installation des Pakets <systemitem class="resource">ntp-doc</systemitem> steht die Dokumentation für ntp im Verzeichnis <filename>/usr/share/doc/packages/ntp-doc</filename> zur Verfügung. Die Datei <filename>/usr/share/doc/packages/ntp-doc/refclock.html</filename> enthält Links zu den Treiberseiten, auf denen die Treiberparameter beschrieben werden.
  </para>
 </section>
 
</chapter>
