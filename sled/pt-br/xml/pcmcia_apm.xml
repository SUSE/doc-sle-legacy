<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="pcmcia_apm.xml" id="cha-pmanage">
 <title>Gerenciamento de energia</title><indexterm id="idx-power-management" class="startofrange"> <primary>gerenciamento de energia</primary> </indexterm> <indexterm id="idx-laptops-power-management" class="startofrange"> <primary>laptops</primary> <secondary>gerenciamento de energia</secondary> </indexterm> <indexterm> <primary>gerenciamento de energia</primary> <secondary>ACPI</secondary> </indexterm>
 
 <para>
  O gerenciamento de energia é especialmente importante em laptops, mas também é útil em outros sistemas. A ACPI (Advanced Configuration and Power Interface — Interface de Energia e Configuração Avançada) está disponível em todos os computadores modernos (laptops, desktops e servidores). As tecnologias de gerenciamento de energia exigem hardware adequado e rotinas BIOS. A maioria dos laptops e muitos desktops e servidores modernos atendem a esses requisitos. Também é possível controlar a escala de frequência de CPU para economizar energia ou reduzir o ruído.
 </para>
 <sect1 id="sec-pmanage-save">
  <title>Funções de economia de energia</title>

  <para>
   As funções de economia de energia não são significativas apenas para o uso móvel de laptops, como também para sistemas desktop. As funções principais e respectivas utilizações na ACPI são:
  </para>

  <variablelist>
   <varlistentry>
    <term>Standby<indexterm> <primary>gerenciamento de energia</primary> <secondary>standby</secondary> </indexterm>
    </term>
    <listitem>
     <para>
      Não suportado.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Suspender (para memória)<indexterm> <primary>gerenciamento de energia</primary> <secondary>suspender</secondary> </indexterm>
    </term>
    <listitem>
     <para>
      Este modo grava todo o estado do sistema na memória RAM. Em seguida, todo o sistema é colocado em repouso, salvo a memória RAM. Neste estado, o computador consome pouquíssima energia. A vantagem desse estado é a possibilidade de reiniciar o trabalho no mesmo ponto em alguns segundos sem precisar inicializar e reiniciar os aplicativos. Essa função corresponde ao estado da ACPI <literal>S3</literal>. 

     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Suspender (para o disco)<indexterm> <primary>gerenciamento de energia</primary> <secondary>hibernação</secondary> </indexterm>
    </term>
    <listitem>
     <para>
      Neste modo operacional, o estado do sistema inteiro é gravado no disco rígido e o sistema é desligado. Deve existir uma partição de troca pelo menos tão grande quanto a RAM para gravar todos os dados ativos. A reativação desse estado leva de 30 a 90 segundos. O estado anterior ao suspenso é restaurado. Alguns fabricantes oferecem variantes híbridas desse modo, como RediSafe em Thinkpads da IBM. O estado correspondente da ACPI é <literal>S4</literal>. No Linux, a suspensão para disco é desempenhada pelas rotinas de kernel, que são independentes de ACPI.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Monitor de bateria<indexterm> <primary>gerenciamento de energia</primary> <secondary>monitor de bateria</secondary> </indexterm>
    </term>
    <listitem>
     <para>
      A ACPI verifica o status da carga da bateria e fornece informações correspondentes. Além disso, ela coordena as ações a serem desempenhadas quando um status de carga crítico é atingido.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Desligamento automático</term>
    <listitem>
     <para>
      Após um encerramento, o computador é desligado. Isto é especialmente importante quando um encerramento automático é realizado pouco antes da bateria esgotar-se.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Controle de velocidade do processador</term>
    <listitem>
     <para>
      Em conexão com a CPU, é possível economizar energia de três maneiras diferentes: escala de frequência e voltagem (também conhecida como <phrase role="productname">PowerNow!</phrase> ou <phrase role="productname">Speedstep</phrase>), throttling e adormecimento do processador (C-states). Dependendo do modo operacional do computador, esses métodos também podem ser combinados.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec-pmanage-acpi">
  <title>Advanced Configuration and Power Interface (ACPI)</title><indexterm id="idx-power-management-ACPI" class="startofrange"> <primary>gerenciamento de energia</primary> <secondary>ACPI</secondary> </indexterm>

  <para>
   A ACPI foi desenvolvida para habilitar o sistema operacional a configurar e controlar cada componente de hardware. A ACPI substitui tanto o Plug and Play (PnP) de Gerenciamento de Energia quanto o Gerenciamento Avançado de Energia (APM). Ela envia informações sobre a bateria, o adaptador de CA, a temperatura, o ventilador e eventos do sistema, como <quote>fechar tampa</quote> ou <quote>bateria fraca</quote>.
  </para>

  <para>
   O BIOS fornece tabelas que contém informações sobre os componentes individuais e métodos de acesso ao hardware. O sistema operacional usa essas informações para tarefas como atribuir interrupções ou ativar e desativar componentes. Como o sistema operacional executa comandos armazenados no BIOS, a funcionalidade depende da implementação do BIOS. As tabelas que a ACPI podem detectar e carregar são reportadas em <filename>/var/log/boot.msg</filename>. Consulte a <xref linkend="sec-pmanage-probs"/> para obter mais informações sobre solução de problemas da ACPI.
  </para><indexterm> <primary>arquivos de registro</primary> <secondary>boot.msg</secondary> </indexterm>

  <sect2 id="sec-pmanage-powernow">
   <title>Controlando o desempenho da CPU</title>
   <para>
    A CPU pode economizar energia de três maneiras:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Escala de frequência e voltagem
     </para>
    </listitem>
    <listitem>
     <para>
      Obstruindo a frequência do relógio (T-states)
     </para>
    </listitem>
    <listitem>
     <para>
      Adormecendo o processador (C-states)
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Dependendo do modo operacional do computador, estes métodos também podem ser combinados. Economizar energia também significa que o sistema esquenta menos e os ventiladores são ativados com menos frequência.
   </para>
   <para>
    Expansão e throttling de frequência são relevantes apenas quando o processador está ocupado, pois o C-state mais econômico é aplicado de qualquer maneira quando o processador fica ocioso. Se a CPU estiver ocupada, a escala da frequência é o método recomendado para economia de energia. Em geral o processador só trabalha com carga parcial. Neste caso, pode ser executado com uma frequência inferior. Normalmente, a expansão da frequência dinâmica controlada pelo regulador sob demanda do kernel é a melhor abordagem.
   </para>
   <para>
    Throttling deve ser usado como última alternativa, por exemplo, para ampliar o tempo de operação da bateria, apesar de uma alta carga do sistema. Contudo, alguns sistemas não são executados suavemente quando ocorrem throttlings em excesso. Ademais, o throttling da CPU não faz sentido se a CPU tem pouco a fazer.
   </para>
   <para>
    Para obter informações mais detalhadas, consulte o <xref linkend="cha-tuning-power"/>.
   </para>
  </sect2>

  <sect2 id="sec-pmanage-probs">
   <title>Solução de problemas</title>
   <para>
    Há dois tipos de problemas. De um lado, o código ACPI do kernel pode conter erros que não foram detectados em tempo útil. Neste caso, uma solução estará disponível para download. O mais comum é que os problemas sejam causados pelo BIOS. Às vezes, desvios da especificação da ACPI são propositalmente integrados ao BIOS para contornar erros na implementação da ACPI em outros sistemas operacionais amplamente utilizados. Componentes de hardware que têm erros sérios na implementação da ACPI são gravados em uma lista negra que impede que o kernel do Linux use a ACPI para esses componentes.
   </para>
   <para>
    A primeira ação a ser tomada quando problemas forem detectados, é atualizar o BIOS. Se o computador não inicializar de jeito nenhum, um dos seguintes parâmetros de boot poderá ser útil:
   </para>
   <variablelist>
    <varlistentry>
     <term>pci=noacpi</term>
     <listitem>
      <para>
       Não usar ACPI para configurar os dispositivos PCI.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>acpi=ht</term>
     <listitem>
      <para>
       Realizar apenas uma configuração com recursos simples. Não usar a ACPI para outros fins.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>acpi=off</term>
     <listitem>
      <para>
       Desabilitar a ACPI.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <warning>
    <title>problemas de boot sem ACPI</title>
    <para>
     Algumas máquinas mais novas (especialmente os sistemas SMP e AMD64) precisam de ACPI para configurar o hardware corretamente. Nestas máquinas, desabilitar a ACPI pode causar problemas.
    </para>
   </warning>
   <para>
    Às vezes a máquina é confundida pelo hardware conectado por USB ou FireWire. Se uma máquina se recusa a inicializar, desconecte todos os itens de hardware desnecessários e tente novamente.
   </para>
   <para>
    Monitore as mensagens de boot do sistema com o comando <command>dmesg <option>| grep -2i acpi</option></command> (ou todas as mensagens, porque o problema pode não ser causado pela ACPI) após o boot. Se ocorrer um erro ao analisar uma tabela ACPI, a tabela mais importante, a DSDT (<emphasis>Differentiated System Description Table</emphasis>), poderá ser substituída por uma versão aprimorada. Neste caso, a DSDT defeituosa do BIOS é ignorada. O procedimento está descrito na <xref linkend="sec-powersave-faq"/>.
   </para>
   <para>
    Na configuração do kernel, há um switch para ativar as mensagens de depuração da ACPI. Se houver um kernel com depuração ACPI compilado e instalado, serão emitidas informações detalhadas.
   </para>
   <para>
    Se você tiver problemas com BIOS ou hardware, é sempre recomendável entrar em contato com os fabricantes. Especialmente se eles nem sempre derem assistência ao Linux, devem ser indagados em caso de problemas. Os fabricantes só levarão a questão a sério se compreenderem que um número satisfatório de seus clientes usa Linux.
   </para>
   <sect3 id="sec-pmanage-info">
    <title>Para obter mais informações</title>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <ulink url="http://tldp.org/HOWTO/ACPI-HOWTO/"/> (ACPI HOWTO detalhado, contém patches DSDT)
      </para>
     </listitem>
     <listitem>
      <para>
       <ulink url="http://www.acpi.info"/> (Configuração Avançada e Especificação da Interface de Energia)
      </para>
     </listitem>
     <listitem>
      <para>
       <ulink url="http://www.lesswatts.org/projects/acpi/"/> (O projeto ACPI4Linux em Sourceforge)
      </para>
     </listitem>
     <listitem>
      <para>
       <ulink url="http://acpi.sourceforge.net/dsdt/index.php"/> (Patches DSDT por Bruno Ducrot)
      </para>
     </listitem>
    </itemizedlist><indexterm class="endofrange" startref="idx-power-management-ACPI"/>
   </sect3>
  </sect2>
 </sect1>
 <sect1 id="sec-pmanage-silenthd">
  <title>Descanso do disco rígido</title>

  <para>
   No Linux, o disco rígido pode colocado em repouso total se não estiver em uso e pode ser executado em modo mais econômico ou silencioso. Nos laptops modernos, não é necessário desativar o disco rígido manualmente, porque entram automaticamente em um modo operacional econômico sempre que não estão em uso. No entanto, para aumentar a economia de energia, experimente alguns dos seguintes métodos usando o comando <command>hdparm</command>.
  </para>

  <para>
   Ele pode ser usado para modificar várias configurações de disco rígido. A opção <option>-y</option> alterna instantaneamente o disco rígido para o modo standby. <option>-Y</option> coloca-o em repouso. <command>hdparm <option>-S x</option></command> faz o disco rígido ser encerrado após um determinado período de inatividade. Substitua <replaceable>x</replaceable> conforme a seguir: <literal>0</literal> desabilita esse mecanismo, fazendo o disco rígido funcionar continuamente. Valores de <literal>1</literal> a <literal>240</literal> são multiplicados por 5 segundos. Valores de <literal>241</literal> a <literal>251</literal> correspondem de 1 a 11 vezes 30 minutos.
  </para>

  <para>
   As opções de economia de energia interna do disco rígido podem ser controladas pela opção <literal>-B</literal>. Selecione um valor de <literal>0</literal> a <literal>255</literal> para obter de economia máxima a throughput máximo. O resultado depende do disco rígido usado e é difícil de avaliar. Para tornar um disco rígido mais silencioso, use a opção <literal>-M</literal>. Selecione um valor de <literal>128</literal> a <literal>254</literal> para obter de silencioso a rápido.
  </para>

  <para>
   Muitas vezes não é fácil colocar o disco rígido em repouso. No Linux, vários processos gravam no disco rígido, ativando-o repetidamente. Portanto, é importante entender como o Linux trata os dados que necessitam ser gravados no disco rígido. Primeiro, todos os dados estão no buffer da memória RAM. Esse buffer é monitorado pelo daemon <systemitem class="daemon">pdflush</systemitem>. Quando os dados atingem uma determinada idade limite ou quando o buffer está cheio até certo grau, o conteúdo do buffer é descarregado para o disco rígido. O tamanho do buffer é dinâmico e depende do tamanho da memória e da carga do sistema. Por padrão, pdflush é configurado em intervalos curtos para obter a integridade máxima de dados. Ele verifica o buffer a cada 5 segundos e grava os dados no disco rígido. As seguintes variáveis são interessantes:
  </para>

  <variablelist>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_writeback_centisecs</filename>
    </term>
    <listitem>
     <para>
      Inclui o atraso até o thread pdflush ser acionado (em centésimos de segundo).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_expire_centisecs</filename>
    </term>
    <listitem>
     <para>
      Define o período após o qual uma página modificada deve ser gravada por último. O padrão é <literal>3000</literal>, o que equivale a 30 segundos.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_background_ratio</filename>
    </term>
    <listitem>
     <para>
      Porcentagem máxima de páginas modificadas para pdflush começar a gravá-las. O padrão é <literal>5</literal>%.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>/proc/sys/vm/dirty_ratio</filename>
    </term>
    <listitem>
     <para>
      Quando a página modificada exceder essa porcentagem da memória total, os processos são forçados a gravar buffers modificados durante suas frações de tempo em vez de continuar gravando.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>deficiência da integridade de dados</title>
   <para>
    Qualquer modificação nas configurações do daemon <systemitem class="daemon">pdflush</systemitem> coloca em risco a integridade dos dados.
   </para>
  </warning>



  <para>
   Além desses processos, sistemas JFS, como <systemitem class="filesystem">Btrfs</systemitem>, <systemitem class="filesystem">Ext3</systemitem>, <systemitem class="filesystem">Ext4</systemitem> entre outros, gravam seus metadados independentemente do <systemitem class="daemon">pdflush</systemitem>, que também impede que o disco rígido pare de funcionar. <phrase os="sled">Para evitar isso, foi desenvolvida uma extensão especial de kernel para dispositivos móveis. Para usar a extensão, instale o pacote <systemitem class="resource">laptop-mode-tools</systemitem> e consulte <filename>/usr/src/linux/Documentation/laptops/laptop-mode.txt</filename> para ver os detalhes.</phrase>
  </para>

  <para>
   Outro fator importante é o modo como se comportam os programas ativos. Por exemplo, os bons editores gravam regularmente backups ocultos do arquivo modificado no momento para o disco rígido, fazendo com que ele saia do modo de hibernação. Recursos como este podem ser desabilitados às custas da integridade dos dados.
  </para>

  <para>
   Com relação a isso, o mail daemon postfix faz uso da variável <systemitem>POSTFIX_LAPTOP</systemitem>. Se essa variável for configurada para <literal>sim</literal>, postfix acessa o disco rígido com muito menos frequência.
  </para>

  <para os="sled">

   No <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase>, estas tecnologias são controladas por <systemitem>laptop-mode-tools</systemitem>.
  </para><indexterm class="endofrange" startref="idx-power-management"/><indexterm class="endofrange" startref="idx-laptops-power-management"/>
 </sect1>
 <sect1 id="sec-powersave-faq">
  <title>Solução de problemas</title>

  <para>
   Todas as mensagens de erro e alertas são registradas no arquivo <filename>/var/log/messages</filename>. As seções a seguir abordam os problemas mais comuns.
  </para>

  <sect2 id="sec-powersave-faq-acpi">
   <title>ACPI ativada com suporte de hardware, mas funções não funcionam</title>
   <para>
    Se tiver problemas com a ACPI, procure nos resultados de <command>dmesg</command> por mensagens específicas da ACPI, utilizando o comando <command>dmesg|grep <option>-i acpi</option></command>.
   </para>
   <para>
    Poderá ser necessário atualizar o BIOS para solucionar o problema. Na home page do fabricante do seu laptop, procure uma versão atualizada do BIOS e instale-a. Peça ao fabricante para estar em conformidade com a última especificação da ACPI. Se os erros persistirem após a atualização do BIOS, faça o seguinte para substituir a tabela DSDT defeituosa no seu BIOS com um DSDT atualizado:
   </para>
   <procedure>
    <title>Atualizando a tabela DSDT no BIOS</title>
    <para>
     Para o procedimento a seguir, verifique se estes pacotes estão instalados: <systemitem class="resource">kernel-source</systemitem>, <systemitem class="resource" os="sles;sled">pmtools</systemitem> e <systemitem class="resource">mkinitrd</systemitem>.
    </para>
    <step performance="required">
     <para>
      Faça o download do DSDT para o seu sistema em <ulink url="http://acpi.sourceforge.net/dsdt/index.php"/>. Verifique se o arquivo está descompactado e compilado como mostra a extensão de arquivo <literal>.aml</literal> (linguagem computacional ACPI). Se for o caso, continue com a etapa 3.
     </para>
    </step>
    <step performance="required">
     <para>
      Se a extensão de arquivo da tabela descarregada for <literal>.asl</literal> (linguagem de origem da ACPI), compile-a executando o seguinte comando:
     </para>
<screen>iasl <option>-sa file.asl</option></screen>
    </step>
    <step performance="required">
     <para>
      Copie o arquivo (resultante) <filename>DSDT.aml</filename> para qualquer local (<filename>/etc/DSDT.aml</filename> é recomendado).
     </para>
    </step>
    <step performance="required">
     <para>
      Edite <filename>/etc/sysconfig/kernel</filename> e adapte o caminho para o arquivo DSDT de forma compatível. 
     </para>
    </step>
    <step performance="required">
     <para>
      Inicie o <command>mkinitrd</command>. Sempre que você instalar o kernel e usar o <command>mkinitrd</command> para criar um arquivo <filename>initrd</filename>, a DSDT modificada será integrada e carregada quando o sistema for inicializado.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 id="sec-powersave-faq-cpufreq">
   <title>A frequência da CPU não funciona</title>
   <para>
    Consulte as fontes do kernel para ver se o seu processador é suportado. Você poderá precisar de um módulo de kernel ou de opção especial para ativar o controle de frequência da CPU. Se o pacote <systemitem class="resource">kernel-source</systemitem> estiver instalado, essas informações estarão disponíveis em <filename>/usr/src/linux/Documentation/cpu-freq/*</filename>.
   </para>
  </sect2>

  <sect2 id="sec-powersave-faq-suspend">
   <title>Suspender e Standby não funcionam</title>
   <para>
    Os sistemas ACPI podem ter problemas com suspender e standby devido a falha na implementação de DSDT (BIOS). Se esse for o seu caso, atualize o BIOS.
   </para>
   <para>
    Quando o sistema tenta descarregar módulos defeituosos, o sistema é verificado ou o evento suspenso não é acionado. O mesmo também pode acontecer se você não descarregar módulos ou interromper serviços que impeçam uma suspensão bem-sucedida. Em ambos os casos, tente identificar o módulo defeituoso que impediu o modo adormecido. O arquivo de registro <filename>/var/log/pm-suspend.log</filename> contém informações detalhadas sobre o que está ocorrendo e onde estão os erros possíveis. Modifique a variável <systemitem>SUSPEND_MODULES</systemitem> em <filename>/usr/lib/pm-utils/defaults</filename> para descarregar os módulos com problema antes de efetuar suspensão ou standby.
   </para>
  </sect2>
 </sect1>
 <sect1 id="sec-powersave-info">
  <title>Para obter mais informações</title>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <ulink url="http://en.opensuse.org/SDB:Suspend_to_RAM"/>: Como fazer o recurso Suspender para RAM funcionar
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://old-en.opensuse.org/Pm-utils"/>: Como modificar a metodologia geral de suspensão
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
