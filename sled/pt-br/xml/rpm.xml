<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE sect1
[
   <!ENTITY % entities SYSTEM "entity-decl.ent">
   %entities;
]>


<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="rpm.xml" xml:id="sec-rpm">
 <title>RPM — o gerenciador de pacotes</title><indexterm xml:id="idx-RPM" class="startofrange"> <primary>RPM</primary> </indexterm> <indexterm> <primary>pacotes</primary> <secondary>RPMs</secondary> </indexterm> <indexterm> <primary>pacotes</primary> <secondary>gerenciador de pacotes</secondary> </indexterm> <indexterm> <primary>comandos</primary> <secondary>rpm</secondary> </indexterm>

 <para>
  O RPM (gerenciador de pacotes RPM) é usado para gerenciar pacotes de software. Seus principais comandos são <command>rpm</command> e <command>rpmbuild</command>. O banco de dados RPM avançado pode ser consultado pelos usuários, administradores de sistema e construtores de pacotes para obtenção de informações detalhadas sobre o software instalado.
 </para><indexterm> <primary>rpmbuild</primary> </indexterm> <indexterm> <primary>comandos</primary> <secondary>rpmbuild</secondary> </indexterm>

 <para>
  Basicamente, o <command>rpm</command> possui cinco modos: instalação, desinstalação (ou atualização) de pacotes de software, reconstrução do banco de dados RPM, consulta de bancos RPM ou arquivos RPM individuais, verificação de integridade dos pacotes e assinatura de pacotes. O <command>rpmbuild</command> pode ser usado para construir pacotes instaláveis de fontes originais.
 </para>

 <para>
  Os arquivos RPM instaláveis são compactados em um formato binário especial. Esses são arquivos de programa para instalação e determinadas metainformações usadas durante a instalação pelo comando <command>rpm</command> para configurar o pacote de softwares. Também são armazenados no banco de dados RPM com o objetivo de documentação. Os arquivos RPM normalmente têm a extensão <filename>.rpm</filename>.
 </para><indexterm> <primary>pacotes</primary> <secondary>LSB</secondary> </indexterm> <indexterm><primary>LSB</primary> <secondary>instalando pacotes</secondary> </indexterm>

 <tip>
  <title>pacotes de desenvolvimento de software</title>
  <para>
   Para vários pacotes, os componentes necessários para o desenvolvimento de software (bibliotecas, cabeçalhos, arquivos de inclusão etc.) foram colocados em pacotes separados. Esses pacotes de desenvolvimento só são necessários quando você deseja compilar software por conta própria (por exemplo, os pacotes do GNOME mais recentes). É possível identificá-los pela extensão do nome <literal>-devel</literal>, como os pacotes <systemitem class="resource">alsa-devel</systemitem>, <systemitem class="resource">gimp-devel</systemitem> e <systemitem class="resource">libkde4-devel</systemitem>.
  </para>
 </tip>

 <section xml:id="sec-rpm-package-auth">
  <title>Verificando a autenticidade do pacote</title><indexterm> <primary>RPM</primary> <secondary>verificando</secondary> </indexterm> <indexterm> <primary>pacotes</primary> <secondary>verificando</secondary> </indexterm>
  <para>
   Os pacotes RPM têm uma assinatura GPG. Para verificar a assinatura de um pacote RPM, use o comando <command>rpm --checksig </command> <replaceable>pacote</replaceable>-1.2.3.rpm para determinar se o pacote vem da Novell/SUSE ou de outra empresa confiável. Isso é especialmente recomendado para pacotes de atualização da Internet. 
  </para>
 </section>

 <section xml:id="sec-rpm-packages-manage">
  <title>Gerenciando pacotes: instalar, atualizar e desinstalar</title><indexterm> <primary>instalando</primary> <secondary>pacotes</secondary> </indexterm> <indexterm> <primary>pacotes</primary> <secondary>instalando</secondary> </indexterm> <indexterm> <primary>pacotes</primary> <secondary>desinstalando</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>rpmorig</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>rpmsave</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>rpmnew</secondary> </indexterm>
  <para>
   Normalmente, a instalação de um arquivo RPM é bem simples: <command>rpm -i</command> <replaceable>pacote</replaceable>.rpm. Com esse comando, o pacote é instalado, mas apenas quando suas dependências são atendidas e quando não há conflitos com outros pacotes. Com uma mensagem de erro, o <command>rpm</command> solicita os pacotes que devem ser instalados para atender a requisitos de dependência. No segundo plano, o banco de dados RPM garante que não haja conflitos, pois um arquivo específico pode pertencer somente a um pacote. Ao escolher opções diferentes, você pode forçar o <command>rpm</command> a ignorar esses padrões, mas isso é somente para especialistas. Caso contrário, você se arrisca a comprometer a integridade do sistema e, possivelmente, ameaça a capacidade de atualização do sistema.
  </para><indexterm> <primary>RPM</primary> <secondary>dependências</secondary> </indexterm>
  <para>
   As opções <option>-U</option> ou <option>--upgrade</option> e <option>-F</option> ou <option>--freshen</option> podem ser usadas para atualizar um pacote (por exemplo, <command>rpm -F</command> <replaceable>pacote</replaceable>.rpm). Esse comando remove os arquivos da versão antiga e instala os novos arquivos imediatamente. A diferença entre as duas versões é que o <option>-U</option> instala pacotes que não existiam no sistema anteriormente, mas <option>-F</option> atualiza somente pacotes previamente instalados. Durante a atualização, o <command>rpm</command> atualiza arquivos de configuração cuidadosamente com a seguinte estratégia:
  </para><indexterm> <primary>RPM</primary> <secondary>atualizando</secondary> </indexterm>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     Se um arquivo de configuração não tiver sido modificado pelo administrador de sistema, o <command>rpm</command> instalará a nova versão do arquivo apropriado. O administrador de sistema não precisa adotar nenhuma ação.
    </para>
   </listitem>
   <listitem>
    <para>
     Se um arquivo de configuração tiver sido mudado pelo administrador do sistema antes da atualização, o <command>rpm</command> gravará o arquivo mudado com a extensão <filename>.rpmorig</filename> ou <filename>.rpmsave</filename> (arquivo de backup) e instalará a versão do novo pacote (mas somente se o arquivo instalado originalmente e a versão mais nova forem diferentes). Nesse caso, compare o arquivo de backup (<filename>.rpmorig</filename> ou <filename>.rpmsave</filename>) com o arquivo recém-instalado e faça novamente as modificações no novo arquivo. Depois, verifique se apagou todos os arquivos <filename>.rpmorig</filename> e <filename>.rpmsave</filename> para evitar problemas em atualizações futuras.
    </para>
   </listitem>
   <listitem>
    <para>
     Arquivos<filename>.rpmnew</filename> são exibidos se o arquivo de configuração já existir <emphasis>e</emphasis> se o rótulo <option>noreplace</option> tiver sido especificado no arquivo <filename>.spec</filename>.
    </para>
   </listitem>
  </itemizedlist>
  <para>
   Após uma atualização, os arquivos <filename>.rpmsave</filename> e <filename>.rpmnew</filename> devem ser removidos depois de comparados, para que não impeçam atualizações futuras. A extensão <filename>.rpmorig</filename> será atribuída se o arquivo não tiver sido previamente reconhecido pelo banco de dados RPM.
  </para>
  <para>
   Caso contrário, o <filename>.rpmsave</filename> será usado. Em outras palavras, o <filename>.rpmorig</filename> resulta da atualização de um formato estranho ao RPM. <filename>O .rpmsave</filename> resulta da atualização de um RPM mais antigo para um RPM mais novo. <filename>O .rpmnew</filename> não revela se o administrador do sistema fez mudanças no arquivo de configuração. Uma lista destes arquivos está disponível em <filename>/var/adm/rpmconfigcheck</filename>. Alguns arquivos de configuração (como <filename>/etc/httpd/httpd.conf</filename>) não são sobregravados para permitir operação continuada.
  </para>
  <para>
   O switch <option>-U</option> <emphasis>não</emphasis> é somente um equivalente para a desinstalação com a opção <option>-e</option> e a instalação com a opção <option>-i</option>. Use <option>-U</option> sempre que possível.
  </para>
  <para>
   Para remover um pacote, digite <command>rpm -e</command> <replaceable>pacote</replaceable>. <command>O rpm</command>, que só apaga o pacote quando não há dependências não resolvidas. É teoricamente impossível apagar Tcl/Tk, por exemplo, enquanto outro aplicativo exigir sua existência. Mesmo nesse caso, o RPM pede ajuda do banco de dados. Se, por qualquer motivo, a exclusão for impossível (mesmo que não exista <emphasis>nenhuma</emphasis> dependência adicional), talvez seja útil reconstruir o banco de dados RPM usando a opção <option>--rebuilddb</option>.
  </para><indexterm> <primary>RPM</primary> <secondary>desinstalando</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>banco de dados</secondary> <tertiary>reconstruindo</tertiary> </indexterm>
 </section>

 <section xml:id="sec-rpm-patches">
  <title>RPM e patches</title><indexterm> <primary>RPM</primary> <secondary>patches</secondary> </indexterm>
  <para>
   Para garantir a segurança operacional de um sistema, pacotes de atualização devem ser instalados no sistema periodicamente. Anteriormente, um erro em um pacote só poderia ser eliminado com a substituição de todo o pacote. Pacotes grandes com bugs em pequenos arquivos podem resultar facilmente nesse cenário. Porém, o RPM do SUSE oferece um recurso que permite a instalação de patches em pacotes.
  </para>
  <para>
   Como exemplo, as considerações mais importantes são demonstradas com <command>pine</command>:
  </para>
  <variablelist>
   <varlistentry>
    <term>O RPM com patch é adequado para meu sistema?</term>
    <listitem>
     <para>
      Para verificar isso, consulte primeiro a versão instalada do pacote. No caso do <command>pine</command>, isso pode ser feito com
     </para>
<screen>rpm -q pine
pine-4.44-188</screen>
     <para>
      Em seguida, verifique se o RPM com patch é adequado para essa versão do <command>pine</command>:
     </para>
<screen>rpm -qp --basedon pine-4.44-224.i586.patch.rpm
pine = 4.44-188
pine = 4.44-195
pine = 4.44-207</screen>
     <para>
      Esse patch é adequado para três versões diferentes do pine. A versão instalada no exemplo também está listada para que o patch possa ser instalado.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Quais arquivos serão substituídos pelo patch?</term>
    <listitem>
     <para>
      Os arquivos afetados por um patch podem ser facilmente vistos no RPM com patch. O parâmetro <command>rpm</command><option>-P permite a seleção de recursos de patch especiais. </option> Exiba a lista de arquivos com o seguinte comando:
     </para>
<screen>rpm -qpPl pine-4.44-224.i586.patch.rpm
/etc/pine.conf
/etc/pine.conf.fixed
/usr/bin/pine</screen>
     <para>
      ou, se o patch já estiver instalado, com o seguinte comando:
     </para>
<screen>rpm -qPl pine
/etc/pine.conf
/etc/pine.conf.fixed
/usr/bin/pine</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Como instalar um RPM com patch no sistema?</term>
    <listitem>
     <para>
      RPMs com patch são usados como RPMs comuns. A única diferença é que um RPM adequado já deve estar instalado.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>
     Quais patches já estão instalados no sistema e para quais versões do pacote?
    </term>
    <listitem>
     <para>
      É possível exibir uma lista de todos os patches instalados no sistema com o comando <command>rpm</command> <option>-qPa</option>. Se somente um patch for instalado em um novo sistema (como no exemplo), a lista será exibida como a seguir:
     </para>
<screen>rpm -qPa
pine-4.44-224</screen>
     <para>
      Se posteriormente você desejar saber qual versão de pacote foi originalmente instalada, essas informações também estarão disponíveis no banco de dados RPM. No caso do <command>pine</command>, é possível exibir essas informações com o seguinte comando:
     </para>
<screen>rpm -q --basedon pine
pine = 4.44-188</screen>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   Mais informações, incluindo informações sobre o recurso de patch do RPM, estão disponíveis nas páginas de manual de <command>rpm</command> e <command>rpmbuild</command>.
  </para>
  <note>
   <title>Atualizações oficiais para o <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase></title>
   <para>
    Para que o tamanho do download das atualizações seja o menor possível, as atualizações oficiais para o <phrase role="productname"><phrase os="sled">SUSE Linux Enterprise Desktop</phrase></phrase> não são fornecidas como RPMs de Patch, mas sim como pacotes RPM Delta. Para obter os detalhes, consulte a <xref linkend="sec-rpm-delta"/>.
   </para>
  </note>
 </section>

 <section xml:id="sec-rpm-delta">
  <title>Pacotes RPM Delta</title><indexterm> <primary>RPM</primary> <secondary>deltarpm</secondary> </indexterm> <indexterm> <primary>deltarpm</primary> </indexterm>
  <para>
   Os pacotes RPM Delta possuem uma diferença entre uma versão nova e antiga de um pacote RPM. Aplicar um RPM delta a um RPM antigo resulta em um RPM completamente novo. Não é necessário ter uma cópia do RPM antigo, pois um RPM delta também pode funcionar com um RPM instalado. Os pacotes RPM delta têm tamanho ainda menor que os RPMs com patch, o que é uma vantagem durante a transferência de pacotes de atualização na Internet. A desvantagem é que operações de atualização que envolvem RPMs delta consomem consideravelmente mais ciclos de CPU do que as operações com RPMs com patch ou simples.
  </para>
  <para>
   Os binários <command>prepdeltarpm</command>, <command>writedeltarpm</command> e <command>applydeltarpm</command> integram a suíte de RPM delta (pacote <systemitem>deltarpm</systemitem>) e ajudam na criação e aplicação de pacotes RPM delta. Com os seguintes comandos, crie um RPM delta chamado <filename>new.delta.rpm</filename>. O comando a seguir pressupõe que <filename>old.rpm</filename> e <filename>new.rpm</filename> estejam presentes:
  </para>
<screen>prepdeltarpm -s seq -i info old.rpm &gt; old.cpio
prepdeltarpm -f new.rpm &gt; new.cpio
xdelta delta -0 old.cpio new.cpio delta
writedeltarpm new.rpm delta info new.delta.rpm</screen>
  <para>
   Por fim, remova os arquivos de trabalho temporários <filename>old.cpio</filename>, <filename>new.cpio</filename> e <filename>delta</filename>.
  </para>
  <para>
   Usando <command>applydeltarpm</command>, você poderá reconstruir o novo RPM do arquivo de sistema, se o pacote antigo já estiver instalado:
  </para>
<screen>applydeltarpm new.delta.rpm new.rpm</screen>
  <para>
   Para derivá-lo do RPM antigo sem acessar o sistema de arquivos, use a opção <option>-r</option>:
  </para>
<screen>applydeltarpm -r old.rpm new.delta.rpm new.rpm</screen>
  <para>
   Consulte <filename>/usr/share/doc/packages/deltarpm/README</filename> para obter os detalhes técnicos.
  </para>
 </section>

 <section xml:id="sec-rpm-query">
  <title>Consultas de RPM</title><indexterm> <primary>RPM</primary> <secondary>consultas</secondary> </indexterm>
  <para>
   Com a opção <option>-q</option>, o <command>rpm</command> inicia consultas, permitindo a inspeção de um arquivo RPM (adicionando-se a opção <option>-p</option>) e também a consulta ao banco de dados RPM de pacotes instalados. Vários switches estão disponíveis para especificar o tipo de informação necessária. Consulte a <xref linkend="tab-rpm-query"/>.
  </para>
  <table xml:id="tab-rpm-query">
   <title>Opções mais importantes de consulta de RPM</title>
   <tgroup cols="2">
    <tbody>
     <row>
      <entry>
       <para>
        <option>-i</option>
       </para>
      </entry>
      <entry>
       <para>
        Informações de pacote
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-l</option>
       </para>
      </entry>
      <entry>
       <para>
        Lista de arquivos
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-f ARQUIVO</option>
       </para>
      </entry>
      <entry>
       <para>
        Consulte o pacote que contém o arquivo <replaceable>ARQUIVO</replaceable> (o caminho completo deve ser especificado com <replaceable>ARQUIVO</replaceable>)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-s</option>
       </para>
      </entry>
      <entry>
       <para>
        Lista de arquivos com informações de status (requer <option>-l</option>)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-d</option>
       </para>
      </entry>
      <entry>
       <para>
        Lista somente arquivos de documentação (requer <literal>-l</literal>)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-c</option>
       </para>
      </entry>
      <entry>
       <para>
        Lista somente arquivos de configuração (requer <option>-l</option>)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--dump</option>
       </para>
      </entry>
      <entry>
       <para>
        Lista de arquivos com detalhes completos (a ser usada com <option>-l</option>, <option>-c</option> ou <option>-d</option>)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--provides</option>
       </para>
      </entry>
      <entry>
       <para>
        Lista recursos do pacote que outro pacote pode solicitar com <option>--requires</option>
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--requires</option>, <option>-R</option>
       </para>
      </entry>
      <entry>
       <para>
        Recursos exigidos pelo pacote
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--scripts</option>
       </para>
      </entry>
      <entry>
       <para>
        Scripts de instalação (pré-instalação, pós-instalação, desinstalação)
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <para>
   Por exemplo, o comando <command>rpm -q -i wget</command> exibe as informações mostradas no <xref linkend="aus-update-rpm-i"/>.
  </para>
  <example xml:id="aus-update-rpm-i">
   <title>rpm -q -i wget</title>
<screen>Name        : wget                         Relocations: (not relocatable)
Version     : 1.11.4                            Vendor: openSUSE
Release     : 1.70                          Build Date: Sat 01 Aug 2009 09:49:48 CEST
Install Date: Thu 06 Aug 2009 14:53:24 CEST      Build Host: build18
Group       : Productivity/Networking/Web/Utilities   Source RPM: wget-1.11.4-1.70.src.rpm
Size        : 1525431                          License: GPL v3 or later
Signature   : RSA/8, Sat 01 Aug 2009 09:50:04 CEST, Key ID b88b2fd43dbdc284
Packager    : http://bugs.opensuse.org
URL         : http://www.gnu.org/software/wget/
Summary     : A Tool for Mirroring FTP and HTTP Servers
Description :
Wget enables you to retrieve WWW documents or FTP files from a server.
This can be done in script files or via the command line.
[...]</screen>
  </example>
  <para>
   A opção <option>-f</option> funciona somente se você especificar o nome e o caminho completos do arquivo. Forneça quantos nomes de arquivo desejar. Por exemplo, o seguinte comando
  </para>
<screen>rpm -q -f /bin/rpm /usr/bin/wget</screen>
  <para>
   resulta em:
  </para>
<screen>rpm-4.8.0-4.3.x86_64
wget-1.11.4-11.18.x86_64</screen>
  <para>
   Se somente parte do nome de arquivo for conhecida, use um script de shell conforme mostrado no <xref linkend="dat-rpm-search"/>. Passe o nome de arquivo parcial para o script mostrado como um parâmetro ao executá-lo.
  </para>
  <example xml:id="dat-rpm-search">
   <title>Script para pesquisar pacotes</title>
<screen>#! /bin/sh
for i in $(rpm -q -a -l | grep $1); do
    echo "\"$i\" is in package:"
    rpm -q -f $i
    echo ""
done</screen>
  </example>
  <para>
   O comando <command>rpm -q --changelog rpm</command> exibe uma lista detalhada com as informações de modificações sobre determinado pacote (neste caso, o pacote <literal>rpm</literal>), classificadas por data.

  </para>
  <para>
   Com a ajuda do banco de dados RPM instalado, é possível realizar verificações. Inicie as verificações com <option>-V</option>, <option>-y</option> ou <option>--verify</option>. Com essa opção, o <command>rpm</command> mostra todos os arquivos em um pacote que foram modificados desde a instalação. O <command>rpm</command> usa oito símbolos de caracteres para fornecer algumas dicas sobre as seguintes mudanças:
  </para><indexterm> <primary>RPM</primary> <secondary>verificar</secondary> </indexterm>
  <table xml:id="tab-rpm-verify">
   <title>Opções de verificação do RPM</title>
   <tgroup cols="2">
    <tbody>
     <row>
      <entry>
       <para>
        <option>5</option>
       </para>
      </entry>
      <entry>
       <para>
        Resumo de verificação MD5
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>S</option>
       </para>
      </entry>
      <entry>
       <para>
        Tamanho do arquivo
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>L</option>
       </para>
      </entry>
      <entry>
       <para>
        Link simbólico
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>T</option>
       </para>
      </entry>
      <entry>
       <para>
        Tempo de modificação
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>D</option>
       </para>
      </entry>
      <entry>
       <para>
        Números de dispositivo principais e auxiliares
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>U</option>
       </para>
      </entry>
      <entry>
       <para>
        Proprietário
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>C</option>
       </para>
      </entry>
      <entry>
       <para>
        Grupo
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>M</option>
       </para>
      </entry>
      <entry>
       <para>
        Modo (tipo de arquivo e permissões)
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <para>
   No caso de arquivos de configuração, a letra <option>c</option> é impressa. Por exemplo, para modificações no pacote <filename>/etc/wgetrc</filename> (<systemitem class="resource">wget</systemitem>):
  </para>
<screen>rpm -V wget
S.5....T c /etc/wgetrc</screen>
  <para>
   Os arquivos do banco de dados RPM são colocados em <filename>/var/lib/rpm</filename>. Se a partição <filename>/usr</filename> tiver o tamanho de 1 GB, esse banco de dados poderá ocupar praticamente 30 MB, especialmente após uma atualização completa. Se o banco de dados for maior do que o esperado, será útil reconstruir o banco de dados com a opção <option>--rebuilddb</option>. Antes disso, faça um backup do banco de dados antigo. O script <command>cron</command> <command>cron.daily</command> faz cópias diárias do banco de dados (compactado com gzip) e as armazena em <filename>/var/adm/backup/rpmdb</filename>. O número de cópias é controlado pela variável <systemitem>MAX_RPMDB_BACKUPS</systemitem> (padrão: <option>5</option>) em <filename>/etc/sysconfig/backup</filename>. O tamanho de um único backup é de aproximadamente 1 MB para 1 GB em <filename>/usr</filename>.
  </para><indexterm> <primary>RPM</primary> <secondary>banco de dados</secondary> <tertiary>reconstruindo</tertiary> </indexterm>
 </section>

 <section xml:id="sec-rpm-sources">
  <title>Instalando e compilando pacotes de fonte</title><indexterm> <primary>pacotes</primary> <secondary>compilando</secondary> </indexterm> <indexterm> <primary>fonte</primary> <secondary>compilando</secondary> </indexterm> <indexterm> <primary>software</primary> <secondary>compilando</secondary> </indexterm> <indexterm> <primary>spm</primary> </indexterm>
  <para>
   Todos os pacotes de fonte têm a extensão <filename>.src.rpm</filename> (RPM de fonte).
  </para>
  <note>
   <title>Pacotes de fontes instalados</title>
   <para>
    Pacotes de fonte podem ser copiados da mídia de instalação para o disco rígido e descompactados com o YaST. Porém, eles não são marcados como instalados (<literal>[i]</literal>) no gerenciador de pacotes. Isso ocorre porque os pacotes de fontes não são inseridos no banco de dados RPM. Somente o software do sistema operacional <emphasis>instalado</emphasis> está listado no banco de dados RPM. Quando você <quote>instalar</quote> um pacote de fontes, somente o código-fonte será adicionado ao sistema.
   </para>
  </note>
  <para>
   Os diretórios a seguir devem estar disponíveis para <command>rpm</command> e <command>rpmbuild</command> em <filename>/usr/src/packages</filename> (a menos que você tenha especificado configurações personalizadas em um arquivo como <filename>/etc/rpmrc</filename>):
  </para>
  <variablelist>
   <varlistentry>
    <term><filename>SOURCES</filename>
    </term>
    <listitem>
     <para>
      para as fontes originais (arquivos <filename>.tar.bz2</filename> ou <filename>.tar.gz</filename> etc.) e para ajustes específicos de distribuição (geralmente arquivos <filename>.diff</filename> ou <filename>.patch</filename>)
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>SPECS</filename>
    </term>
    <listitem>
     <para>
      para os arquivos <filename>.spec</filename>, similares a um metaMakefile, que controla o processo de <emphasis>construção</emphasis>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>BUILD</filename>
    </term>
    <listitem>
     <para>
      diretório em que todas as fontes são descompactadas, corrigidas e compiladas
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>RPMS</filename>
    </term>
    <listitem>
     <para>
      local em que os pacotes binários concluídos são armazenados
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>SRPMS</filename> <indexterm> <primary>RPM</primary> <secondary>SRPMS</secondary> </indexterm></term>
    <listitem>
     <para>
      local em que estão os RPMs de fonte
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   Quando você instala um pacote de fontes com o YaST, todos os componentes necessários são instalados em <filename>/usr/src/packages</filename>: as fontes e os ajustes em <filename>SOURCES</filename> e o arquivo <filename>.spec</filename> relevante em <filename>SPECS</filename>.
  </para>
  <warning>
   <para>
    Não faça experiências com os componentes do sistema (<systemitem class="resource">glibc</systemitem>, <systemitem class="resource">rpm</systemitem>, <systemitem class="resource">sysvinit</systemitem> etc.), pois isso arrisca a estabilidade do sistema.
   </para>
  </warning>
  <para>
   O exemplo a seguir usa o pacote <filename>wget.src.rpm. </filename> Após instalar o pacote de origem, você deverá ter arquivos semelhantes aos da seguinte lista:
  </para>
<screen>/usr/src/packages/SOURCES/wget-1.11.4.tar.bz2
/usr/src/packages/SOURCES/wgetrc.patch
/usr/src/packages/SPECS/wget.spec</screen>
  <para>
   <command>rpmbuild -b</command> <replaceable>X</replaceable> /usr/src/packages/SPECS/wget.spec inicia a compilação. <replaceable>X</replaceable> é um curinga para vários estágios do processo de construção (consulte a saída de <option>--help</option> ou a documentação do RPM para obter os detalhes). Veja a seguir uma breve explicação:
  </para>
  <variablelist>
   <varlistentry>
    <term><option>-bp</option>
    </term>
    <listitem>
     <para>
      Preparar as fontes em <filename>/usr/src/packages/BUILD</filename>: descompactar e corrigir.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-bc</option>
    </term>
    <listitem>
     <para>
      Faz o mesmo que <option>-bp</option>, mas com compilação adicional.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-bi</option>
    </term>
    <listitem>
     <para>
      Faz o mesmo que <option>-bp</option>, mas com a instalação adicional do software criado. Cuidado: se o pacote não aceitar o recurso BuildRoot, talvez você sobregrave os arquivos de configuração.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-bb</option>
    </term>
    <listitem>
     <para>
      Faz o mesmo que <option>-bi</option>, mas com a criação adicional do pacote binário. Se a compilação tiver sido bem-sucedida, o binário deverá estar em <filename>/usr/src/packages/RPMS</filename>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-ba</option>
    </term>
    <listitem>
     <para>
      Faz o mesmo que <option>-bb</option>, mas com a criação adicional do RPM de fonte. Se a compilação tiver sido bem-sucedida, o binário deverá estar em <filename>/usr/src/packages/SRPMS</filename>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>--short-circuit</option>
    </term>
    <listitem>
     <para>
      Ignora algumas etapas.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   O RPM binário criado agora pode ser instalado com <command>rpm</command> <option>-i</option> ou, de preferência, com <command>rpm</command> <option>-U</option>. A instalação com <command>rpm</command> faz com que ele apareça no banco de dados RPM.
  </para>
 </section>

 <section xml:id="sec-rpm-build">
  <title>Compilando pacotes RPM com build</title><indexterm> <primary>pacotes</primary> <secondary>compilando com build</secondary> </indexterm>
  <para>
   O perigo de vários pacotes é que arquivos indesejados são adicionados ao sistema em execução durante o processo de construção. Para evitar isso, use <systemitem>build</systemitem>, que cria um ambiente definido para construção do pacote. Para estabelecer esse ambiente chroot, o script <command>build</command> deve ser fornecido com uma árvore de pacote completa. Essa árvore pode ser disponibilizada no disco rígido, por meio do NFS ou DVD. Defina a posição com <command>build --rpms</command> <replaceable>diretório</replaceable>. Diferentemente do <command>rpm</command>, o comando <command>build</command> procura o arquivo <filename>.spec</filename> no diretório de fontes. Para construir o <filename>wget</filename> (como no exemplo acima) com o DVD montado no sistema em <filename>/media/dvd</filename>, use o seguinte comando como <systemitem class="username">root</systemitem>:
  </para>
<screen>cd /usr/src/packages/SOURCES/
mv ../SPECS/wget.spec .
build --rpms /media/dvd/suse/ wget.spec</screen>
  <para>
   Depois disso, um ambiente mínimo é estabelecido em <filename>/var/tmp/build-root</filename>. O pacote é criado nesse ambiente. Após a conclusão, os pacotes resultantes estarão localizados em <filename>/var/tmp/build-root/usr/src/packages/RPMS</filename>.
  </para>
  <para>
   O script <command>build</command> oferece várias opções adicionais. Por exemplo, fazer com que o script prefira seus próprios RPMs, omitir a inicialização do ambiente de construção ou limitar o comando <command>rpm</command> a um dos estágios mencionados acima. Acesse informações adicionais com <command>build</command> <option>--help</option> e a leitura da página de manual <command>build</command>.
  </para>
 </section>

 <section xml:id="sec-rpm-tools">
  <title>Ferramentas para arquivos RPM e banco de dados RPM</title><indexterm> <primary>RPM</primary> <secondary>ferramentas</secondary> </indexterm>
  <para>
   O Midnight Commander (<command>mc</command>) pode exibir o conteúdo de arquivos RPM e copiar partes deles. Ele representa arquivos como sistemas de arquivos virtuais, oferecendo todas as opções de menu usuais do Midnight Commander. Exiba o <filename>HEADER</filename> com <keycap>F3</keycap>. Exiba a estrutura de arquivos com as teclas de cursor e <keycap>Enter</keycap>. Copie componentes de arquivos com <keycap>F5</keycap>.
  </para>
  <para>


   Um gerenciador de pacote completo está disponível como um módulo do YaST. Para obter os detalhes, consulte o <xref linkend="cha-y2-sw"/>.
  </para><indexterm class="endofrange" startref="idx-RPM"/>

 </section>
</section>
