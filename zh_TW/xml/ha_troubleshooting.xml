<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="ha_troubleshooting.xml" id="app.ha.troubleshooting">
 <title>疑難排解</title>
 <abstract>
  <para>
   當出現奇怪的現象時，使用者可能會搞不清楚狀況，尤其是剛剛開始使用 High Availability 的使用者。不過，您可以借助幾個公用程式來深入瞭解 High Availability 的內部程序。本章推薦了各種解決方案。
  </para>
 </abstract>
 <sect1 id="sec.ha.troubleshooting.install">
  <title>安裝和前期階段的步驟</title>

  <para>
   疑難排解安裝套件或使叢集上線時所遇到的問題。
  </para>

  <variablelist>
   <varlistentry>
    <term>是否已安裝 HA 套件？</term>
    <listitem>
     <para>
      設定和管理叢集所需的套件包含於<literal>高可用性</literal>安裝模式中，隨 High Availability Extension 一起提供。
     </para>
     <para>
      請檢查 High Availability Extension 是否已在各叢集節點上安裝為 SUSE Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">11 SP4</phrase></phrase> 的附加產品，以及<guimenu>高可用性</guimenu>模式是否已依<xref linkend="sec.ha.installation.add-on"/> 所述安裝於各機器上。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>所有叢集節點的初始組態是否都相同？</term>
    <listitem>
     <para>
      為了能夠相互通訊，屬於同一叢集的所有節點均需使用相同的 <literal>bindnetaddr</literal>、<literal>mcastaddr</literal> 與 <literal>mcastport</literal>，如<xref linkend="sec.ha.installation.setup.manual"/> 中所述。
     </para>
     <para>
      請檢查 <filename>/etc/corosync/corosync.conf</filename> 中為所有叢集節點設定的通訊通道與選項是否都相同。
     </para>
     <para>
      若使用加密通訊，請檢查是否所有叢集節點上的 <filename>/etc/corosync/authkey</filename> 檔案都可使用。
     </para>
     <para>
      除 <literal>nodeid</literal> 以外的所有 <filename>corosync.conf</filename> 設定都必須相同；所有節點上的 <filename>authkey</filename> 檔案都必須相同。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>防火牆允許透過 <literal>mcastport</literal> 進行通訊嗎？</term>
    <listitem>
     <para>
      若用於在各叢集節點間通訊的 mcastport 被防火牆阻擋，這些節點將無法相互查看。依照<xref linkend="sec.ha.installation.setup.manual"/>和<xref linkend="sec.ha.installation.setup.auto"/>所述使用 YaST 或開機程序檔進行初始設定時，防火牆設定通常會自動進行調整。
     </para>
     <para>
      若要確保 mcastport 不被防火牆阻擋，請檢查各節點上 <filename>/etc/sysconfig/SuSEfirewall2</filename> 中的設定。或者，啟動各叢集節點上的 YaST 防火牆模組。按一下<menuchoice><guimenu>允許的服務</guimenu> <guimenu>進階</guimenu></menuchoice>之後，將 mcastport 新增至允許的<guimenu>UDP 埠</guimenu>清單，然後確認變更。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>各叢集節點上是否啟動了 OpenAIS？</term>
    <listitem>
     <para>
      使用 <command>/etc/init.d/openais status</command> 檢查各叢集節點上的 OpenAIS 狀態。若 OpenAIS 沒有執行，則透過執行 <command>/etc/init.d/openais start</command> 將其啟動。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.ha.troubleshooting.log">
  <title>記錄</title>

  <variablelist>
   <varlistentry>
    <term>我已啟用監控，但為何記錄檔案中沒有監控操作的追蹤資訊？</term>
    <listitem>
     <para>
      除非有錯誤發生，否則 <systemitem class="daemon">lrmd</systemitem> 精靈不會記錄週期性的監控操作。記錄所有週期性操作會產生太多干擾。因此，該精靈只會每小時記錄一次週期性監控操作。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>我只收到一則<literal>失敗</literal>訊息。能取得詳細資訊嗎？</term>
    <listitem>
     <para>
      請將 <literal>--verbose</literal> 參數新增至您的指令。若多次執行此操作，將產生非常詳細的除錯輸出。請參閱 <filename>/var/log/messages</filename> 中提供的有用提示。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>如何取得所有節點和資源的綜覽？</term>
    <listitem>
     <para>
      請使用 <command>crm_mon</command> 指令。以下指令將顯示資源操作歷程 (選項 <option>-o</option>) 和非使用中資源 (<option>-r</option>)：
     </para>
<screen><prompt role="root">root # </prompt><command>crm_mon</command> -o -r</screen>
     <para>
      狀態變更時，顯示畫面會重新整理 (若要取消此功能，請按 <keycombo> <keycap function="control"/> <keycap>C</keycap> </keycombo>)。範例顯示內容如下：
     </para>
     <example>
      <title>停止的資源</title>
<screen>Last updated: Fri Aug 15 10:42:08 2014
Last change: Fri Aug 15 10:32:19 2014
 Stack: corosync
Current DC: bob (175704619) - partition with quorum
Version: 1.1.12-ad083a8
2 Nodes configured
3 Resources configured
       
Online: [ alice bob ]
       
Full list of resources:
       
my_ipaddress    (ocf::heartbeat:Dummy): Started barett-2
my_filesystem   (ocf::heartbeat:Dummy): Stopped
my_webserver    (ocf::heartbeat:Dummy): Stopped
       
Operations:
* Node bob: 
    my_ipaddress: migration-threshold=3
      + (14) start: rc=0 (ok)
      + (15) monitor: interval=10000ms rc=0 (ok)
      * Node alice:</screen>
     </example>
     <para>
      <ulink url="http://www.clusterlabs.org/doc/"/> 上《<citetitle>Pacemaker Explained</citetitle>》(Pacemaker 說明) PDF 檔案中的「<citetitle>How are OCF Return Codes Interpreted?</citetitle>」(如何解譯 OCF 傳回代碼？) 一節介紹了三種不同的復原類型。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry id="vle.ha.crm_report">
    
    <term>如何建立一份包含所有叢集節點分析資訊的報告？</term>
    <listitem>
     <para>
      在 crm 外圍程序中，使用 <command>crm_report</command> 或 <command>hb_report</command> 建立報告。這些工具用於編譯：
     </para>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>
        整個叢集的記錄檔案
       </para>
      </listitem>
      <listitem>
       <para>
        套件狀態
       </para>
      </listitem>
      <listitem>
       <para>
        DLM/OCFS2 狀態
       </para>
      </listitem>
      <listitem>
       <para>
        系統資訊,
       </para>
      </listitem>
      <listitem>
       <para>
        CIB 歷程
       </para>
      </listitem>
      <listitem>
       <para>
        磁心傾印報告的剖析結果 (如果已安裝 debuginfo 套件)
       </para>
      </listitem>
     </itemizedlist>
     <para>
      通常情況下需要結合以下指令執行 <command>hb_report</command>：
     </para>
     <screen><prompt role="root">root # </prompt><command>crm_report</command> -f 0:00 -n jupiter -n venus</screen>
     <para>
      該指令會擷取主機 jupiter 和 venus 中從凌晨 0 點開始的所有資訊，並在目前的目錄中建立一個名為 <filename>crm_report-<replaceable>日期</replaceable>.tar.bz2</filename> 的 <literal>*.tar.bz2</literal> 歸檔，例如，<filename>crm_report-Wed-03-Mar-2012</filename>。如果只需要特定時間範圍的資訊，請使用 <option>-t</option> 選項新增結束時間。
     </para>
     <warning>
      <title>移除敏感性資訊</title>
      <para>
       <command>crm_report</command> 工具會嘗試從 CIB 和 peinput 檔案中移除任何敏感性資訊，但它無法做到一切。如果您還有更多敏感性資訊，請提供其他模式。記錄檔案以及 <command>crm_mon</command>、<command>ccm_tool</command> 和 <command>crm_verify</command> 輸出<emphasis>不會</emphasis>被清理。
      </para>
      <para>
       在以任何方式共享您的資料之前，請先檢查歸檔，並移除您不想公開的所有資訊。
      </para>
     </warning>
     <para>
      可以使用其他選項自定指令。例如，如果您有一個 OpenAIS 叢集，那麼您肯定想新增 <option>-A</option> 選項。如果您的另一個使用者有權存取該叢集，請使用 <option>-u</option> 選項並指定此使用者 (不同於 <systemitem class="username">root</systemitem> 和 <systemitem class="username">hacluster</systemitem> 使用者)。如果您有一個非標準 SSH 連接埠，請使用 <option>-X</option> 選項新增該連接埠 (例如，如果連接埠為 3479，則使用 <literal>-X "-p 3479"</literal>)。如需瞭解更多選項，請參閱 <command>crm_report</command> 的 man 頁面。
     </para>
     <para>
      在 <command>crm_report</command> 分析了所有相關記錄檔案並建立了目錄 (或歸檔) 之後，請檢查記錄檔案中是否有大寫的 <literal>ERROR</literal> 字串。報告的上層目錄中最重要的檔案包括：
     </para>
     <variablelist>
      <varlistentry>
       <term><filename>analysis.txt</filename>
       </term>
       <listitem>
        <para>
         比較檔案，所有節點上都應相同。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><filename>crm_mon.txt</filename>
       </term>
       <listitem>
        <para>
         包含 <command>crm_mon</command> 指令的輸出。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><filename>corosync.txt</filename>
       </term>
       <listitem>
        <para>
         包含 Corosync 組態檔案的副本。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term><filename>description.txt</filename>
       </term>
       <listitem>
        <para>
         包含各節點上所有的叢集套件版本。還有一個特定於節點的 <filename>sysinfo.txt</filename> 檔案。它連結至頂層目錄。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <para>
      特定於節點的檔案儲存在以節點名稱命名的子目錄中。
     </para>
    </listitem>
   </varlistentry>
   
  </variablelist>
 </sect1>
 <sect1 id="sec.ha.troubleshooting.resource">
  <title>資源</title>

  <variablelist>
   <varlistentry>
    <term>如何清理我的資源？</term>
    <listitem>
     <para>
      請使用以下指令：
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> resource list
crm resource cleanup <replaceable>rscid</replaceable> [<replaceable>node</replaceable>]</screen>
     <para>
      如果不指定節點，系統會清理所有節點上的資源。如需詳細資訊，請參閱<xref linkend="sec.ha.manual_config.cleanup"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>如何列出目前已知的資源？</term>
    <listitem>
     <para>
      使用指令 <command>crm resource list</command> 即可顯示目前資源。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>我已設定某個資源，但它總是失敗。為什麼？</term>
    <listitem>
     <para>
      若要使用 <command>ocf-tester</command> 檢查 OCF 程序檔，例如︰
     </para>
<screen>ocf-tester -n ip1 -o ip=<replaceable>YOUR_IP_ADDRESS</replaceable> \
  /usr/lib/ocf/resource.d/heartbeat/IPaddr</screen>
     <para>
      若需納入多個參數，可以使用多個 <option>-o</option>。執行 <command>crm</command> <option>ra</option> <option>info</option> <replaceable>代辦</replaceable>，可顯示必需參數和可選參數的清單，指令範例如下︰
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> ra info ocf:heartbeat:IPaddr</screen>
     <para>
      在執行 ocf-tester 之前，請確定該資源不受叢集管理。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>資源為何不容錯移轉，並且為何沒有發生錯誤？</term>
    <listitem>
     <para>
      如果您的叢集是雙節點叢集，則終止其中一個節點，另一個節點仍不能滿足最低節點數要求。除非您將 <option>no-quorum-policy</option> 內容設定為 <literal>ignore</literal>，否則任何事情都不會發生。對於雙節點叢集，您需要：
     </para>
<screen>property no-quorum-policy="ignore"</screen>
     <para>
      另一種可能是，終止的節點被視為未清理節點。如果是這樣，就必須對它進行圍籬區隔。如果 STONITH 資源無法正常運作或者不存在，則另一個節點將會等待發生圍籬區隔。圍籬區隔逾時值通常設定得很大，因此可能經過很長一段時間後才會發生明顯的問題跡象 (如果最終會出現的話)。
     </para>
     <para>
      另外還有一種可能，那就是此節點上不允許執行某個資源。這可能是因為之前曾發生了失敗，而此失敗尚未得到<quote>清理</quote>。或者，可能是之前執行了某個管理動作，即新增了分數為負數的位置條件約束。例如，使用 <command>crm resource migrate</command> 指令插入了這樣的位置條件約束。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>為何我總是無法確定資源的執行位置？</term>
    <listitem>
     <para>
      如果資源不存在位置條件約束，則其投放至的節點 (基本上) 是由系統隨機選擇的。強烈建議您總是為資源指定一個偏好節點。這並不意味著您需要為<emphasis>所有</emphasis>資源指定位置偏好設定。對於一組相關 (並存) 的資源，一個偏好設定就已足夠。節點偏好設定如下所示：
     </para>
<screen>location rsc-prefers-alice rsc 100: alice</screen>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.ha.troubleshooting.stonith">
  <title>STONITH 和圍籬區隔</title>

  <variablelist>
   <varlistentry>
    <term>我的 STONITH 資源為何不啟動？</term>
    <listitem>
     <para>
      啟動 (或啟用) 操作的過程會檢查裝置狀態。如果裝置未就緒，STONITH 資源將無法啟動。
     </para>
     <para>
      此外，系統會要求 STONITH 外掛程式產生一份主機清單。如果此清單為空，則執行 STONITH 資源將毫無意義，因為這無法關閉任何節點。清單中會過濾掉執行 STONITH 的主機名稱，因為節點不能關閉自身。
     </para>
     <para>
      如果您想要使用單主機管理裝置 (如無人職守裝置)，請確認 STONITH 資源<emphasis>不得</emphasis>在應當圍籬區隔的節點上執行。請使用負無限位置節點偏好設定 (條件約束)。叢集會將 STONITH 資源移至另一個可以啟動該資源的位置，但移動前會向您發出通知。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>為何我使用了 STONITH 資源，圍籬區隔仍不發生？</term>
    <listitem>
     <para>
      每個 STONITH 資源必須提供一個主機清單。您可以手動將此清單插入 STONITH 資源組態中，也可以從裝置自身 (例如，從插座名稱) 擷取。這取決於 STONITH 外掛程式的特性。<systemitem>stonithd</systemitem> 使用該清單來確定哪個 STONITH 資源可以圍籬區隔目標節點。僅當目標節點包含在該清單中時，STONITH 資源才會停止 (圍籬區隔) 該節點。
     </para>
     <para>
      如果 <systemitem>stonithd</systemitem> 在 STONITH 資源執行後所提供的任何主機清單中都找不到該節點，它會詢問其他節點上的 <systemitem>stonithd</systemitem> 例項。如果其他 <systemitem>stonithd</systemitem> 例項的主機清單中也未包含目標節點，則圍籬區隔要求最終會在發出要求的節點上逾時。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>為何我的 STONITH 資源有時會失敗？</term>
    <listitem>
     <para>
      如果廣播流量過多，電源管理裝置可能無法回應。請增大監控操作的間隔。假設圍籬區隔在一段時間內只需執行一次 (甚至永遠無需執行)，每隔幾小時檢查一次裝置狀態就已足夠。
     </para>
     <para>
      另外，其中的一些裝置可能拒絕同時與多方通訊。如果叢集嘗試測試狀態時，您將終端機或瀏覽器工作階段保持為開啟狀態，這便可能會產生問題。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.ha.troubleshooting.misc">
  <title>其他</title>

  <variablelist>
   <varlistentry>

    <term>如何在所有叢集節點上執行指令？</term>
    <listitem>
     <para>
      請使用 <command>pssh</command> 指令來完成此項任務。如果需要，請安裝 <systemitem class="resource">pssh</systemitem>。建立一個檔案 (例如 <filename>hosts.txt</filename>)，將您要造訪的所有 IP 位址或主機名稱都收集在其中。確定您可以使用 <command>ssh</command> 登入 <filename>hosts.txt</filename> 檔案中所列的每個主機。如果所有工作均已準備妥當，請依照以下範例執行 <command>pssh</command> 並使用 <filename>hosts.txt</filename> 檔案 (選項 <option>-h</option>) 和互動模式 (選項 <option>-i</option>)：
     </para>
<screen>pssh -i -h hosts.txt "ls -l /corosync/*.conf"
[1] 08:28:32 [SUCCESS] root@venus.example.com
-rw-r--r-- 1 root root 1480 Nov 14 13:37 /etc/corosync/corosync.conf
[2] 08:28:32 [SUCCESS] root@192.168.2.102
-rw-r--r-- 1 root root 1480 Nov 14 13:37 /etc/corosync/corosync.conf</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>我的叢集狀態為何？</term>
    <listitem>
     <para>
      若要查看叢集目前的狀態，請使用程式 <literal>crm_mon</literal> 或 <command>crm</command> <option>status</option>。此時會顯示目前 DC，以及目前節點已知的所有節點與資源。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>為何我叢集中的一些節點看不到彼此？</term>
    <listitem>
     <para>
      導致的原因有多種：
     </para>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>
        請先查看組態檔案 <filename>/etc/corosync/corosync.conf</filename>。檢查叢集內各節點的多路廣播或單點傳播位址是否相同 (使用關鍵字 <literal>mcastaddr</literal> 在 <literal>interface</literal> 區段中尋找)。
       </para>
      </listitem>
      <listitem>
       <para>
        檢查防火牆設定。
       </para>
      </listitem>
      <listitem>
       <para>
        檢查交換器是否支援多路廣播或單點傳播位址。
       </para>
      </listitem>
      <listitem>
       <para>
        檢查節點之間的連接是否中斷。最常見的原因是防火牆設定不正確。這還可能是導致<emphasis>電腦分裂</emphasis>狀況的原因，其中的叢集被分區。
       </para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>為何無法掛接 OCFS2 裝置？</term>
    <listitem>
     <para>
      請檢查 <filename>/var/log/messages</filename> 中是否包含下行：
     </para>
<screen>Jan 12 09:58:55 alice lrmd: [3487]: info: RA output: [...] 
  ERROR: Could not load ocfs2_stackglue
Jan 12 16:04:22 alice modprobe: FATAL: Module ocfs2_stackglue not found.</screen>
     <para>
      此案例中缺少了核心模組 <filename>ocfs2_stackglue.ko</filename>。請根據所安裝的核心安裝套件 <filename>ocfs2-kmp-default</filename>、<filename>ocfs2-kmp-pae</filename> 或 <filename>ocfs2-kmp-xen</filename>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>錯誤：RNG 綱要不支援標記</term>
    <listitem>
     <para>請參閱<xref linkend="note.ha.cib.upgrade"/>。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 id="sec.ha.troubleshooting.moreinfo">
  <title>更多資訊</title>

  <para>
   如需有關 Linux 上高可用性的其他資訊，包括設定叢集資源及管理和自定高可用性叢集，請參閱 <ulink url="http://clusterlabs.org/wiki/Documentation"/>。
  </para>
 </sect1>
</chapter>
