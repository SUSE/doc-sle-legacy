<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE chapter>
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="ha_ocfs2.xml" xml:id="cha-ha-ocfs2"><title>OCFS2</title><info><abstract>
  <para>
   Oracle Cluster File System 2 (OCFS2) 是一般性用途的日誌檔案系統，自 Linux 2.6 版起便已完全整合到該核心中。OCFS2 可讓您將應用程式二進位檔案、資料檔案和資料庫儲存於裝置上的共享儲存中。叢集中所有節點均同時具有檔案系統的讀取與寫入權限。透過複製品資源管理的使用者空間控制精靈可提供與 HA 堆疊的整合，特別是與 OpenAIS/Corosync 和分散式鎖定管理員 (DLM) 的整合。
  </para>
 </abstract></info>
 <indexterm class="startofrange" xml:id="idx-filesystems-ocfs2"> <primary>檔案系統</primary> <secondary>OCFS2</secondary> </indexterm>
 
 <section xml:id="sec-ha-ocfs2-features">
  <title>特點及優勢</title>

  <para>
   OCFS2 可用於下列儲存解決方案，例如︰
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     一般應用程式與工作負載。
    </para>
   </listitem>
   <listitem>
    <para>
     叢集中的 Xen 影像儲存。Xen 虛擬機器與虛擬伺服器可以儲存到叢集伺服器掛接的 OCFS2 磁碟區。如此即可便捷地在伺服器之間實現 Xen 虛擬機器的可攜性。
    </para>
   </listitem>
   <listitem>
    <para>
     LAMP (Linux、Apache、MySQL 和 PHP | Perl | Python) 堆疊。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   做為一款高效能、對稱、平行的叢集檔案系統，OCFS2 支援下列功能：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     叢集上的所有節點均可使用應用程式的檔案。使用者只需在叢集上的 OCFS2 磁碟區安裝一次即可。
    </para>
   </listitem>
   <listitem>
    <para>
     所有節點可直接透過標準檔案系統介面同時讀取及寫入儲存，讓叢集上執行的應用程式更易於管理。
    </para>
   </listitem>
   <listitem>
    <para>
     檔案存取透過 DLM 來協調。在多數情況下，DLM 控制都能起到很好的效果，但如果應用程式設計與 DLM 爭奪檔案存取協調權，則擴充性可能就會受到限制。
    </para>
   </listitem>
   <listitem>
    <para>
     所有後端儲存均可使用儲存備份功能。您可輕鬆建立共享應用程式檔案的複本，以利於提供有效的災難復原。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   OCFS2 亦提供下列功能：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     中繼資料快取。
    </para>
   </listitem>
   <listitem>
    <para>
     中繼資料日誌。
    </para>
   </listitem>
   <listitem>
    <para>
     跨節點資料檔案一致性。
    </para>
   </listitem>


   <listitem>
    <para>
     支援的多區塊最大大小為 4 KB，叢集最大大小為 1 MB，磁碟區最大大小為 4 PB (拍位元組)。
    </para>
   </listitem>
   <listitem>
    <para>
     最多支援 32 個叢集節點。
    </para>
   </listitem>


   <listitem>
    <para>
     支援對資料庫檔案進行非同步的直接 I/O 存取，以提升資料庫效能。
    </para>
   </listitem>
  </itemizedlist>
 </section>
 <section xml:id="sec-ha-ocfs2-utils">
  <title>OCFS2 套件與管理公用程式</title>

  <para>
   OCFS2 核心模組 (<literal>ocfs2</literal>) 會自動安裝到 SUSE® Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">11 SP4</phrase></phrase> 上的 High Availability Extension 中。若要使用 OCFS2，請確定叢集中的每個節點均已安裝下列套件︰<systemitem class="resource">ocfs2-tools</systemitem> 及與您的核心相符的 <systemitem class="resource">ocfs2-kmp-*</systemitem> 套件。
  </para>

  <para>
   <systemitem class="resource">ocfs2-tools</systemitem> 套件提供下列管理 OFS2 磁碟區的公用程式。如需有關語法的資訊，請參閱其 man 頁面。
  </para>

  <table>
   <title>OCFS2 共用程式</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 共用程式
       </para>
      </entry>
      <entry>
       <para>
        描述
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        debugfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        以偵錯為目的，檢驗 OCFS 檔案系統。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        fsck.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        檢查檔案系統是否有錯誤，並選擇性修復錯誤。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mkfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        在裝置上建立 OCFS2 檔案系統，通常是共用實體或邏輯磁碟上的分割區。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mounted.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        偵測並列出叢集系統上的所有 OCFS2 磁碟區。偵測並列出掛接 OCFS2 裝置的系統上之所有節點，或列出所有 OCFS2 裝置。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        tunefs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        變更 OCFS2 檔案系統參數，包括磁碟區標籤、節點插槽數量、所有節點插槽的日至大小，以及磁碟區大小。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </section>
 <section xml:id="sec-ha-ocfs2-create-service">
  <title>設定 OCFS2 服務與 STONITH 資源</title>



  <para>
   建立 OCFS2 磁碟區之前，必須先將 DLM、O2CB 及 STONITH 資源設定為叢集中的服務。OCFS2 會使用使用者空間中執行的 Pacemaker 所提供的叢集成員服務。因此，需要將 DLM 與 O2CB 設定為叢集中每個節點上都存在的複製品資源。
  </para>

  <para>
   下面的程序將使用 <command>crm</command> 外圍程序來設定叢集資源。或者，您也可以使用 Pacemaker GUI 設定資源。
  </para>

  <note>
   <title>用於 cLVM 與 OCFS2 的 DLM 資源</title>
   <para>
    cLVM 與 OCFS2 都需要在叢集的所有節點上執行的 DLM 資源，因此該資源通常會設定為複製品。如果您的環境中包含 OCFS2 與 cLVM，只需為 OCFS2 與 cLVM 設定<emphasis>一個</emphasis> DLM 資源就足夠了。
   </para>
  </note>

  <procedure xml:id="pro-ocfs2-resources">
   <title>設定 DLM 與 O2CB 資源</title>
   <para>
    該組態由一個包含數個基本資源的基礎群組與一個基礎複製品構成。之後，基礎群組與基礎複製品便可用於各種情況 (例如，用於 OCFS2 與 cLVM)。您只需根據需要新增相應的基本資源來擴充基礎群組。由於基礎群組有內部並存與順序條件約束，因此您不必指定多個個別群組、複製品及其相依項，這使總體設定程序更為簡便。
   </para>
   <para>
    對叢集中的某個節點執行下列步驟︰
   </para>
   <step>
    <para>
     啟動外圍程序，並以 <systemitem class="username">root</systemitem> 或同等身分登入。
    </para>
   </step>
   <step>
    <para>
     執行 <command>crm</command> <option>configure</option>。
    </para>
   </step>
   <step>
    <para>
     輸入以下內容以建立 DLM 與 O2CB 的基本資源：
    </para>

<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> dlm ocf:pacemaker:controld \
      op monitor interval="60" timeout="60"
<command>primitive</command> o2cb ocf:ocfs2:o2cb \
      op monitor interval="60" timeout="60"
</screen>
    <para>
     <literal>dlm</literal> 複製品資源控制分散式鎖定管理員服務，並用於確定此服務在叢集中的所有節點上啟動。鑒於基礎群組的內部並存與順序，<literal>o2cb</literal> 服務只會在已執行 <literal>dlm</literal> 服務副本的節點上啟動。
    </para>
   </step>
   <step>
    <para>
     輸入以下內容以建立一個基礎群組與一個基礎複製品：

    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>group</command> base-group dlm o2cb 
<command>clone</command> base-clone base-group \
      meta interleave="true"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 檢閱所做的變更。
    </para>
   </step>
   <step>
    <para>
     如果所有設定都正確，請使用 <command>commit</command> 提交變更，然後使用 <command>exit</command> 離開 crm 即時組態。
    </para>
   </step>
  </procedure>

  <procedure xml:id="pro-ocfs2-stonith">
   <title>設定 STONITH 資源</title>
   <note>
    <title>需要 STONITH 裝置</title>
    <para>
     您需要設定一部圍籬區隔裝置。如果沒有設定合適的 STONITH 機制 (如 <literal>external/sbd</literal>)，組態將失敗。
    </para>
   </note>
   <step>
    <para>
     啟動外圍程序，並以 <systemitem class="username">root</systemitem> 或同等身分登入。
    </para>
   </step>
   <step>
    <para>
     依<xref linkend="pro-ha-storage-protect-sbd-create"/> 所述建立一個 SBD 分隔區。
    </para>
   </step>
   <step>
    <para>
     執行 <command>crm</command> <option>configure</option>。
    </para>
   </step>
   <step>
    <para>
     將 <literal>external/sdb</literal> 設定為圍籬區隔裝置 (其 <literal>/dev/sdb2</literal> 做為共享儲存區上的專用分割區)，執行活動訊號與圍籬區隔︰
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> sbd_stonith stonith:external/sbd \
      params pcmk_delay_max="15" \
      op monitor interval="15" timeout="15"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 檢閱所做的變更。
    </para>
   </step>
   <step>
    <para>
     如果所有設定都正確，請使用 <command>commit</command> 提交變更，然後使用 <command>exit</command> 離開 crm 即時組態。
    </para>
   </step>
  </procedure>
 </section>
 <section xml:id="sec-ha-ocfs2-create">
  <title>建立 OCFS2 磁碟區</title>

  <para>
   按<xref linkend="sec-ha-ocfs2-create-service"/> 中所述將 DLM 和 O2CB 設定為叢集資源後，設定系統使用 OCFS2，並建立 OCFs2 磁碟區。
  </para>

  <note>
   <title>應用程式與資料檔案使用的 OCFS2 磁碟區</title>
   <para>
    一般情況下，建議您將應用程式檔案與資料檔案儲存在不同的 OCFS2 磁碟區中。如果您的應用程式磁碟區和資料磁碟區對於掛接有不同的要求，請務必將它們儲存到不同的磁碟區中。
   </para>
  </note>

  <para>
   開始之前，請先準備要用於 OCFS2 磁碟區的區塊裝置。將裝置留為可用空間。
  </para>

  <para>
   然後按<xref linkend="pro-ocfs2-volume"/> 中所述，使用 <command>mkfs.ocfs2</command> 建立並格式化 OCFS2 磁碟區。此指令最重要的參數列於<xref linkend="tab-ha-ofcs2-mkfs-ocfs2-params"/>。如需詳細資訊及指令語法，請參閱 <command>mkfs.ocfs2</command> man 頁面。
  </para>

  <table xml:id="tab-ha-ofcs2-mkfs-ocfs2-params">
   <title>OCFS2 的重要參數</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 參數
       </para>
      </entry>
      <entry>
       <para>
        描述與建議
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        磁碟區標籤 (<option>-L</option>)
       </para>
      </entry>
      <entry>
       <para>
        磁碟區的描述性名稱可讓其掛接於不同節點時易於辨識。使用 <command>tunefs.ocfs2</command> 公用程式依需要修改標籤。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        叢集大小 (<option>-C</option>)
       </para>
      </entry>
      <entry>
       <para>
        叢集大小是配置給持有資料的檔案之空間最小單位。如需可用選項及建議，請參閱 <command>mkfs.ocfs2</command> man 頁面。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        節點插槽數量 (<option>-N</option>)
       </para>
      </entry>
      <entry>
       <para>
        可同時掛接磁碟區的最大節點數量。對於每個節點，OCFS2 會分別為其建立系統檔案，例如日誌。存取磁碟區的節點可以是小 endian 架構 (如 x86、x86-64 和 ia64) 和大 endian 架構 (如 ppc64 和 s390x) 的組合。
       </para>
       <para>
        節點特定的檔案會被視為本機檔案。節點插槽號碼會附加至本機檔案。例如︰<literal>journal:0000</literal> 隸屬於指派至插槽 <literal>0</literal> 的任一節點。
       </para>
       <para>
        建立磁碟區時，請根據您希望同時掛接磁碟區的節點數量，設定節點插槽的最大磁碟區數量。使用 <command>tunefs.ocfs2</command> 公用程式可以視需要增加節點數。請注意，此值只能增加，不能減少。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        區塊大小 (<option>-b</option>)
       </para>
      </entry>
      <entry>
       <para>
        檔案系統可定址的空間最小單位。請在建立磁碟區時指定區塊大小。如需可用選項及建議，請參閱 <command>mkfs.ocfs2</command> man 頁面。

       </para>
      </entry>
     </row>

     <row>
      <entry>
       <para>
        開啟/關閉特定功能 (<option>--fs-features</option>)
       </para>
      </entry>
      <entry>
       <para>
        可提供以逗號分隔的功能標籤清單，<systemitem>mkfs.ocfs2</systemitem> 會根據此清單嘗試建立具有這些功能集的檔案系統。若要開啟功能，請在清單中包含該功能。若要關閉功能，則在名稱前預增 <literal>no</literal>。
       </para>
       <para>
        如需所有可用標籤的綜覽，請參閱 <command>mkfs.ocfs2</command> man 頁面。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        預定義功能 (<option>--fs-feature-level</option>)
       </para>
      </entry>
      <entry>
       <para>
        可讓您從一組預定義檔案系統功能中進行選擇。如需可用選項，請參閱 <command>mkfs.ocfs2</command> man 頁面。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>



  <para>
   使用 <command>mkfs.ocfs2</command> 建立並格式化磁碟區時，如果不指定任何具體功能，則預設會啟用下列功能︰<option>backup-super</option>、<option>sparse</option>、<option>inline-data</option>、<option>unwritten</option>、<option>metaecc</option>、<option>indexed-dirs</option> 和 <option>xattr</option>。
  </para>



  <procedure xml:id="pro-ocfs2-volume">
   <title>建立並格式化 OCFS2 磁碟區</title>
   <para>
    在其中<emphasis>一</emphasis>個叢集節點上執行下列步驟。
   </para>
   <step>
    <para>
     開啟終端機視窗，並以 <systemitem class="username">root</systemitem> 身分登入。
    </para>
   </step>
   <step>
    <para>
     使用指令 <command>crm status</command> 檢查叢集是否上線。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mkfs.ocfs2</command> 公用程式建立並格式化磁碟區。如需此指令的語法資訊，請參閱 <command>mkfs.ocfs2</command> man 頁面。
    </para>
    <para>
     例如，若要在 <filename>/dev/sdb1</filename> 上建立最多支援 32 個叢集節點的新 OCFS2 檔案系統，請輸入以下指令︰
    </para>
<screen><prompt role="root">root # </prompt> mkfs.ocfs2 -N 32 /dev/sdb1</screen>

   </step>
  </procedure>
 </section>
 <section xml:id="sec-ha-ocfs2-mount">
  <title>掛接 OCFS2 磁碟區</title>

  <para>
   您可以按<xref linkend="pro-ocfs2-mount-cluster"/> 中所述，手動或使用叢集管理員掛接 OCFS2 磁碟區。
  </para>

  <procedure xml:id="pro-ocfs2-mount-manual">
   <title>手動掛接 OCFS2 磁碟區</title>
   <step>
    <para>
     開啟終端機視窗，並以 <systemitem class="username">root</systemitem> 身分登入。
    </para>
   </step>
   <step>
    <para>
     使用指令 <command>crm status</command> 檢查叢集是否上線。
    </para>
   </step>
   <step>
    <para>
     從指令行掛接磁碟區，請使用 <command>mount</command> 指令。
    </para>
   </step>
  </procedure>

  <warning>
   <title>手動掛接的 OCFS2 裝置</title>
   <para>
    在為了進行測試而手動掛接 OCFS2 檔案系統之後，必須再將其卸載，然後才可透過 OpenAIS 使用該檔案系統。
   </para>
  </warning>

  <procedure xml:id="pro-ocfs2-mount-cluster">
   <title>使用叢集管理員掛接 OCFS2 磁碟區</title>
   <para>
    若要使用 High Availability 軟體掛接 OCFS2 磁碟區，請在叢集中設定 ocf 檔案系統資源。下面的程序將使用 <command>crm</command> 外圍程序來設定叢集資源。或者，您也可以使用 Pacemaker GUI 設定資源。
   </para>
   <step>
    <para>
     啟動外圍程序，並以 <systemitem class="username">root</systemitem> 或同等身分登入。
    </para>
   </step>
   <step>
    <para>
     執行 <command>crm</command> <option>configure</option>。
    </para>
   </step>
   <step>
    <para>
     設定 Pacemaker 以在叢集內各節點上掛接檔案系統︰
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ocfs2-1 ocf:heartbeat:Filesystem \
      params device="/dev/sdb1" directory="/mnt/shared" fstype="ocfs2" options="acl" \
      op monitor interval="20" timeout="40"</screen>
   </step>
   <step>
    <para>
     將檔案系統基本資源新增至您在<xref linkend="pro-ocfs2-resources"/> 中設定的基礎群組：
    </para>
    <substeps performance="required">
     <step>
      <para>
       輸入
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>edit base-group</screen>
     </step>

     <step>
      <para>
       在開啟的 vi 編輯器中，對群組做如下修改並儲存所做的變更：
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>group base-group dlm o2cb ocfs2-1</screen>
      <para>
       鑒於基礎群組的內部並存與順序，Pacemaker 只會在已執行 o2cb 資源的節點上啟動 <systemitem class="resource">ocfs2-1</systemitem> 資源。
      </para>
     </step>
    </substeps>
   </step>

   <step>
    <para>
     使用 <command>show</command> 檢閱所做的變更。若要檢查您是否已設定所有的必要資源，另請參閱<xref linkend="cha-ha-config-example"/>。
    </para>
   </step>
   <step>
    <para>
     如果所有設定都正確，請使用 <command>commit</command> 提交變更，然後使用 <command>exit</command> 離開 crm 即時組態。
    </para>
   </step>
  </procedure>
 </section>
 <section xml:id="sec-ha-ocfs2-quota">
  <title>在 OCFS2 檔案系統上使用配額</title>



  <para>
   若要在 OCFS2 檔案系統上使用配額，請分別使用以下相應的配額功能或掛接選項來建立和掛接檔案系統：<literal>ursquota</literal> (個別使用者的配額) 或 <literal>grpquota</literal> (群組的配額)。您也可在以後使用 <command>tunefs.ocfs2</command> 在解下的檔案系統上啟用這些功能。
  </para>

  <para>
   檔案系統啟用相應的配額功能後，將會在中繼資料中追蹤每個使用者 (或群組) 使用的空間量和檔案數量。由於 OCFS2 將配額資訊視為檔案系統內部的中繼資料，因此，您不需要執行 <command>quotacheck</command>(8) 程式。fsck.ocfs2 和檔案系統驅動程式自身中已內建所有功能。
  </para>

  <para>
   若要對每個使用者或群組強制實施限制，請執行 <command>quotaon</command>(8)，就像對其他任何檔案系統執行該指令一樣。
  </para>





  <para>
   出於效能的考量，每個叢集每隔 10 秒會在本地執行一次配額計算，並將此資訊同步至通用中央儲存。您可以使用 <command>tunefs.ocfs2</command>、選項 <option>usrquota-sync-interval</option> 和 <option>grpquota-sync-interval</option> 來調整此間隔。因此，配額資訊並非一直都是精確的，所以，當使用者或群組同時操作多個叢集節點時，可能會略微超出其配額限制。
  </para>
 </section>
 <section xml:id="sec-ha-ocfs2-more">
  <title>更多資訊</title>

  <para>
   如需有關 OCFS2 的詳細資訊，請參閱下列連結的內容：
  </para>

  <variablelist>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/"/>
    </term>
    <listitem>
     <para>
      Oracle OCFS2 專案的首頁。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/documentation"/>
    </term>
    <listitem>
     <para>
      專案文件首頁中的《<citetitle>OCFS2 User's Guide</citetitle>》(OCFS2 使用者指南)。
     </para>
    </listitem>
   </varlistentry>
  </variablelist><indexterm class="endofrange" startref="idx-filesystems-ocfs2"/>
 </section>
</chapter>
