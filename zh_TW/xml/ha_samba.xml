<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="ha_samba.xml" id="cha-ha-samba">
 <title>Samba 叢集</title>
 <abstract>
  <para>
   叢集化 Samba 伺服器為您的異質網路提供了高可用性解決方案。本章介紹了一些背景知識並說明如何設定叢集化 Samba 伺服器。
  </para>
 </abstract>
 <sect1 id="sec-ha-samba-overview">
  <title>概念綜覽</title>

  <para>
   Samba 使用 Trivial Database (TDB) 已有多年。TDB 允許多個應用程式同時執行寫入操作。為了確保所有寫入操作成功執行且彼此不發生衝突，TDB 使用了內部鎖定機制。
  </para>

  <para>
   Cluster Trivial Database (CTDB) 是現有 TDB 的一個小延伸功能。專案將 CTDB 描述為<quote>Samba 和其他專案用於儲存暫存資料之 TDB 資料庫的叢集實作</quote>。
  </para>

  <para>
   每個叢集節點都執行一個本地 CTDB 精靈。Samba 會與其本地 CTDB 精靈通訊，而不是直接寫入其 TDB。精靈透過網路交換中繼資料，但實際的讀寫操作是在一個具有快速儲存的本地副本上執行的。CTDB 的概念請參閱<xref linkend="fig-ha-samba-overview"/>。
  </para>

  <note>
   <title>CTDB 僅用於 Samba</title>
   <para>
    目前實作的 CTDB 資源代辦將 CTDB 設定為僅管理 Samba。包括 IP 容錯移轉在內的其他內容應使用 Pacemaker 進行設定。
   </para>
   <para>
    只有完全同質的叢集支援 CTDB。例如，叢集中的所有節點都需要具有相同的架構。i586 與 x86_64 不能混用。
   </para>
  </note>

  <figure id="fig-ha-samba-overview">
   <title>CTDB 叢集的結構</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ha_samba.svg" width="80%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ha_samba.png" width="80%"/>
    </imageobject>
   </mediaobject>
  </figure>

  <para>
   叢集化的 Samba 伺服器必須共享某些資料：
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     將 Unix 使用者及群組 ID 與 Windows 使用者及群組相關聯的映射表。
    </para>
   </listitem>
   <listitem>
    <para>
     使用者資料庫必須在所有節點之間同步。
    </para>
   </listitem>
   <listitem>
    <para>
     Windows 網域中成員伺服器的加入資訊必須在所有節點上都可用。
    </para>
   </listitem>
   <listitem>
    <para>
     中繼資料必須在所有節點上都可用，例如活動的 SMB 工作階段、共享連接以及各類鎖定。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   目的是讓擁有 N+1 個節點的叢集化 Samba 伺服器快於僅有 N 個節點的 Samba 伺服器。一個節點不會慢於一部未叢集化的 Samba 伺服器。
  </para>
 </sect1>
 <sect1 id="sec-ha-samba-basicconf">
  <title>基本組態</title>
  
  <note>
   <title>變更的組態檔案</title>
   <para>
    CTDB 資源代辦會自動變更 <filename>/etc/sysconfig/ctdb</filename> 與 <filename>/etc/samba/smb.conf</filename>。使用 <command>crm ra</command> <option>info CTDB</option> 可列出可以為 CTDB 資源指定的所有參數。
   </para>
  </note>

  <para>
   若要設定叢集化的 Samba 伺服器，請執行下列步驟：
  </para>

  <procedure id="pro-ha-samba-basicconf">
   <title>設定基本的叢集化 Samba 伺服器</title>
   <step performance="required">
    <para>
     準備叢集：
    </para>
    <substeps performance="required">
     <step performance="required">
      <para>
       依本指南<xref linkend="part-config"/> 所述設定叢集 (OpenAIS、Pacemaker、OCFS2)。
      </para>
     </step>
     <step performance="required">
      <para>
       設定共享檔案系統 (例如 OCFS2) 並予以掛接 (例如，掛接至 <filename>/shared</filename>)。
      </para>
     </step>
     <step performance="required">
      <para>
       如果想要開啟 POSIX ACL，則將其啟用：
      </para>
      <itemizedlist mark="bullet" spacing="normal">
       <listitem>
        <para>
         對於新 OCFS2 檔案系統，使用：
        </para>
<screen><prompt role="root">root # </prompt><command>mkfs.ocfs2</command> --fs-features=xattr ...</screen>
       </listitem>
       <listitem>
        <para>
         對於現有的 OCFS2 檔案系統，使用：
        </para>
        <screen><prompt role="root">root # </prompt><command>tunefs.ocfs2</command> --fs-feature=xattr<replaceable>DEVICE</replaceable></screen>
        <para>
         確定在檔案系統資源中指定了 <option>acl</option> 選項。按如下所示使用 <command>crm</command> 外圍程序：
        </para>
<screen><prompt role="custom">crm(live)configure# </prompt> <command>primary</command> ocfs2-3 ocf:heartbeat:Filesystem options="acl" ...</screen>
       </listitem>
      </itemizedlist>
     </step>
     <step performance="required">
      <para>
       確定 <systemitem class="service">ctdb</systemitem>、<systemitem class="service">smb</systemitem>、<systemitem class="service">nmb</systemitem> 與 <systemitem class="service">winbind</systemitem> 服務已停用：
      </para>
 <screen><prompt role="root">root # </prompt><command>chkconfig</command> ctdb off
<command>chkconfig</command> smb off
<command>chkconfig</command> nmb off
<command>chkconfig</command> winbind off</screen>
     </step>
    </substeps>
   </step>
   <step performance="required">
    <para>
     在共享檔案系統上建立一個 CTDB 鎖定目錄：
    </para>
    <screen><prompt role="root">root # </prompt><command>mkdir</command> -p /shared/samba/</screen>
   </step>
   <step performance="required">
    <para>
     在 <filename>/etc/ctdb/nodes</filename> 中插入包含叢集中每個節點之全部私人 IP 位址的所有節點：
    </para>
<screen>192.168.1.10
192.168.1.11</screen>
   </step>
   <step performance="required">
    <para>
     使用 <command>csync2</command> 將組態檔案複製到所有節點：
    </para>
    <screen><prompt role="root">root # </prompt>csync2 <option>-xv</option></screen>
    <para>
     如需詳細資訊，請參閱<xref linkend="pro-ha-installation-setup-csync2-start"/>。
    </para>
   </step>


   <step performance="required">
    <para>
     將 CTDB 資源新增至叢集：
    </para>

<screen><command>crm</command> configure
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ctdb ocf:heartbeat:CTDB params \
    ctdb_manages_winbind="false" \ 
    ctdb_manages_samba="true" \
    ctdb_recovery_lock="/shared/samba/ctdb.lock" \
      op monitor interval="10" timeout="20" \
      op start interval="0" timeout="90" \
      op stop interval="0" timeout="100"
<prompt role="custom">crm(live)configure# </prompt><command>clone</command> ctdb-clone ctdb \
    meta globally-unique="false" interleave="true"
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> ctdb-with-fs inf: ctdb-clone fs-clone
<prompt role="custom">crm(live)configure# </prompt><command>order</command> start-ctdb-after-fs inf: fs-clone ctdb-clone
<prompt role="custom">crm(live)configure# </prompt><command>commit</command></screen>
   </step>
   <step performance="required">
    <para>
     新增叢集化 IP 位址：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip ocf:heartbeat:IPaddr2 params ip=192.168.2.222 \
  clusterip_hash="sourceip-sourceport" op monitor interval=60s
<prompt role="custom">crm(live)configure# </prompt><command>clone</command> ip-clone ip meta globally-unique="true"
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> ip-with-ctdb inf: ip-clone ctdb-clone
<prompt role="custom">crm(live)configure# </prompt><command>order</command> start-ip-after-ctdb inf: ctdb-clone ip-clone
<prompt role="custom">crm(live)configure# </prompt><command>commit</command></screen>
   </step>
   <step performance="required">
    <para>
     檢查結果：
    </para>
<screen><prompt role="root">root # </prompt><command>crm</command> status
Clone Set: dlm-clone
     Started: [ hex-14 hex-13 ]
 Clone Set: o2cb-clone
     Started: [ hex-14 hex-13 ]
 Clone Set: c-ocfs2-3
     Started: [ hex-14 hex-13 ]
 Clone Set: ctdb-clone
     Started: [ hex-14 hex-13 ]
 Clone Set: ip-clone (unique)
     ip:0       (ocf::heartbeat:IPaddr2):       Started hex-13
     ip:1       (ocf::heartbeat:IPaddr2):       Started hex-14</screen>
   </step>
   <step performance="required">
    <para>從用戶端機器執行測試。在 Linux 用戶端上，新增一個用於存取 Samba 的使用者：
    </para>
    <screen><prompt role="root">root # </prompt><command>smbpasswd</command> <option>-a</option> <replaceable>USERNAME</replaceable></screen>
   </step>
   <step performance="required"><para>測試您是否可以連接至該新使用者的主目錄：</para>
    <screen><prompt role="root">root # </prompt>smbclient -u <replaceable>USERNAME</replaceable>//192.168.2.222/<replaceable>USERNAME</replaceable></screen>
   </step>


  </procedure>
 </sect1>
 <sect1 id="sec-ha-samba-ad">
  <title>加入 Active Directory 網域</title>

  

  <para>
   Active Directory (AD) 是適用於 Windows 伺服器系統的目錄服務。
  </para>

  <para>
   下面的指示概述了如何將 CTDB 叢集加入 Active Directory 網域：
  </para>

  <procedure>
   <step performance="required">
    <para>
     查閱 Windows 伺服器文件，以獲取如何設定 Active Directory 網域的指示。在本範例中，我們使用了以下參數：
    </para>
    <informaltable>
     <tgroup cols="2">
      <tbody>
       <row>
        <entry>
         <para>
          AD 和 DNS 伺服器
         </para>
        </entry>
        <entry>
<screen>win2k3.2k3test.example.com</screen>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          AD 網域
         </para>
        </entry>
        <entry>
<screen>2k3test.example.com</screen>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          叢集 AD 成員 NETBIOS 名稱
         </para>
        </entry>
        <entry>
<screen>CTDB-SERVER</screen>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>

   </step>
   <step performance="required">
    <para>
     <xref linkend="pro-ha-samba-config-ctdb"/>
    </para>
   </step>
   <step performance="required">
    <para>
     <xref linkend="pro-ha-samba-config-join-ad"/>
    </para>
   </step>
  </procedure>

  <para>
   下一步是設定 CTDB：
  </para>

  <procedure id="pro-ha-samba-config-ctdb">
   <title>設定 CTDB</title>
   <step performance="required">
    <para>
     確定已依<xref linkend="sec-ha-samba-basicconf"/> 中所示設定了叢集。
    </para>
   </step>
   <step performance="required">
    <para>
     在一個節點上停止 CTDB 資源：
    </para>
<screen><prompt role="root">root # </prompt> crm resource stop ctdb-clone</screen>
   </step>
   <step performance="required">
    <para>
     開啟 <filename>/etc/samba/smb.conf</filename> 組態檔案，新增 NetBIOS 名稱，然後關閉該檔案：
    </para>
<screen>[global
    netbios name = CTDB-SERVER</screen>
    <para>
     其他設定，例如安全性、工作群組等透過 YaST 精靈新增。
    </para>
   </step>
   <step performance="required">
    <para>
     在所有節點上更新檔案 <filename>/etc/samba.conf</filename>：
    </para>
<screen><prompt role="root">root # </prompt>csync2 -xv</screen>
   </step>
   <step performance="required">
    <para>
     重新啟動 CTDB 資源：
    </para>
<screen><prompt role="root">root # </prompt>crm resource start ctdb-clone</screen>
   </step>
  </procedure>

  <para>
   最後，將您的叢集加入 Active Directory 伺服器：
  </para>

  <procedure id="pro-ha-samba-config-join-ad">
   <title>加入 Active Directory</title>
   <step performance="required">
    <para>
     確定下列檔案包含在要在所有叢集主機上安裝的 Csync2 組態中。
    </para>
<screen>/etc/samba/smb.conf
/etc/security/pam_winbind.conf
/etc/krb5.conf
/etc/nsswitch.conf
/etc/security/pam_mount.conf.xml
/etc/pam.d/common-session</screen>
    <para>
     您也可以使用 YaST 的<guimenu>設定 Csync2</guimenu>模組來完成此任務，請參閱<xref linkend="sec-ha-installation-setup-csync2"/>。
    </para>
   </step>
   <step performance="required">
    <para>
     依<xref linkend="pro-ha-samba-basicconf"/> 所述建立 CTDB 資源。
    </para>
   </step>
   <step performance="required">
    <para>
     執行 YaST 並從<guimenu>網路服務</guimenu>項目中開啟<guimenu>Windows 網域成員</guimenu>模組。
    </para>
   </step>
   <step performance="required">
    <para>
     輸入網域或工作群組設定，然後按一下<guimenu>確定</guimenu>完成操作。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec-ha-samba-testing">
  <title>對叢集化 Samba 進行除錯與測試</title>

  <para>
   若要對叢集化 Samba 伺服器進行除錯，可以使用下列適用於不同層級的工具：
  </para>

  <variablelist>
   <varlistentry>
    <term><command>ctdb_diagnostics</command>
    </term>
    <listitem>
     <para>
      執行此工具可以診斷叢集化 Samba 伺服器。詳細的除錯訊息可協助您追蹤出現的任何問題。
     </para>
     <para>
      <command>ctdb_diagnostics</command> 指令會搜尋下列檔案，這些檔案必須在所有節點上均可用︰
     </para>
<screen>/etc/krb5.conf
/etc/hosts
/etc/ctdb/nodes
/etc/sysconfig/ctdb
/etc/resolv.conf
/etc/nsswitch.conf
/etc/sysctl.conf
/etc/samba/smb.conf
/etc/fstab
/etc/multipath.conf
/etc/pam.d/system-auth
/etc/sysconfig/nfs
/etc/exports
/etc/vsftpd/vsftpd.conf</screen>
     <para>
      如果存在 <filename>/etc/ctdb/public_addresses</filename> 與 <filename>/etc/ctdb/static-routes</filename> 檔案，則也會對其進行檢查。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>ping_pong</command>
    </term>
    <listitem>
     <para>
      使用 <command>ping_pong</command> 可以檢查您的檔案系統是否適用 CTDB。它會對叢集檔案系統執行某些測試，例如連貫性和效能測試 (請參閱 <ulink url="http://wiki.samba.org/index.php/Ping_pong"/>)，讓您瞭解叢集在高負載下的表現。
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><command>send_arp</command> 工具與 <systemitem class="resource">SendArp</systemitem> 資源代辦</term>
    <listitem>
     <para>
      <systemitem class="resource">SendArp</systemitem> 資源代辦位於 <filename>/usr/lib/heartbeat/send_arp</filename> (或 <filename>/usr/lib64/heartbeat/send_arp</filename>)。<command>send_arp</command> 工具會送出無故 ARP (位址解析通訊協定) 封包，可以用來更新其他機器的 ARP 表。這有助於確認容錯移轉程序完成後的通訊問題。如果節點對 samba 顯示了叢集 IP 位址，而您卻無法連接到此節點或 ping 通此節點，請使用 <command>send_arp</command> 指令測試節點是否只需要 ARP 表更新。
     </para>
     <para>
      如需詳細資訊，請參閱<ulink url="http://wiki.wireshark.org/Gratuitous_ARP"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   若要對叢集檔案系統的某些方面進行測試，請執行下列步驟︰
  </para>

  <procedure>
   <title>測試叢集檔案系統的連貫性和效能</title>
   <step performance="required">
    <para>
     在一個節點上啟動指令 <command>ping_pong</command> 並將預留位址 <replaceable>N</replaceable> 取代為節點數量加 1。該檔案存放於 <filename><replaceable>ABSPATH</replaceable>/data.txt</filename> 共享儲存，因此從任何節點上都可存取 (<replaceable>ABSPATH </replaceable> 表示絕對路徑)：
    </para>
<screen><command>ping_pong</command> <replaceable>ABSPATH</replaceable>/data.txt <replaceable>N</replaceable></screen>
    <para>
     僅執行一個節點時，鎖定率應該會很高。如果程式未顯示鎖定率，請更換您的叢集檔案系統。
    </para>
   </step>
   <step performance="required">
    <para>
     在另一個節點上啟動第二個 <command>ping_pong</command>，並使用相同的參數。
    </para>
    <para>
     鎖定率應該會有明顯的下降。如果您的叢集檔案系統出現以下任何一種情況，請予以更換︰
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <command>ping_pong</command> 未輸出每秒的鎖定率，
      </para>
     </listitem>
     <listitem>
      <para>
       兩個例項中的鎖定率相差較大，
      </para>
     </listitem>
     <listitem>
      <para>
       啟動第二個例項後，鎖定率未下降。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step performance="required">
    <para>
     啟動第三個 <command>ping_pong</command>。新增其他節點並注意鎖定率的變化。
    </para>
   </step>
   <step performance="required">
    <para>
     逐個停止 <command>ping_pong</command> 指令。在回到單一節點的情況之前，應會看到鎖定率不斷提高。如果未發生預期的情況，請參閱<xref linkend="cha-ha-ocfs2"/> 中的詳細資訊。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec-ha-samba-moreinfo">
  <title>更多資訊</title>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <ulink url="http://linux-ha.org/wiki/CTDB_(resource_agent)"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://wiki.samba.org/index.php/CTDB_Setup"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://ctdb.samba.org"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <ulink url="http://wiki.samba.org/index.php/Samba_%26_Clustering"/>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
