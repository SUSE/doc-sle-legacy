<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="image_kiwi.xml" id="cha-kiwi">
 <title>KIWI</title>
 <abstract>
  <para>
   O KIWI é um sistema para criação de imagens do sistema operacional. Imagem é um diretório com um arquivo que contém o sistema operacional, seus aplicativos e suas configurações, a estrutura do sistema de arquivos do OS, possíveis metadados adicionais e (dependendo do tipo de imagem) a geometria de disco e os dados da tabela de partição. Com o KIWI, você pode criar LiveCDs e LiveDVDs, pendrives USB, disco virtual para reprodução em sistemas virtuais completos, como VMware, imagens XEN para paravirtualização em um hipervisor e um ambiente PXE para inicializar da rede.
  </para>

 </abstract>


 <sect1 id="sec-kiwi-prereq">
  <title>Pré-requisitos para o KIWI</title>

  <para>
   Para compilar imagens com o KIWI, você precisa atender às seguintes pré-condições:
  </para>

  <orderedlist spacing="normal">
   <listitem>
    <para>
     Espaço livre em disco suficiente para a operação.
    </para>
   </listitem>
   <listitem>
    <para>
     O KIWI é dividido em vários pacotes, destinados a diferentes tipos de imagem. Em qualquer caso, você precisará do pacote base <systemitem class="resource">kiwi</systemitem>. Dependendo de sua imagem de destino, você precisará dos seguintes pacotes:
    </para>
    <informaltable>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>
         <para>
          Tipo de Imagem
         </para>
        </entry>
        <entry>
         <para>
          Nome do pacote
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          Mídia de instalação
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-oemboot</systemitem>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Virtualização
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-xenboot</systemitem>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Pendrives USB
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-usbboot</systemitem>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Cliente de rede
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-netboot</systemitem>
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>
   </listitem>
   <listitem>
    <para>
     Instale o pacote <systemitem class="resource">kiwi-doc</systemitem>. É possível encontrar algumas configurações de exemplo para ter uma ideia sobre a estrutura e o conteúdo.
    </para>
   </listitem>
   <listitem>
    <para>
     Obtenha informações sobre o arquivo de configuração do KIWI e sua estrutura. Ele baseia-se em um esquema RELAX NG e está documentado no pacote <systemitem class="resource">kiwi</systemitem>, em <filename>/usr/share/doc/packages/kiwi/kiwi.html</filename>. Você precisará desse documento se quiser criar o arquivo de configuração do zero ou quando desejar inserir elementos ou atributos.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 id="sec-kiwi-process">
  <title>Conhecendo o processo de compilação do KIWI</title>

  <para>
   O processo de compilação do KIWI é separado em três etapas:
  </para>

  <orderedlist spacing="normal">
   <listitem>
    <formalpara>
     <title>Extensão física (Preparação)</title>
     <para>
      Esta fase prepara o conteúdo do novo sistema de arquivos. Durante esta etapa, o diretório root é criado, você determina os pacotes que serão instalados na imagem e quais arquivos de configuração de usuário serão incluídos.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Extensão lógica (Criação)</title>
     <para>
      Este estágio depende de uma etapa de preparação bem-sucedida. A etapa de extensão lógica cria a imagem do sistema operacional com base na primeira etapa.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Implantação</title>
     <para>
      O tipo de imagem resultante pode ser implantado com métodos diferentes, como um método instalado em um disco rígido ou executado por um sistema de virtualização (VMware, Qemu, VirtualBox).
     </para>
    </formalpara>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 id="sec-kiwi-imagedesc">
  <title>Descrição da imagem</title>

  <para>
   O KIWI precisa de uma descrição da imagem para compilar um tipo de imagem. A descrição da imagem é um diretório que contém, no mínimo, um arquivo <filename>config.xml</filename> ou, talvez, esse arquivo com a extensão <filename>*.kiwi</filename>.
  </para>

  <sect2 id="sec-kiwi-imagedescr-contents">
   <title>Conteúdo da descrição de imagem</title>
   <para>
    A seguinte tabela contém informações opcionais adicionais. Entretanto, a maioria dessas informações é obrigatória para a funcionalidade posterior do sistema operacional:
   </para>
   <table id="tab-kiwi-imagedesc">
    <title>Arquivos e diretórios adicionais para descrição da imagem</title>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>
        <para>
         Arquivo/diretório
        </para>
       </entry>
       <entry>
        <para>
         Descrição
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         <filename>config/</filename>
        </para>
       </entry>
       <entry>
        <para>
         subdiretório opcional. Contém scripts do Bash que são executados após a instalação de todos os pacotes de imagens.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config.sh</filename>
        </para>
       </entry>
       <entry>
        <para>
         script de configuração opcional durante a criação da extensão física
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config.xml</filename>
        </para>
       </entry>
       <entry>
        <para>
         arquivo de configuração para cada descrição de imagem, explicado na <xref linkend="sec-kiwi-config-xml" xrefstyle="select:label"/>
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-cdroot.tgz</filename>
        </para>
       </entry>
       <entry>
        <para>
         arquivo, usado apenas para imagens ISO
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-cdroot.sh</filename>
        </para>
       </entry>
       <entry>
        <para>
         manipular os dados extraídos de <filename>config-cdroot.tgz</filename>
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-yast-autoyast.xml</filename>
        </para>
       </entry>
       <entry>
        <para>
         arquivo de configuração criado pelo AutoYaST
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-yast-firstboot.xml</filename>
        </para>
       </entry>
       <entry>
        <para>
         arquivo de configuração para controlar o serviço firstboot do YaST
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>images.sh</filename>
        </para>
       </entry>
       <entry>
        <para>
         script de configuração opcional durante a criação da etapa de preparação
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>Raiz/</filename>
        </para>
       </entry>
       <entry>
        <para>
         contém outros diretórios, arquivos especiais e scripts que mudam <emphasis>após</emphasis> a instalação de todos os pacotes de imagens
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 id="sec-kiwi-config-xml">
   <title>O arquivo <filename>config.xml</filename></title>
   <para>
    Todas as informações sobre uma descrição de imagem são armazenadas no arquivo XML central de configuração <filename>config.xml</filename>. Toda vez que o KIWI é executado, o <filename>config.xml</filename> é validado em um esquema RELAX NG (consulte <ulink url="http://www.relaxng.org"/> para obter mais informações sobre essa linguagem de esquema). Portanto, é recomendável usar um editor XML adequado com suporte a RELAX NG ou a documentação sobre o esquema no arquivo HTML <filename>/usr/share/doc/packages/kiwi/schema/kiwi.xsd.html</filename>.
   </para>
   <para>
    O arquivo de configuração consiste em várias partes:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>

     <para>
      algumas informações de descrição do autor, informações de contato e uma breve explicação.
     </para>
    </listitem>
    <listitem>

     <para>
      opção de preferências necessária para o estágio de extensão lógica.
     </para>
    </listitem>
    <listitem>

     <para>
      informações sobre os usuários, seus nomes, seus diretórios pessoais e suas senhas.
     </para>
    </listitem>
    <listitem>

     <para>
      links para repositórios.
     </para>
    </listitem>
    <listitem>

     <para>
      uma lista de pacotes usados para o tipo de imagem definido.
     </para>
    </listitem>
    <listitem>
     <para>
      e outras informações menos importantes que podem ser vistas no arquivo HTML acima da documentação do esquema RELAX NG.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    O esqueleto do arquivo é mostrado no seguinte exemplo:
   </para>
   <example id="ex-kiwi-config">
    <title>Arquivo de configuração do KIWI</title>
<screen>&lt;image schemeversion="2.0" name="..."&gt; <co id="co-kiwi-config-image"/>
  &lt;description type="system"&gt; <co id="co-kiwi-config-description"/>
    &lt;author&gt;...&lt;/author&gt;
    &lt;contact&gt;...&lt;/contact&gt;
    &lt;specification&gt;...&lt;/specification&gt;
  &lt;/description&gt;
  &lt;preferences&gt; <co id="co-kiwi-config-preferences"/>
    &lt;type primary="true" boot="..." flags="..."&gt;iso&lt;/type&gt;
    &lt;type boot="..." filesystem="ext3" format="vmdk"&gt;vmx&lt;/type&gt;
    &lt;type boot="..." filesystem="ext3"&gt;xen&lt;/type&gt;
    &lt;type boot="..." filesystem="squashfs" flags="unified"&gt;oem&lt;/type&gt;
    &lt;version&gt;2.7.0&lt;/version&gt;
    &lt;size unit="M"&gt;780&lt;/size&gt;
    &lt;packagemanager&gt;zypper&lt;/packagemanager&gt;
    &lt;rpm-check-signatures&gt;False&lt;/rpm-check-signatures&gt;
    &lt;rpm-force&gt;False&lt;/rpm-force&gt;
    &lt;locale&gt;en_US.UTF-8&lt;/locale&gt;
    &lt;oem-swap&gt;no&lt;/oem-swap&gt;
    &lt;oem-boot-title&gt;USB&lt;/oem-boot-title&gt;
  &lt;/preferences&gt;
  &lt;users group="users"&gt; <co id="co-kiwi-config-users"/>
    &lt;user name="root" pwd="" home="/root"/&gt;
  &lt;/users&gt;
  &lt;repository type="rpm-md"&gt; <co id="co-kiwi-config-repository"/>
    &lt;source path="/home/rpmdir"/&gt;
  &lt;/repository&gt;
  &lt;packages type="image" patternPackageType="onlyRequired"&gt; <co id="co-kiwi-config-packages"/>
    &lt;package name="yast2-live-installer"/&gt;
    &lt;package name="pam"/&gt;
    &lt;!-- List of packages reduced --&gt;
  &lt;/packages&gt;</screen>
   </example>
   <calloutlist>
    <callout arearefs="co-kiwi-config-image">
     <para>
      O elemento raiz de cada arquivo de configuração do KIWI. Cada arquivo requer o número de versão. É possível usar um atributo <literal>kiwirevision</literal> opcional para especificar uma revisão SVN do KIWI.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-description">
     <para>
      Contém descrições obrigatórias com informações sobre o criador das descrições desta imagem, seu endereço de contato e uma explicação resumida.
     </para>
    </callout>

    <callout arearefs="co-kiwi-config-preferences">
     <para>
      Contém preferências obrigatórias com informações sobre versão desta imagem, o gerenciador de pacotes usado, os tipos de imagem suportados e outras configurações.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-users">
     <para>
      O elemento <literal>users</literal> opcional contém uma lista de todos os usuários adicionados à imagem. O elemento <literal>user</literal> contém o nome, o caminho de seu diretório pessoal, a senha e o shell.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-repository">
     <para>
      Contém uma lista obrigatória de repositórios usados pelo gerenciador de pacotes.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-packages">
     <para>
      Contém uma lista obrigatória de pacotes incluídos na imagem.
     </para>
    </callout>
   </calloutlist>
   <para>
    A página HTML acima contém mais informações sobre o arquivo de configuração.
   </para>
  </sect2>
 </sect1>
 <sect1 id="sec-kiwi-creating">
  <title>Criando aplicações com o KIWI</title>

  <para>
   Esta seção descreve como criar aplicações com o KIWI. Uma aplicação é um sistema operacional projetado especialmente para determinada tarefa. Por exemplo, você pode criar uma ferramenta com foco em programas de escritório.
  </para>

  <sect2 id="sec-kiwi-img-createrepo">
   <title>Criando uma fonte de instalação local</title>
   <para>
    Todos os exemplos nos pacotes <systemitem class="resource">kiwi-doc</systemitem> precisam de uma fonte de instalação válida para criar uma imagem. Geralmente, os exemplos se conectam a um recursos de rede. Quanto maior a largura de banda da rede, mais rápida será a criação da imagem. Se você não tiver uma rede rápida ou não quiser usá-la, crie um recurso de instalação local. Proceda da seguinte maneira:
   </para>
   <procedure>
    <step performance="required">
     <para>
      Colete seu DVD de instalação.
     </para>
    </step>
    <step performance="required">
     <para>
      Abra um shell e registre-se como <systemitem class="username">root</systemitem>.
     </para>
    </step>
    <step performance="required">
     <para>
      Crie o diretório para seu diretório de instalação local. Os exemplos geralmente usam o caminho <filename>/image/CDs/full-<replaceable>VERSÃO</replaceable>-<replaceable>ARQ</replaceable></filename>. Substitua os marcadores <replaceable>VERSÃO</replaceable> e <replaceable>ARQ</replaceable> pelos respectivos valores.
     </para>
    </step>
    <step performance="required">
     <para>
      Monte o meio. Substitua o marcador <replaceable>UNIDADE</replaceable> pelo respectivo dispositivo (em geral, <filename>dvd</filename>, <filename>cdrom</filename> etc.):
     </para>
<screen>mount -o loop /dev/<replaceable>DRIVE</replaceable> /mnt</screen>
    </step>
    <step performance="required">
     <para>
      Copie todo o conteúdo do meio para o diretório de instalação:
     </para>
<screen>cp -a /mnt/* /images/CDs/full-<replaceable>VERSION</replaceable>-<replaceable>ARCH</replaceable></screen>
    </step>
   </procedure>
   <para>
    Para usar a fonte de instalação local, tudo o que você precisa fazer é habilitá-la no elemento <literal>repository</literal>:
   </para>
<?dbfo-need height="6em"?>


<screen>&lt;repository type="..."&gt;
  &lt;!-- Remove the comment markers in the next line --&gt;
  &lt;!-- &lt;source path="/image/CDs/full-<replaceable>VERSION</replaceable>-<replaceable>ARCH</replaceable>" --&gt;
  &lt;source path="opensuse://openSUSE:11.0/standard"/&gt; 
&lt;/repository&gt;</screen>
  </sect2>

  <sect2 id="sec-kiwi-img">
   <title>Criando uma imagem</title>
   <para>
    Uma imagem é uma imagem de disco virtual contendo todas as partições, informações sobre o carregador de boot e pacotes, da mesma forma como reside em um disco real. Para criar uma imagem ISO, faça o seguinte:
   </para>
   <procedure id="pr-kiwi-img">

    <step performance="required">
     <para>
      Instale os pacotes <systemitem class="resource">kiwi</systemitem> e <systemitem class="resource">kiwi-doc</systemitem> e resolva qualquer dependência.
     </para>
    </step>
    <step performance="required">
     <para>
      Abra um shell e registre-se como <systemitem class="username">root</systemitem>.
     </para>
    </step>
    <step performance="required">
     <para>
      Copie o diretório <filename>/usr/share/doc/packages/kiwi/examples/suse-11.0/suse-oem-preload</filename> para seu diretório atual.
     </para>
    </step>
    <step performance="required">
     <para>
      Abra o arquivo <filename>config.xml</filename> e localize o elemento <literal>repository</literal>. Se desejar usar uma fonte de instalação local, consulte a <xref xrefstyle="select: label" linkend="sec-kiwi-img-createrepo"/> para obter mais informações.
     </para>
    </step>
    <step id="st-kiwi-prep" performance="required">
     <para>
      Execute o KIWI com o seguinte comando para preparar a primeira fase (<quote>extensão física</quote>):
     </para>
<screen>kiwi --prepare suse-oem-preload --root oem</screen>
    </step>
    <step performance="required">
     <para>
      Compile a imagem ISO:
     </para>
<screen>kiwi --create oem --type iso --destdir /tmp/myoem</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 id="sec-kiwi-img-nfs">
   <title>Criando uma imagem de pré-carregamento com o NFS</title>
   <para>
    Para criar uma imagem com a funcionalidade NFS, faça o seguinte:
   </para>
   <procedure id="pr-kiwi-img-nfs">
    <step performance="required">
     <para>
      Abra um shell e registre-se como <systemitem class="username">root</systemitem>.
     </para>
    </step>
    <step performance="required">
     <para>
      Copie o diretório <filename>/usr/share/doc/packages/kiwi/examples/suse-11.1/suse-oem-preload</filename> para seu diretório atual.
     </para>
    </step>
    <step performance="required">
     <para>
      Abra o arquivo <filename>suse-oem-preload/config.xml</filename> e localize o elemento <literal>packages</literal> com o atributo <literal>type="image"</literal>.
     </para>
    </step>
    <step performance="required">
     <para>
      Insira a seguinte linha entre <literal>&lt;packages type="image"&gt;</literal> e <literal>&lt;/packages&gt;</literal> e grave o arquivo:
     </para>
<screen>&lt;package name="nfs-client"/&gt;</screen>
    </step>
    <step performance="required">
     <para>
      Recompile a imagem, conforme descrito na <xref linkend="st-kiwi-prep"/>.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 id="sec-kiwi-moreinfo">
  <title>Para obter mais informações</title>
  <para>
   Encontre mais informações nos seguintes documentos no Portal KIWI em <ulink url="http://en.opensuse.org/Portal:KIWI"/>.
  </para>
 </sect1>
</chapter>
