<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="deployment_kiwi.xml" id="cha.autokiwi">

 <title>Implantação automatizada de imagens de pré-carregamento</title>
 <abstract>
  <para>
   Com o KIWI, você pode criar imagens do sistema operacional. Este capítulo descreve o processo de implantação de uma imagem do sistema na máquina cliente vazia. Para isso, você deverá criar uma imagem de pré-carregamento contendo uma imagem RAW inicializável. Esse arquivo contém duas partes importantes: uma tabela de partições e o sistema operacional real. A imagem RAW será gravada no disco rígido vazio e o sistema operacional aumentará o espaço em disco restante no primeiro boot.
  </para>

 </abstract>
 <para>
  Para criar a imagem, consulte a <xref linkend="sec.kiwi.img"/>. Ao criar a imagem ISO, você pode encontrar o arquivo RAW na pasta de destino. Há várias formas de descarregar uma imagem não processada no disco.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Conecte o disco a um servidor de implantação e copie a imagem para o dispositivo não processado.
   </para>
  </listitem>
  <listitem>
   <para>
    Use um servidor HTTP ou FTP para mandar a imagem não processada e descarregue-a no disco da máquina cliente.
   </para>
  </listitem>
  <listitem>
   <para>
    Crie uma imagem de boot de rede para obter a imagem e descarregá-la no disco. Esse é um método adequado para uma implantação em massa.
   </para>
  </listitem>
  <listitem>
   <para>
    Inicialize um disco de recuperação e faça o despejo manualmente pela imagem de recuperação.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Para uma inicialização rápida, convém usar um dos métodos descritos na <xref linkend="sec.autokiwi.manual"/>.
 </para>
 <sect1 id="sec.autokiwi.manual">
  <title>Implantando o sistema manualmente da imagem de recuperação</title>

  <variablelist>
   <varlistentry>
    <term>Implantando com arquivo ISO gerado do KIWI:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Grave a imagem ISO obtida do processo de compilação do KIWI. Consulte a <xref linkend="sec.kiwi.img"/> no CD/DVD
       </para>
      </listitem>
      <listitem>
       <para>
        Inicialize desta mídia para a máquina cliente.
       </para>
      </listitem>
      <listitem>
       <para>
        Selecione o disco rígido para instalação.
       </para>
      </listitem>
      <listitem>
       <para>
        Reinicie a máquina cliente e inicialize do disco rígido.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Implantando através do sistema de recuperação:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Inicialize a máquina cliente com um sistema de recuperação. Esses sistemas estão disponíveis em todos os CDs ou DVDs de instalação do SUSE.
       </para>
      </listitem>
      <listitem>
       <para>
        Efetue login como <systemitem class="username">root</systemitem>. Não digite senha.
       </para>
      </listitem>
      <listitem>
       <para>
        Configure sua rede. Se tiver o DHCP disponível na rede, use simplesmente o comando <command>ifup-dhcp eth0</command>. Se precisar fazer isso manualmente, use o comando <command>ip</command> para configurar sua rede. A saída que inicia o DHCP também informa a você o endereço IP do computador.
       </para>
      </listitem>
      <listitem>
       <para>
        Escute em uma porta não utilizada da rede, como <systemitem>1234</systemitem>, e descarregue os dados de entrada no disco com o seguinte comando:
       </para>
<screen>netcat -l -p 1234 &gt; /dev/sda</screen>
      </listitem>
      <listitem>
       <para>
        No imaging server, envie a imagem não processada à máquina cliente com o comando:
       </para>
<screen>netcat &lt;IP of client&gt; 1234 &lt; $HOME/preload_image/&lt;image_name&gt;</screen>
      </listitem>
      <listitem>
       <para>
        Quando a imagem for transferida, remova o sistema de recuperação da unidade de CD ou DVD e encerre a máquina cliente. Na reinicialização, o carregador de boot <literal>GRUB</literal> deve ser iniciado no cliente e o sistema de primeiro boot assumirá.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1>
  <title>Implantação automatizada com o Boot PXE</title>

  <para>
   Ao fazer várias instalações de um sistema operacional em hardware parecido, é útil preparar uma implantação em massa do sistema operacional e minimizar o tempo necessário para a implantação real. Este capítulo descreve esse processo. A meta é simplesmente ligar um computador, conectá-lo à rede, iniciar um boot de rede e aguardar até que ele seja desligado.
  </para>

  <para>
   As ações a seguir devem ser executadas para a realização dessa tarefa:
  </para>

  <variablelist>
   <varlistentry>
    <term>Configurar um servidor de boot e de instalação</term>
    <listitem>
     <para>
      Uma máquina dedicada é necessária e deve ser preparada para oferecer um boot PXE, e também um servidor ftp ou web para fornecer uma imagem de pré-carregamento. É recomendável disponibilizar memória suficiente na máquina para manter todos os dados de instalação necessários na memória. Para uma instalação padrão, é necessário que você tenha, no mínimo, 4 GByte de memória. É possível realizar todas as tarefas necessárias com o SUSE Linux Enterprise Server. Para obter mais informações, consulte a <xref linkend="sec.autokiwi.instserver"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Preparar uma imagem de pré-carregamento</term>
    <listitem>
     <para>
      A instalação real é feita copiando uma imagem não processada do sistema operacional para o novo disco rígido. Todos os recursos e as configurações devem ser preparados e testados com cuidado. Para gerar esse tipo de imagem, é possível usar o KIWI (disponível no SDK do sistema operacional SUSE Linux Enterprise). Para obter mais informações sobre criação de imagens com o KIWI, consulte o <xref linkend="cha.kiwi"/>. Para obter mais informações sobre os requisitos da imagem de pré-carregamento, consulte a <xref linkend="sec.autokiwi.preloadimage"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Criar um sistema inicial para implantação</term>
    <listitem>
     <para>
      Essa tarefa requer alguma experiência em Linux. Uma descrição de como realizar essa tarefa por meio de um exemplo de instalação está disponível na <xref linkend="sec.autokiwi.initrd"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Configurar o servidor de boot para implantação automática</term>
    <listitem>
     <para>
      O Boot PXE deve ser comunicado para inicializar o sistema de instalação que, por sua vez, usará a imagem pré-carregada do servidor e a copiará para o disco rígido.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <sect2 id="sec.autokiwi.instserver">
   <title>Configurar um servidor de boot e de instalação</title>
   <para>
    Há quatro etapas necessárias para realizar esta tarefa após a instalação do SUSE Linux Enterprise Server:
   </para>
   <procedure id="proc.autokiwi.instserver">
    <step performance="required">
     <para>
      Configure a fonte de instalação como descrito na <xref linkend="sec.deployment.remoteinst.instserver"/>. Escolha um servidor de rede HTTP ou FTP.
     </para>
    </step>
    <step performance="required">
     <para>
      Configure um servidor TFTP para manter a imagem de boot (essa imagem será criada em uma etapa posterior). Isso está descrito na <xref linkend="sec.deployment.remoteinst.boot.tftp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Configure um servidor DHCP para atribuir endereços IP a todas as máquinas e revelar o local do servidor TFTP para o sistema de destino. Isso está descrito na <xref linkend="sec.deployment.remoteinst.boot.dhcp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Prepare o boot PXE do servidor de instalação. Isso está descrito detalhadamente na <xref linkend="sec.deployment.remoteinst.boot.pxe"/>.
     </para>
    </step>
   </procedure>
   <para>
    Observe que o processo de instalação real será bastante beneficiado se você disponibilizar memória suficiente nesta máquina para manter a imagem de pré-carregamento. Além disso, o uso de gigabit ethernet agilizará o processo de implantação consideravelmente em comparação a redes mais lentas.
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.preloadimage">
   <title>Criando uma imagem de pré-carregamento</title>
   <para>
    O processo de criação de imagens com o KIWI está descrito na <xref linkend="sec.kiwi.img"/>. Entretanto, para criar imagens úteis para a implantação em massa, várias considerações devem ser feitas:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Uma imagem típica de pré-carregamento usará o seguinte tipo:
     </para>
<screen>&lt;type primary="true" filesystem="ext3" boot="oemboot/suse-SLES11"&gt;vmx&lt;/type&gt;</screen>
    </listitem>
    <listitem>
     <para>
      Durante a configuração de uma imagem de pré-carregamento, o processo de criação de imagem é executado várias vezes. Os repositórios necessários para criar a imagem devem estar disponíveis no computador local.
     </para>
    </listitem>
    <listitem>
     <para>
      Dependendo do uso desejado para o pré-carregamento, você deverá se esforçar para configurar o firstboot. Para obter mais informações sobre firstboot, consulte o <xref linkend="cha.deployment_firstboot"/>. Esse método também pode exigir que o usuário faça configurações iniciais na primeira inicialização do sistema.
     </para>
    </listitem>
    <listitem>
     <para>
      Vários recursos adicionais podem ser configurados na imagem, como adicionar repositórios de atualização ou fazer uma atualização na primeira inicialização. No entanto, é impossível descrever todas as possibilidades neste documento, e, dependendo dos requisitos, a criação da imagem de pré-carregamento requer profundo conhecimento do sistema de criação de imagens KIWI, assim como de diversas outras tecnologias usadas no <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    A imagem real para exibição deve estar disponível no servidor ftp ou http que você especificou no servidor de instalação.
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.initrd">
   <title>Criando um sistema inicial para a implantação de uma imagem de pré-carregamento</title>
   <para>
    Para executar uma implantação automática, é necessário iniciar o sistema Linux inicial no computador de destino. Durante a instalação típica, o kernel e o sistema de arquivos de RAM inicial são lidos de alguma mídia de boot e iniciados pelo bios. A funcionalidade necessária pode ser implementada no sistema de arquivos de RAM que, junto com o kernel, atuará como o sistema inicial.
   </para>
   <para>
    Os principais recursos que devem ser fornecidos pelo sistema inicial são a capacidade de acessar o disco rígido e a disponibilidade da conexão de rede. Ambas as funções dependem do hardware em que deseja implantar. Teoricamente, é possível criar um sistema inicial do zero, mas para facilitar essa tarefa, é possível também modificar o sistema de arquivos de RAM inicial usado pela máquina durante a inicialização.
   </para>
   <para>
    O procedimento a seguir é apenas um exemplo de como criar o sistema de arquivos de RAM inicial:
   </para>
   <procedure>
    <step performance="required">
     <para>
      Execute a instalação padrão do <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> no sistema de destino.
     </para>
    </step>
    <step performance="required">
     <para>
      Instale o pacote <systemitem>busybox</systemitem> no sistema.
     </para>
    </step>
    <step performance="required">
     <para>
      Crie um novo sistema de arquivos de RAM com o seguinte comando:
     </para>
<screen>mkinitrd -f busybox -D eth0</screen>
     <para>
      Observe que eth0 representa o dispositivo ethernet ao qual o cabo de rede é conectado. O parâmetro <systemitem>-f busybox</systemitem> adiciona o binário multichamadas <systemitem>busybox</systemitem> ao sistema de arquivos de RAM. Em seguida, vários comandos unix padrão ficam disponíveis dentro desse sistema.
     </para>
    </step>
    <step performance="required">
     <para>
      Copie o novo sistema de arquivos de RAM e o kernel ao servidor de boot com o comando:
     </para>
<screen>scp /boot/initrd /boot/vmlinuz pxe.example.com:</screen>
     <para>
      Substitua pxe.example.com pelo nome do seu servidor de boot local ou endereço IP.
     </para>
    </step>
    <step performance="required">
     <para>
      Efetue login no servidor de boot como usuário <systemitem class="username">root</systemitem> e crie um diretório no qual você possa modificar o sistema de arquivos de RAM:
     </para>
<screen>mkdir ~/bootimage</screen>
    </step>
    <step performance="required">
     <para>
      Mude seu diretório de trabalho para esse diretório com o comando <command>cd ~/bootimage</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Descompacte o sistema de arquivos de RAM inicial copiado com o comando:
     </para>
<screen>zcat ../initrd | cpio -i</screen>
    </step>
    <step performance="required">
     <para>
      Edite o arquivo <filename>run_all.sh</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Procure a linha a seguir, apague esta linha e o restante do arquivo:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 21-nfs.sh </screen>
    </step>
    <step performance="required">
     <para>
      Adicione as seguintes linhas ao final dos arquivos <filename>run_all.sh</filename>:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 92-install.sh
[ "$debug" ] &amp;&amp; echo running 92-install.sh
source boot/92-install.sh
[ "$modules" ] &amp;&amp; load_modules
     </screen>
    </step>
    <step performance="required">
     <para>
      Crie um novo script <filename>boot/92-install.sh</filename> com o seguinte conteúdo:
     </para>
<screen>#!/bin/bash
if [ "$(get_param rawimage)" ]; then
  rawimage=$(get_param rawimage)
  if  [ "$(get_param rawdevice)" ]; then
    rawdevice=$(get_param rawdevice)
    echo "wget -O ${rawdevice} ${rawimage}"
    wget -O ${rawdevice} ${rawimage}
    sync
    sleep 5
    echo "DONE"
  fi
fi
# /bin/bash
/bin/poweroff -f
</screen>
    </step>
    <step performance="required">
     <para>
      Para ter um shell de depuração antes de desligar o computador, remova o sinal de comentário antes de <filename>/bin/bash</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Torne esse script executável com o comando <command>chmod 755 boot/92-install.sh</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Crie um novo sistema de arquivos de RAM inicial com os comandos:
     </para>
<screen>mkdir -p /srv/tftpboot
find . | cpio --quiet -H newc -o | gzip -9 -n &gt; \
/srv/tftpboot/initrd.boot</screen>
    </step>
    <step performance="required">
     <para>
      Copie o kernel para esse diretório:
     </para>
<screen>cp ../vmlinuz /srv/tftpboot/linux.boot</screen>
    </step>
   </procedure>
   <para>
    O sistema de arquivos de RAM inicial agora está preparado para usar dois novos parâmetros de linha de comando do kernel. O parâmetro <systemitem>rawimage=&lt;URL&gt;</systemitem> é usado para identificar o local da imagem de pré-carregamento. Qualquer URL que seja compreendido por wget poderá ser usado. O parâmetro <systemitem>rawdevice=&lt;dispositivo&gt;</systemitem> é usado para identificar o dispositivo de blocos do disco rígido na máquina de destino.
   </para>
  </sect2>

  <sect2>
   <title>Configuração do servidor de boot</title>
   <para>
    A configuração do servidor de boot é discutida em detalhes em vários capítulos diferentes, conforme listado na <xref linkend="sec.autokiwi.instserver"/>. Esta seção apresenta uma lista de verificação que descreve as etapas necessárias para configurar o sistema.
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Configure um servidor dhcp. A sub-rede em que as máquinas estão instaladas precisa das linhas adicionais:
     </para>
<screen>filename "pxelinux.0";
next-server 192.168.1.115;</screen>
     <para>
      Neste exemplo, 192.168.1.115 é o endereço IP do servidor PXE pxe.example.com.
     </para>
    </listitem>
    <listitem>
     <para>
      Configure um servidor PXE conforme descrito na <xref linkend="sec.deployment.remoteinst.boot.pxe"/>. Ao editar <filename>/srv/tftpboot/pxelinux.cfg/default</filename>, adicione as seguintes entradas:
     </para>
<screen>default bootinstall
label bootinstall
  kernel linux.boot
  append initrd=initrd.boot \
  rawimage=ftp://192.168.1.115/preload/preloadimage.raw rawdevice=/dev/sda</screen>
    </listitem>
    <listitem>
     <para>
      Configure um servidor ftp e copie a imagem de pré-carregamento preparada para <filename>/srv/ftp/preload/preloadimage.raw</filename>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Teste sua configuração, inicializando o sistema de destino com o boot de rede PXE. Isso copia automaticamente a imagem pré-carregada preparada no disco rígido e desliga a máquina quando estiver tudo pronto.
   </para>
  </sect2>


 </sect1>







</chapter>
