<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE chapter
[
   <!ENTITY % entities SYSTEM "entity-decl.ent">
   %entities;
]>


<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="deployment_kiwi.xml" xml:id="cha-autokiwi"><title>Automatisierte Implementierung von Preload-Images</title><info><abstract>
  <para>
   Mit KIWI können Sie Betriebssystem-Images erstellen. Dieses Kapitel beschreibt, wie ein System-Image auf einem leeren Client-Computer bereitgestellt wird. Dazu müssen Sie ein Preload-Image erstellen, das ein bootfähiges RAW-Image enthält. Diese Datei enthält zwei wichtige Teile: eine Partitionstabelle und das eigentliche Betriebssystem. Dieses RAW-Image wird auf die leere Festplatte geschrieben, und beim ersten Bootvorgang dehnt sich das Betriebssystem auf den verbleibenden Plattenspeicher aus.
  </para>

 </abstract></info>

 
 
 <para>
  Weitere Informationen zum Erstellen eines solchen Image finden Sie unter <xref linkend="sec-kiwi-img"/>. Beim Aufbauen des ISO-Image finden Sie die RAW-Datei im Zielordner. Es gibt viele Möglichkeiten, ein RAW-Image auf einer Festplatte abzulegen.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Schließen Sie die Platte an einen Bereitstellungsserver an und kopieren Sie das Image auf das Raw-Gerät.
   </para>
  </listitem>
  <listitem>
   <para>
    Bereitstellen des RAW-Image über einen HTTP- oder FTP-Server und Ablegen auf der Festplatte des Client-Computers.
   </para>
  </listitem>
  <listitem>
   <para>
    Erstellen eines Netboot-Image zum Abrufen und Ablegen des Image auf der Platte; dies ist eine gute Methode zur Massenimplementierung.
   </para>
  </listitem>
  <listitem>
   <para>
    Booten eines Rettungsdatenträgers und manuelle Speicherung vom Rettungs-Image aus.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Für einen schnellen Start empfiehlt es sich, eine der in <xref linkend="sec-autokiwi-manual"/> beschriebenen Methoden zu verwenden.
 </para>
 <section xml:id="sec-autokiwi-manual">
  <title>Manuelles Implementieren des Systems vom Rettungs-Image</title>

  <variablelist>
   <varlistentry>
    <term>Implementierung mit generierter ISO-Datei von KIWI:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Brennen Sie das ISO-Image, das Sie vom KIWI-Erstellungsprozess erhalten (siehe <xref linkend="sec-kiwi-img"/> auf CD/DVD).
       </para>
      </listitem>
      <listitem>
       <para>
        Booten Sie von diesem Medium aus auf dem Client-Computer.
       </para>
      </listitem>
      <listitem>
       <para>
        Wählen Sie die Festplatte für die Installation aus.
       </para>
      </listitem>
      <listitem>
       <para>
        Starten Sie den Client-Computer neu und booten Sie von der Festplatte.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Implementierung über Rettungssystem:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Booten Sie den Client-Computer mit einem Rettungssystem. Solche Systeme stehen auf allen SUSE-Installations-CDs oder -DVDs zur Verfügung.
       </para>
      </listitem>
      <listitem>
       <para>
        Melden Sie sich als <systemitem class="username">root</systemitem>-Benutzer an. Geben Sie kein Passwort ein.
       </para>
      </listitem>
      <listitem>
       <para>
        Konfigurieren Sie Ihr Netzwerk. Wenn in Ihrem Netzwerk DHCP verfügbar ist, ist dies lediglich das Kommando <command>ifup-dhcp eth0</command>. Wenn dies manuell durchgeführt werden muss, verwenden Sie das Kommando <command>ip</command> zur Konfigurierung Ihres Netzwerks. Die Ausgabe, mit der DHCP startet, teilt Ihnen auch die IP-Adresse des Computers mit.
       </para>
      </listitem>
      <listitem>
       <para>
        Überwachen Sie einen unbenutzten Port Ihres Netzwerks wie <systemitem>1234</systemitem> und legen Sie die eingehenden Daten mit dem folgenden Kommando auf der Platte ab:
       </para>
<screen>netcat -l -p 1234 &gt; /dev/sda</screen>
      </listitem>
      <listitem>
       <para>
        Senden Sie auf dem Imaging-Server das RAW-Image mit dem folgenden Kommando an den Client-Computer:
       </para>
<screen>netcat &lt;IP of client&gt; 1234 &lt; $HOME/preload_image/&lt;image_name&gt;</screen>
      </listitem>
      <listitem>
       <para>
        Entfernen Sie nach der Übertragung des Image das Rettungssystem aus Ihrem CD- oder DVD-Laufwerk und fahren Sie den Client-Computer herunter. Beim erneuten Booten sollte der Boot-Loader <literal>GRUB</literal> auf dem Client gestartet werden. Das Firstboot-System übernimmt dann.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
  </variablelist>
 </section>
 <section>
  <title>Automatisierte Implementierung mit PXE-Boot</title>

  <para>
   Beim Durchführen mehrerer Installationen eines Betriebssystems auf ähnlicher Hardware ist es nützlich, eine Massenbereitstellung des Betriebssystems gründlich vorzubereiten und die erforderliche Zeit für die tatsächliche Bereitstellung zu minimieren. In diesem Kapitel wird dieser Vorgang beschrieben. Ziel ist es, den Computer einfach anzuschließen, ihn mit einem Netzwerk zu verbinden, einen Netzwerk-Boot zu starten und zu warten, bis er herunterfährt.
  </para>

  <para>
   Die folgenden Aktionen müssen ausgeführt werden, um diese Aufgabe zu erfüllen:
  </para>

  <variablelist>
   <varlistentry>
    <term>Einrichten eines Boot- und Installationsservers</term>
    <listitem>
     <para>
      Ein dedizierter Computer ist erforderlich, der so eingerichtet ist, dass er PXE-Boot sowie einen FTP- oder Webserver für die Bereitstellung eines Preload-Image bietet. Der Computer sollte über genügend Arbeitsspeicher verfügen, um alle erforderlichen Installationsdaten bereitzuhalten. Für eine Standardinstallation benötigen Sie mindestens 4 GB Arbeitsspeicher. Alle erforderlichen Aufgaben können mit SUSE Linux Enterprise Server erledigt werden. Weitere Informationen finden Sie unter <xref linkend="sec-autokiwi-instserver"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Vorbereiten eines Preload-Images</term>
    <listitem>
     <para>
      Die tatsächliche Installation erfolgt durch das Kopieren eines RAW-Image des Betriebssystems auf eine neue Festplatte. Alle Funktionen und Einstellungen müssen sorgfältig vorbereitet und geprüft werden. Für die Bereitstellung eines solchen Images kann KIWI verwendet werden (verfügbar im SDK des SUSE Linux Enterprise-Betriebssystems). Weitere Informationen über die Image-Erstellung mit KIWI erhalten Sie in <xref linkend="cha-kiwi"/>. Weitere Details über die Anforderungen des Preload-Image finden Sie in <xref linkend="sec-autokiwi-preloadimage"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Erstellen eines ersten Systems für die Bereitstellung</term>
    <listitem>
     <para>
      Für diese Aufgabe sind einige Linux-Kenntnisse erforderlich. Eine Beschreibung anhand einer Beispielinstallation finden Sie unter <xref linkend="sec-autokiwi-initrd"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Konfigurieren des Bootservers für die automatische Bereitstellung</term>
    <listitem>
     <para>
      PXE-Boot muss angewiesen werden, das Installationssystem zu starten, das wiederum das Preload-Image vom Server übernimmt und es auf die Festplatte kopiert.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <section xml:id="sec-autokiwi-instserver">
   <title>Einrichten eines Boot- und Installationsservers</title>
   <para>
    Es müssen vier Schritte ausgeführt werden, um diese Aufgabe nach der Installation von SUSE Linux Enterprise Server ausführen zu können:
   </para>
   <procedure xml:id="proc-autokiwi-instserver">
    <step>
     <para>
      Richten Sie die Installationsquelle ein wie in <xref linkend="sec-deployment-remoteinst-instserver"/> beschrieben. Wählen Sie einen HTTP- oder FTP-Netzwerkserver.
     </para>
    </step>
    <step>
     <para>
      Richten Sie einen TFTP-Server so ein, dass er ein Boot-Image enthält (dieses Image wird in einem späteren Schritt erstellt). Die Konfiguration eines solchen Servers wird in <xref linkend="sec-deployment-remoteinst-boot-tftp"/> beschrieben.
     </para>
    </step>
    <step>
     <para>
      Richten Sie einen DHCP-Server ein, um allen Computern IP-Adressen zuzuweisen und dem Zielsystem den Speicherort des TFTP-Servers bekannt zu geben. Die Konfiguration eines solchen Servers wird in <xref linkend="sec-deployment-remoteinst-boot-dhcp"/> beschrieben.
     </para>
    </step>
    <step>
     <para>
      Bereiten Sie den PXE-Boot des Installationsservers vor. Dies wird ausführlich in <xref linkend="sec-deployment-remoteinst-boot-pxe"/> beschrieben.
     </para>
    </step>
   </procedure>
   <para>
    Beachten Sie, dass es für den eigentlichen Installationsvorgang sehr vorteilhaft ist, wenn Sie diesem Computer genügend Arbeitsspeicher zur Verfügung stellen, in dem das Preload-Image gespeichert werden kann. Durch Verwendung von Gigabit-Ethernet wird der Bereitstellungsvorgang im Vergleich zu langsameren Netzwerken erheblich beschleunigt.
   </para>
  </section>

  <section xml:id="sec-autokiwi-preloadimage">
   <title>Erstellen eines Preload-Images</title>
   <para>
    Das Verfahren der Image-Erstellung mit KIWI wird in <xref linkend="sec-kiwi-img"/> beschrieben. Jedoch müssen bei der Image-Erstellung für Massenbereitstellungen mehrere Punkte berücksichtigt werden:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Ein typisches Preload-Image verwendet den folgenden Typ:
     </para>
<screen>&lt;type primary="true" filesystem="ext3" boot="oemboot/suse-SLES11"&gt;vmx&lt;/type&gt;</screen>
    </listitem>
    <listitem>
     <para>
      Beim Einrichten eines Preload-Images wird der Image-Erstellungsvorgang mehrmals ausgeführt. Die erforderlichen Repositorys für die Image-Erstellung sollten auf dem lokalen Computer verfügbar sein.
     </para>
    </listitem>
    <listitem>
     <para>
      Abhängig von der gewünschten Nutzung des Preloads sollten einige Mühen in die Konfiguration von Firstboot investiert werden. Weitere Details über Firstboot finden Sie in <xref linkend="cha-deployment-firstboot"/>. Mit dieser Methode können Sie auch festlegen, dass der Benutzer beim ersten Boot des Systems anfängliche Konfigurationen angeben muss.
     </para>
    </listitem>
    <listitem>
     <para>
      Viele zusätzliche Funktionen können im Image konfiguriert werden, z. B. das Hinzufügen von Aktualisierungs-Repositorys oder das Ausführen einer Aktualisierung beim ersten Booten. Jedoch können in diesem Dokument nicht alle Möglichkeiten beschrieben werden. Abhängig von den Anforderungen erfordert die Erstellung des Preload-Images eingehende Kenntnisse des Imaging-Systems KIWI sowie mehrerer anderer Techniken, die in <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> verwendet werden.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Das eigentliche Image, das bereitgestellt werden soll, muss auf dem FTP- oder HTTP-Server verfügbar sein, den Sie auf dem Installationsserver bereitgestellt haben.
   </para>
  </section>

  <section xml:id="sec-autokiwi-initrd">
   <title>Erstellen eines ersten Systems zur Implementierung eines Preload-Image</title>
   <para>
    Für die Ausführung einer automatischen Bereitstellung muss ein erstes Linux-System auf dem Zielcomputer gestartet werden. Während einer typischen Installation werden der Kernel und das erste RAM-Dateisystem von einem Bootmedium gelesen und durch das BIOS gestartet. Die benötigte Funktionalität kann im RAM-Dateisystem bereitgestellt werden, das zusammen mit dem Kernel als erstes System dient.
   </para>
   <para>
    Zu den Hauptfunktionen, die vom ersten System bereitgestellt werden müssen, gehören das Aktivieren des Zugriffs auf die Festplatte und das Herstellen der Netzwerkverbindung. Beide Funktionen hängen von der Hardware ab, auf der die Bereitstellung vorgenommen werden soll. Theoretisch ist es möglich, ein erstes System von Grund auf neu zu erstellen, zur Vereinfachung dieser Aufgabe ist es aber auch möglich, das anfängliche RAM-Dateisystem, das der Computer beim Booten verwendet, zu ändern.
   </para>
   <para>
    Die folgende Vorgehensweise ist nur ein Beispiel dafür, wie das erforderliche erste RAM-Dateisystem erstellt werden kann.
   </para>
   <procedure>
    <step>
     <para>
      Führen Sie eine Standardinstallation von <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> auf dem Zielsystem durch.
     </para>
    </step>
    <step>
     <para>
      Installieren Sie das Paket <systemitem>busybox</systemitem> auf dem System.
     </para>
    </step>
    <step>
     <para>
      Erstellen Sie mit dem folgenden Kommando ein neues RAM-Dateisystem:
     </para>
<screen>mkinitrd -f busybox -D eth0</screen>
     <para>
      Beachten Sie, dass eth0 das Ethernet-Gerät darstellt, an das Ihr Netzwerkkabel angeschlossen ist. Der Parameter <systemitem>-f busybox</systemitem> fügt dem RAM-Dateisystem das ausführbare Programm <systemitem>busybox</systemitem> hinzu, das mehrfach aufgerufen werden kann. Danach stehen in diesem System viele UNIX-Standardkommandos zur Verfügung.
     </para>
    </step>
    <step>
     <para>
      Kopieren Sie das neue RAM-Dateisystem und den Kernel mit dem folgenden Kommando auf Ihren Boot-Server:
     </para>
<screen>scp /boot/initrd /boot/vmlinuz pxe.example.com:</screen>
     <para>
      Ersetzen Sie pxe.example.com durch den Namen Ihres lokalen Boot-Servers oder die IP-Adresse.
     </para>
    </step>
    <step>
     <para>
      Melden Sie sich bei Ihrem Boot-Server als <systemitem class="username">root</systemitem>-Benutzer an und erstellen Sie ein Verzeichnis, in dem Sie das RAM-Dateisystem ändern können:
     </para>
<screen>mkdir ~/bootimage</screen>
    </step>
    <step>
     <para>
      Ändern Sie Ihr Arbeitsverzeichnis mithilfe des Kommandos <command>cd ~/bootimage</command> in dieses Verzeichnis.
     </para>
    </step>
    <step>
     <para>
      Entpacken Sie mithilfe des folgenden Kommandos das zuvor kopierte erste RAM-Dateisystem:
     </para>
<screen>zcat ../initrd | cpio -i</screen>
    </step>
    <step>
     <para>
      Bearbeiten Sie die Datei <filename>run_all.sh</filename>.
     </para>
    </step>
    <step>
     <para>
      Suchen Sie die folgende Zeile, löschen Sie sie und den Rest der Datei:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 21-nfs.sh </screen>
    </step>
    <step>
     <para>
      Fügen Sie die folgenden Zeilen an das Ende der Dateien <filename>run_all.sh</filename>:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 92-install.sh
[ "$debug" ] &amp;&amp; echo running 92-install.sh
source boot/92-install.sh
[ "$modules" ] &amp;&amp; load_modules
     </screen>
    </step>
    <step>
     <para>
      Erstellen Sie ein neues Skript mit dem Namen <filename>boot/92-install.sh</filename> und dem folgenden Inhalt:
     </para>
<screen>#!/bin/bash
if [ "$(get_param rawimage)" ]; then
  rawimage=$(get_param rawimage)
  if  [ "$(get_param rawdevice)" ]; then
    rawdevice=$(get_param rawdevice)
    echo "wget -O ${rawdevice} ${rawimage}"
    wget -O ${rawdevice} ${rawimage}
    sync
    sleep 5
    echo "DONE"
  fi
fi
# /bin/bash
/bin/poweroff -f
</screen>
    </step>
    <step>
     <para>
      Wenn Sie vor dem Abschalten des Computers eine Debug-Shell wünschen, entfernen Sie das Kommentarzeichen vor <filename>/bin/bash</filename>.
     </para>
    </step>
    <step>
     <para>
      Machen Sie dieses Skript ausführbar mithilfe des Kommandos <command>chmod 755 boot/92-install.sh</command>.
     </para>
    </step>
    <step>
     <para>
      Erstellen Sie ein neues anfängliches RAM-Dateisystem mit den folgenden Kommandos:
     </para>
<screen>mkdir -p /srv/tftpboot
find . | cpio --quiet -H newc -o | gzip -9 -n &gt; \
/srv/tftpboot/initrd.boot</screen>
    </step>
    <step>
     <para>
      Kopieren Sie den Kernel in dieses Verzeichnis.
     </para>
<screen>cp ../vmlinuz /srv/tftpboot/linux.boot</screen>
    </step>
   </procedure>
   <para>
    Das erste RAM-Dateisystem ist nun für zwei neue Kernel-Kommandozeilenparameter vorbereitet. Der Parameter <systemitem>rawimage=&lt;URL&gt;</systemitem> wird benutzt, um den Speicherort des Preload-Image zu identifizieren. Jede URL, die von wget verstanden wird, ist verwendbar. Der Parameter <systemitem>rawdevice=&lt;device&gt;</systemitem> wird verwendet, um das Block-Gerät für die Festplatte auf dem Zielcomputer zu identifizieren.
   </para>
  </section>

  <section>
   <title>Konfiguration des Boot-Servers</title>
   <para>
    Die Konfiguration des Boot-Servers wird ausführlich in mehreren Kapiteln behandelt. Siehe dazu die Liste in <xref linkend="sec-autokiwi-instserver"/>. Dieser Abschnitt enthält eine Prüfliste mit den Schritten, die zur Konfiguration des Systems erforderlich sind.
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Richten Sie einen DHCP-Server ein. Das Subnetz, in dem die Computer installiert sind, benötigt die folgenden Zeilen:
     </para>
<screen>filename "pxelinux.0";
next-server 192.168.1.115;</screen>
     <para>
      In diesem Beispiel ist 192.168.1.115 die IP-Adresse des PXE-Servers pxe.example.com.
     </para>
    </listitem>
    <listitem>
     <para>
      Konfigurieren Sie einen PXE-Server wie in <xref linkend="sec-deployment-remoteinst-boot-pxe"/> beschrieben. Fügen Sie beim Bearbeiten von <filename>/srv/tftpboot/pxelinux.cfg/default</filename> die folgenden Einträge hinzu:
     </para>
<screen>default bootinstall
label bootinstall
  kernel linux.boot
  append initrd=initrd.boot \
  rawimage=ftp://192.168.1.115/preload/preloadimage.raw rawdevice=/dev/sda</screen>
    </listitem>
    <listitem>
     <para>
      Richten Sie einen FTP-Server ein und kopieren Sie Ihre vorbereiteten Preload-Images nach <filename>/srv/ftp/preload/preloadimage.raw</filename>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Testen Sie Ihr Setup, indem Sie das Zielsystem mit dem PXE-Netzwerk-Boot starten. Damit wird das vorbereitete Preload-Image automatisch auf die Festplatte kopiert und der Computer zum Schluss abgeschaltet.
   </para>
  </section>


 </section>







</chapter>
