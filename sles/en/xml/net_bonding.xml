<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<sect1 id="sec.bond">
 <title>Setting Up Bonding Devices</title>

 <para>
  For some systems, there is a desire to implement network connections that
  comply to more than the standard data security or availability
  requirements of a typical Ethernet device. In these cases, several
  Ethernet devices can be aggregated to a single bonding device.
 </para>

 <para>
  The configuration of the bonding device is done by means of bonding module
  options. The behavior is mainly affected by the mode of the bonding
  device. By default, this is <systemitem>mode=active-backup</systemitem>
  which means that a different slave device will become active if the active
  slave fails.
 </para>

 <tip>
  <title>Bonding and Xen</title>
  <para>
   Using bonding devices is only of interest for machines where you have
   multiple real network cards available. In most configurations, this means
   that you should use the bonding configuration only in &dom0;. Only if you
   have multiple network cards assigned to a &vmguest; system it may also be
   useful to set up the bond in a &vmguest;.
  </para>
 </tip>

 <para>
  To configure a bonding device, use the following procedure:
 </para>

 <procedure>
  <step>
   <para>
    Run <menuchoice><guimenu>&yast;</guimenu> <guimenu>Network
    Devices</guimenu> <guimenu>Network Settings</guimenu></menuchoice>.
   </para>
  </step>
  <step>
   <para>
    Use <guimenu>Add</guimenu> and change the <guimenu>Device Type</guimenu>
    to <guimenu>Bond</guimenu>. Proceed with <guimenu>Next</guimenu>.
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"></imagedata>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"></imagedata>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>
    Select how to assign the IP address to the bonding device. Three methods
    are at your disposal:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      No IP Address
     </para>
    </listitem>
    <listitem>
     <para>
      Dynamic Address (with DHCP or Zeroconf)
     </para>
    </listitem>
    <listitem>
     <para>
      Statically assigned IP Address
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Use the method that is appropriate for your environment.
   </para>
  </step>
  <step>
   <para>
    In the <guimenu>Bond Slaves</guimenu> tab, select the Ethernet devices
    that should be included into the bond by activating the related check
    box.
   </para>
  </step>
  <step>
   <para>
    Edit the <guimenu>Bond Driver Options</guimenu>. The modes that are
    available for configuration are the following:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      balance-rr
     </para>
    </listitem>
    <listitem>
     <para>
      active-backup
     </para>
    </listitem>
    <listitem>
     <para>
      balance-xor
     </para>
    </listitem>
    <listitem>
     <para>
      broadcast
     </para>
    </listitem>
    <listitem>
     <para>
      802.3ad
     </para>
    </listitem>
    <listitem>
     <para>
      balance-tlb
     </para>
    </listitem>
    <listitem>
     <para>
      balance-alb
     </para>
    </listitem>
   </itemizedlist>
  </step>
  <step>
   <para>
    Make sure that the parameter <literal>miimon=100</literal> is added to
    the <guimenu>Bond Driver Options</guimenu>. Without this parameter, the
    data integrity is not checked regularly.
   </para>
  </step>
  <step>
   <para>
    Click <guimenu>Next</guimenu> and leave &yast; with
    <guimenu>OK</guimenu> to create the device.
   </para>
  </step>
 </procedure>

 <para>
  All modes, and many more options are explained in detail in the
  <guimenu>Linux Ethernet Bonding Driver HOWTO</guimenu> found at
  <filename>/usr/src/linux/Documentation/networking/bonding.txt</filename>
  after installing the package <systemitem>kernel-source</systemitem>.
 </para>

 <sect2>
  <title>Hotplugging of Bonding Slaves</title>
  <para>
   In specific network environments (such as High Availability), there are
   cases when you need to replace a bonding slave interface with another
   one. The reason may be a constantly failing network device. The solution
   is to set up hotplugging of bonding slaves.
  </para>
  <para>
   The bond is configured as usual (according to <command>man 5
   ifcfg-bonding</command>), for example:
  </para>
<screen>
ifcfg-bond0   
          STARTMODE='auto' # or 'onboot'  
          BOOTPROTO='static'   
          IPADDR='192.168.0.1/24'   
          BONDING_MASTER='yes'   
          BONDING_SLAVE_0='eth0'   
          BONDING_SLAVE_1='eth1'   
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'
</screen>
  <para>
   but the slaves are specified with <literal>STARTMODE=hotplug</literal>
   and <literal>BOOTPROTO=none</literal>:
  </para>
<screen>
ifcfg-eth0   
          STARTMODE='hotplug'   
          BOOTPROTO='none'   

ifcfg-eth1   
          STARTMODE='hotplug'   
          BOOTPROTO='none'
</screen>
  <para>
   <literal>BOOTPROTO=none</literal> uses the ethtool options (when
   provided), but does not set the link up on <command>ifup eth0</command>.
   The reason is that the slave interface is controlled by the bond master.
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal> causes the slave interface to join
   the bond automatically as soon as it is available.
  </para>
  <para>
   The <systemitem>udev</systemitem> rules in
   <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> have to be
   changed to match the device by bus ID (udev
   <systemitem>KERNELS</systemitem> keyword equal to "SysFS BusID" as
   visible in <command>hwinfo --netcard</command>) instead of by MAC address to allow to replacement of defective
   hardware (a network card in the same slot but with a different MAC), and
   to avoid confusion as the bond changes the MAC address of all its slaves.
  </para>
  <para>
   For example:
  </para>
<screen>
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"
</screen>
  <para>
   At boot time, <filename>/etc/init.d/network</filename> does not wait for
   the hotplug slaves, but for the bond to become ready, which requires at
   least one available slave. When one of the slave interfaces gets removed
   (unbind from NIC driver, <command>rmmod</command> of the NIC driver or
   true PCI hotplug remove) from the system, the kernel removes it from the bond
   automatically. When a new card is added to the system (replacement of the
   hardware in the slot), <systemitem>udev</systemitem> renames it using the
   bus-based persistent name rule to the name of the slave, and calls
   <command>ifup</command> for it. The <command>ifup</command> call
   automatically joins it into the bond.
  </para>
 </sect2>

<!-- 
  http://www.cyberciti.biz/howto/question/static/linux-ethernet-bonding-driver-howto.php
  - this is not as fresh as the kernel documentation!
  -->
</sect1>
