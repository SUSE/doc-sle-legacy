<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="depl_smt.xml" id="cha.smt">
 <title>登録管理</title>

 <para>
  SUSE Linux Enterprise Server 11またはSUSE Linux Enterprise Desktop 11を実行するマシンは、Novell Customer CenterやNUサーバと直接通信するのではなく、ローカルのSubscription Management Toolサーバに登録することにより、そこからソフトウェアアップデートをダウンロードするように設定できます。SMTサーバをクライアントの登録用とローカルのアップデートソースとして使用するには、先にネットワーク内にSMTサーバを設定する必要があります。SMTサーバソフトウェアは、SUSE Linux Enterprise Serverのアドオンとして配布されます。その設定については、『<emphasis>Subscription Management Tool Guide</emphasis>』に説明があります。SMTサーバに登録するように設定するクライアントには、アドオンをインストールする必要はありません。
 </para>
 <para>
  SMTサーバにクライアントを登録するには、クライアントにサーバのURLを指定する必要があります。登録時には、クライアントとサーバはHTTPSプロトコルを介して通信するため、クライアントがサーバの証明書を信用していることを確認する必要があります。SMTサーバがデフォルトのサーバ証明書を使用するよう設定されている場合、<literal>http://<replaceable>FQDN</replaceable>/smt.crt</literal>でHTTPプロトコルを使用することで、SMTサーバでCA証明書を使用できます。この場合は、証明書を操作する必要はありません。異なる設定を行わない限り、登録プロセスにより、そこから自動的に証明書がダウンロードされます。CA証明書が外部認証局から発行されている場合は、サーバのCA証明書へのパスを入力する必要があります。
 </para>
 <note>
  <title><literal>*.novell.com</literal>サブドメインへの登録</title>
  <para>
   <literal>*.novell.com</literal>サブドメインに登録しようとすると、(セキュリティ上の理由で)登録時に証明書がダウンロードされず、証明書の処理は実行されません。そのような場合は、別のドメイン名またはIP番号を使用してください。
  </para>
 </note>
 <para>
  この情報を指定してクライアントマシンがSMTを使用するように設定する方法は、複数あります。1つ目は、必要な情報をブート時にカーネルパラメータを介して指定する方法です。2つ目は、AutoYaSTプロファイルを使用してクライアントを設定する方法です。Subscription Management Toolで配布されるスクリプト<command>clientSetup4SMT.sh</command>をクライアント上で実行して、特定のSMTサーバへの登録を行えるようにする方法もあります。これらの方法については次のセクションに説明があります。
 </para>
 <sect1 id="smt.client.parameters">
  <title>カーネルパラメータを使用したSMTサーバへのアクセス</title>

  <para>
   コンピュータのブート時にカーネルパラメータ<literal>regurl</literal>および<literal>regcert</literal>を使用して、SMTを使用するようにクライアントを設定できます。1つ目のパラメータは必須で、2つ目のパラメータは任意です。
  </para>

  <variablelist>
   <varlistentry>
    <term>regurl</term>
    <listitem>
     <para>
      SMTサーバのURLURLは、<literal>https://<replaceable>FQDN</replaceable>/center/regsvc/</literal>というフォーマットで、<replaceable>FQDN</replaceable>はSMTサーバの完全修飾ホスト名にする必要があります。これはSMTサーバで使用されるサーバ証明書のFQDNと同じである必要があります。例:
     </para>
<screen>regurl=https://smt.example.com/center/regsvc/</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>regcert</term>
    <listitem>
     <para>
      SMTサーバのCA証明書の場所。次のいずれかの場所を指定します。
     </para>
     <variablelist>
      <varlistentry>
       <term>URL</term>
       <listitem>
        <para>
         証明書をダウンロードできる、リモートの場所(HTTP、HTTPS、またはFTP)。例:
        </para>
<screen>regcert=http://smt.example.com/smt.crt</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>フロッピー(Floppy)</term>
       <listitem>
        <para>
         フロッピーの場所を指定します。フロッピーはブート時に挿入する必要があります(ただし、フロッピーが挿入されていなくても、挿入を求められることはありません)。値としては、まず、文字列<literal>floppy</literal>を入力し、その後に、証明書へのパスを指定します。例:
        </para>
<screen>regcert=floppy/smt/smt-ca.crt</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>ローカルパス</term>
       <listitem>
        <para>
         ローカルマシン上の証明書への絶対パス。例:
        </para>
<screen>regcert=/data/inst/smt/smt-ca.cert</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>Interactive</term>
       <listitem>
        <para>
         <literal>ask</literal>を使用してインストール中にポップアップメニューを開き、証明書へのパスを指定します。AutoYaSTでは、このオプションを使用しないでください。例:
        </para>
<screen>regcert=ask</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>証明書のインストールの無効化</term>
       <listitem>
        <para>
         アドオン製品によって証明書がインストールされる場合、または公式の認証局によって発行される証明書を使用している場合は、<literal>done</literal>を使用します。例:
        </para>
<screen>regcert=done</screen>
       </listitem>
      </varlistentry>
     </variablelist>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>入力ミスに注意してください</title>
   <para>
    入力した値が正しいことを確認してください。<literal>regurl</literal>が正しく指定されていないと、アップデートソースの登録が失敗します。
   </para>
   <para>
    <literal>regcert</literal>に正しくない値が入力されると、証明書へのローカルパスの指定を求められます。<literal>regcert</literal>が指定されていない場合は、デフォルトで<literal>http://<replaceable>FQDN</replaceable>/smt.crt</literal>が使用されます。ここで、<literal>FQDN</literal>はSMTサーバ名です。
   </para>
  </warning>

  <warning>
   <title>SMTサーバ証明書の変更</title>
   <para>
    SMTサーバが、信頼されていない新しいCAから新しい証明書を取得する場合、クライアントは新しいCA証明書ファイルをフェッチする必要があります。これは登録プロセスで自動的に実行されます。ただし、そのためには、インストール時のURLの使用で証明書が取得されたか、または<literal>regcert</literal>パラメータの省略によってデフォルトURLが使用されている必要があります。他の方法(フロッピーやローカルパスなど)でロードしたCA証明書は、更新されません。
   </para>
  </warning>
 </sect1>
 <sect1 id="smt.client.autoyast">
  <title>AutoYaSTプロファイルを使用したクライアントの設定</title>

  <para>
   クライアントは、AutoYaSTプロファイルによってSMTサーバに登録するように設定できます。AutoYaSTプロファイルの作成と、自動インストールのための準備に関する一般的な情報については、<xref linkend="cha.deployment.autoinst"/>を参照してください。このセクションでは、SMT固有の設定についてのみ説明します。
  </para>

  <para>
   AutoYaSTを使用してSMT固有のデータを設定するには、次の手順に従います。
  </para>

  <procedure>
   <step performance="required">
    <para>
     <systemitem class="username">root</systemitem>としてYaSTを起動し、<menuchoice><guimenu>その他</guimenu><guimenu>自動インストール</guimenu></menuchoice>の順に選択して、AutoYaST GUIを起動します。
    </para>
    <para>
     コマンドラインからは<command>yast2 autoyast</command>コマンドを使用してAutoYaST GUIを起動できます。

    </para>
   </step>
   <step performance="required">
    <para>
     <menuchoice><guimenu>ファイル</guimenu><guimenu>開く</guimenu></menuchoice>を使用して既存のプロファイルを開き、<menuchoice><guimenu>ツール</guimenu><guimenu>Create Reference Profile</guimenu></menuchoice>を使用して現在のシステムの設定に基づきプロファイルを作成するか、または空のプロファイルから作成します。
    </para>
   </step>
   <step performance="required">
    <para>
     <menuchoice><guimenu>サポート</guimenu><guimenu>ノベルカスタマセンターの環境設定</guimenu></menuchoice>の順に選択します。現在の設定の概要が表示されます。
    </para>
   </step>
   <step performance="required">
    <para>
     <guimenu>編集</guimenu>をクリックします。
    </para>
   </step>
   <step performance="required">

    <para>
     インストール中に自動で登録を行うには、<guimenu>製品登録の実行</guimenu>を選択します。<guimenu>ハードウェアプロファイル</guimenu>と<guimenu>オプションの情報</guimenu>を選択してお使いのシステムからの情報を含めることができます。
    </para>
   </step>
   <step performance="required">
    <para>
     <guimenu>SMT Server (SMTサーバ)</guimenu>でURLを設定し、オプションで<guimenu>SMT Certificate (SMT証明書)</guimenu>で証明書の場所を設定します。設定可能な値はカーネルパラメータ<literal>regurl</literal>および<literal>regcert</literal>と同じです (<xref linkend="smt.client.parameters"/>を参照)。ただし、<literal>regcert</literal>の<literal>ask</literal>値はユーザの操作を必要とするため、AutoYaSTでは有効ではない点が異なります。これを使用する場合、登録プロセスはスキップされます。
    </para>
   </step>
   <step performance="required">
    <para>
     システムに配置する必要がある他の設定を実行します。
    </para>
   </step>
   <step performance="required">
    <para>
     <menuchoice><guimenu>ファイル</guimenu><guimenu>名前を付けて保存</guimenu></menuchoice>の順に選択して、<filename>autoinst.xml</filename>のようにファイル名をプロファイルに入力します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="smt.client.clientsetupscript">
  <title>clientSetup4SMT.shスクリプトを使用したクライアントの設定</title>

  <para>
   <command>/usr/share/doc/packages/smt/clientSetup4SMT.sh</command>スクリプトはSMTで提供されます。このスクリプトを使用すると、クライアントマシンがSMTサーバを使用するよう設定したり、または別のSMTサーバを使用するよう再設定したりすることができます。
  </para>

  <para>
   <command>clientSetup4SMT.sh</command>スクリプトを使用してクライアントマシンがSMTを使用するよう設定するには、次の手順に従います。
  </para>

  <procedure>
   <step performance="required">
    <para>
     <filename>/usr/share/doc/packages/smt/clientSetup4SMT.sh</filename>スクリプトをSMTサーバからクライアントマシンにコピーします。
    </para>
   </step>
   <step performance="required">
    <para>
     <systemitem class="username">root</systemitem>として、スクリプトをクライアントマシンで実行します。スクリプトは次の2つの方法で実行できます。1つ目の方法では、スクリプト名に続けて次の登録URLを入力します: <command>/clientSetup4SMT.sh <replaceable>registration_URL</replaceable></command>、たとえば、<command>/clientSetup4SMT.sh https://smt.example.com/center/regsvc</command>です。2つ目の方法では、スクリプト名に続けて<option>--host</option>オプション、次にSMTサーバのホスト名を入力します: <command>./clientSetup4SMT.sh --host <replaceable>server_hostname</replaceable></command>、たとえば、<command>/clientSetup4SMT.sh --host smt.example.com</command>です。
    </para>
    
    <important>
     <title><option>--host</option>パラメータ</title>
     <para>
      <option>--host</option>パラメータで指定するホスト名は、証明書の発行先と同じ名前にする必要があります。また、証明書の名前が完全修飾ホスト名(たとえば、smt.example.com)の場合は、それに従って入力する必要があります。<quote>短縮</quote>名(smt)を入力すると<command>clientSetup4SMT.sh</command>スクリプトが失敗する原因になります。 
     </para>
    </important>
    
   </step>
   <step performance="required">
    <para>
     スクリプトはサーバのCA証明書をダウンロードします。<keycap>y</keycap>を押して受諾します。
    </para>
   </step>
   <step performance="required">
    <para>
     スクリプトはクライアント上で必要な変更をすべて実行します。ただし、登録自体はスクリプトによっては実行されません。
    </para>
   </step>
   <step performance="required">
    <para>
     クライアント上で<command>suse_register</command>を実行するか、<command>yast2 inst_suse_register</command>モジュールを実行して、登録を行います。
    </para>
   </step>
  </procedure>




 </sect1>
 <sect1>
  <title>SMTテスト環境へのクライアントの登録</title>

  <para>
   クライアントを運用環境ではなくテスト環境で登録するよう設定するには、クライアントコンピュータ上で次を設定して、<filename>/etc/suseRegister.conf</filename>を変更します。
   
   
  </para>

<screen>register = command=register&amp;testenv=1</screen>

  <para>
   テスト環境でのSMTの使用の詳細については、『<emphasis>Subscription Management Tool Guide</emphasis>』を参照してください。
  </para>
 </sect1>
</chapter>
