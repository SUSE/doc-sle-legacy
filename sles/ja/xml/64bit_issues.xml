<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="64bit_issues.xml" id="cha.64bit">
 <title>64ビットシステム環境での32ビットと64ビットのアプリケーション</title><indexterm> <primary>64ビットLinux</primary> </indexterm>
 <para>
  <phrase role="productname"><phrase os="sles">SUSE® Linux Enterprise Server</phrase></phrase>は<phrase os="sles">複数の</phrase>64ビットプラットフォームで利用できます。ただし、付属のすべてのアプリケーションが64ビットプラットフォームに移植されている訳ではありません。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>は、64ビットシステム環境での32ビットアプリケーションの使用をサポートしています。この章では、このサポートを64ビットの<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>プラットフォームで実装する方法について簡潔に説明します。また、32ビットアプリケーションの実行方法(ランタイムサポート)、および32ビットと64ビットのシステム環境の両方で実行できるように32ビットアプリケーションをコンパイルする方法について説明します。さらに、カーネルAPIに関する情報、および32ビットアプリケーションを64ビットカーネルで実行する方法についても説明します。
 </para>
 <para>
  <phrase os="sles">i64ビットプラットフォームであるa64、ppc64、System z、x86_64</phrase>に対応した<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>は、既存の32ビットアプリケーションが64ビット環境で<quote>出荷してすぐに</quote><phrase os="sles">対応する32ビットプラットフォームには、ia64のx86、ppc64のppc、およびx86_64のx86があります。</phrase>このサポートにより、対応する 64ビット移植版が使用可能になるのを待たなくても、使用したい 32ビットアプリケーションを引き続き使用できます。<phrase os="sles">現在のppc64システムは、大部分のアプリケーションを 32ビットモードで実行しますが、 64ビットアプリケーションを実行することもできます。</phrase>
 </para>
 <sect1 id="sec.64bit.runt">
  <title>ランタイムサポート</title><indexterm> <primary>64ビットLinux</primary><secondary>ランタイムサポート</secondary> </indexterm>

  <important>
   <title>アプリケーションバージョン間の競合</title>
   <para>
    アプリケーションが32ビットと64ビットの両方の環境で使用可能な場合に、両方のバージョンを同時にインストールすると問題が生じます。そのような場合は、2つのバージョンのどちらかだけをインストールして使用してください。
   </para>
   <para>
    PAM(プラグ可能認証モジュール)は、このルールの例外です。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>は、ユーザとアプリケーションを仲介するレイヤとしての認証プロセスでPAMを使用します。また、 32ビットアプリケーションも実行する64ビットオペレーティングシステムでは、常に両バージョンのPAMモジュールをインストールする必要があります。
   </para>
  </important>

  <para>
   正しく実行するために、すべてのアプリケーションにはライブラリが必要です。しかし残念ながら、32ビットバージョンと64ビットバージョンのライブラリの名前は同じです。そのため、ライブラリを別の方法で区別する必要があります。
  </para>

  <para>
   32ビットバージョンとの互換性を維持するために、ライブラリは32ビット環境の場合と同じシステム内の場所に格納されます。libc.so.6<filename>の32ビットバージョンは、32ビットと64ビットのどちらの環境でも</filename>/lib/libc.so.6<filename>の下にあります。</filename>
  </para>

  <para>
   64ビットのすべてのライブラリとオブジェクトファイルは、<filename>lib64</filename>というディレクトリにあります。通常、<filename>/lib</filename>および<filename>/usr/lib</filename>の下にある64ビットのオブジェクトファイルは、<filename>/lib64</filename>および<filename>/usr/lib64</filename>の下にあります。つまり、両方のバージョンのファイル名を変更しなくても済むように、32ビットライブラリ用の領域は<filename>/lib</filename>および<filename>/usr/lib</filename>の下になっています。
  </para>

  <para>
   ワードサイズに依存しないデータコンテンツを持つ、32ビットの<filename>/lib</filename>ディレクトリ中のサブディレクトリは移動されません。このスキームは、LSB (Linux Standards Base)とFHS (File System Hierarchy Standard)に準拠しています。
  </para>

  <para os="sles" arch="ipf">
   ia64用の64ビットライブラリは、標準<filename>lib</filename>ディレクトリ内にあり、<filename>lib64</filename>ディレクトリも<filename>lib32</filename>ディレクトリも存在しません。ia64は、32ビットx86コードをエミュレーションで実行します。基本的なライブラリセットは、<filename>/emul/ia32-linux/lib</filename>および<filename>/emul/ia32-linux/usr/lib</filename>にインストールされます。
  </para>


 </sect1>
 <sect1 id="sec.64bit.devel">
  <title>ソフトウェア開発</title><indexterm> <primary>64ビットlinux</primary><secondary>ソフトウェア開発</secondary> </indexterm>

  <para os="sles">
   すべての64ビットアーキテクチャで、64ビットオブジェクトの開発がサポートされています。32ビットコンパイル機能のサポートレベルは、アーキテクチャによって異なります。32ビットコンパイル機能は、GCC (GNU Compiler Collection)やbinutilsによるツールチェーンの各種実装オプションになっています。Binutilsには、アセンブラ<command>as</command>とリンカー<command>ld</command>が含まれています。
  </para>

  <variablelist os="sles">
   <varlistentry>
    <term>biarchコンパイラ</term>
    <listitem>
     <para>
      32ビットと64ビットのオブジェクトはどちらもbiarch開発ツールチェーンで生成できます。biarch開発ツールチェーンを使用して、32ビットと64ビットのオブジェクトを生成できます。ほぼすべてのプラットフォームにおいて、デフォルトでは64ビットオブジェクトのコンパイルが実行されます。32ビットオブジェクトは、特殊なフラグを使用すれば生成できます。この特殊なフラグは、GCCでは<option>-32</option>です。binutilsのフラグはアーキテクチャによって異なりますが、GCCは正しいフラグをリンカーやアセンブラに転送します。現在では、amd64 (x86とamd64の命令の開発をサポート)、System z、およびppc64用のbiarch開発ツールチェーンが存在します。通常、32ビットオブジェクトはppc64プラットフォームで作成されます。-m64<literal>フラグは、64ビットオブジェクトの生成に使用する必要があります。</literal>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>未サポート</term>
    <listitem>
     <para>
      <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>では、すべてのプラットフォームで32ビットソフトウェアを直接開発できるとは限りません。ia64でx86用のアプリケーションを開発するには、対応する32ビットバージョンの<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>を使用します。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  

  <para>
   すべてのヘッダファイルは、アーキテクチャに依存しない形式で作成する必要があります。インストール済みの32ビットと64ビットのライブラリには、インストール済みのヘッダファイルに対応するAPI (アプリケーションプログラミングインタフェース)が必要です。標準の<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>環境は、この原則に従って設計されています。ライブラリを手動で更新した場合は、各自でAPIの問題を解決してください。
  </para>
 </sect1>
 <sect1 id="sec.64bit.biarch">
  <title>biarchプラットフォームでのソフトウェアのコンパイル</title>

  <para>
   biarchアーキテクチャで他のアーキテクチャ向けのバイナリを開発するには、対象のアーキテクチャのそれぞれのライブラリをさらにインストールする必要があります。こうしたパッケージは、対象のアーキテクチャが-32ビットアーキテクチャである場合は<systemitem class="resource">rpmname-  32bit</systemitem><phrase os="sles">または<systemitem class="resource">rpmname-x86</systemitem>(ia64の場合)と呼ばれ、対象のアーキテクチャが-64ビットアーキテクチャである場合は<systemitem class="resource">rpmname- 64bit</systemitem>と呼ばれます。</phrase>さらに、<systemitem class="resource">rpmname-devel</systemitem>パッケージからそれぞれのヘッダとライブラリ、また、<systemitem class="resource">rpmname-devel-32bit</systemitem><phrase os="sles">または<systemitem class="resource">rpmname-devel-64bitから対象のアーキテクチャ向けの開発ライブラリも必要です。</systemitem></phrase>
  </para>

  <para os="sles">
   たとえば、対象のアーキテクチャが32ビットアーキテクチャ(x86_64またはSystem z)であるシステムで<command>libaio</command>を使用するプログラムをコンパイルするには、次のRPMが必要です。
  </para>

  <variablelist os="sles">
   <varlistentry>
    <term>libaio-32bit</term>
    <listitem>
     <para>
      32ビットランタイムパッケージ
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>libaio-devel-32bit</term>
    <listitem>
     <para>
      32ビット開発用のヘッダとライブラリ
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>libaio</term>
    <listitem>
     <para>
      64ビットランタイムパッケージ
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>libaio-devel</term>
    <listitem>
     <para>
      64ビット開発用のヘッダとライブラリ
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   ほとんどのオープンソースプログラムでは、<command>autoconf</command>ベースのプログラム設定が使用されています。対象のアーキテクチャ向けプログラムの設定に<command>autoconf</command>を使用するには、<command>autoconf</command>の標準のコンパイラとリンカーの設定に上書きするために、さらに環境変数を指定して<command>configure</command>スクリプトを実行します。
  </para>

  <para>
   次の例は、対象のアーキテクチャとしてx86を採用しているx86_64システムを示しています。<phrase os="sles">対象のアーキテクチャとしてppcを採用しているppc64の場合も同様です。この例は、32ビットパッケージをビルドできないia64には適用されません。</phrase>
  </para>

  <procedure>
   <step performance="required">
    <para>
     32ビットコンパイラを使用します。
    </para>
<screen>CC="gcc -m32"</screen>
   </step>
   <step performance="required">
    <para>
     リンカーに 32ビットオブジェクトの処理を指示します(リンカーのフロントエンドには常に<command>gcc</command>を使用)。
    </para>
<screen>LD="gcc -m32"</screen>
   </step>
   <step performance="required">
    <para>
     32ビットオブジェクトを生成するためにアセンブラを設定します。
    </para>
<screen>AS="gcc -c -m32"</screen>
   </step>
   <step performance="required">
    <para>
     次に示すような、32ビットライブラリの場所などのリンカフラグを指定します。
    </para>
<screen>LDFLAGS="-L/usr/lib"</screen>
   </step>
   <step performance="required">
    <para>
     32ビットオブジェクトコードライブラリの場所を指定します。
    </para>
<screen>--libdir=/usr/lib</screen>
   </step>
   <step performance="required">
    <para>
     32ビットXライブラリの場所を指定します。
    </para>
<screen>--x-libraries=/usr/lib</screen>
   </step>
  </procedure>

  <para>
   こうした変数のすべてがどのプログラムにも必要なわけではありません。それぞれのプログラムに合わせて使用してください。
  </para>

  <para os="sles">
   x86__64<command>、ppc64、またはSystem z</command>でネイティブの32ビットアプリケーションをコンパイルする場合の、<phrase os="sles">configure</phrase>コールの例を次に示します。
  </para>

<screen>CC="gcc -m32"
LDFLAGS="-L/usr/lib;"
./configure --prefix=/usr --libdir=/usr/lib --x-libraries=/usr/lib
make
make install</screen>
 </sect1>
 <sect1 id="sec.64bit.kernel">
  <title>カーネル仕様</title><indexterm> <primary>64ビットLinux</primary><secondary>カーネル仕様</secondary> </indexterm>

  <para>
   x86_64<phrase os="sles">、ppc_64およびSystem z</phrase>向けの64ビットカーネルには、64ビットと32ビットのカーネルABI (アプリケーションバイナリインタフェース)が用意されています。32ビットのカーネルABIは、該当する32ビットカーネルのABIと同じものです。つまり、32ビットアプリケーションが、32ビットカーネルの場合と同様に64ビットカーネルと通信できるということです。
  </para>

  <para>
   64ビットカーネルのシステムコールの32ビットエミュレーションでは、システムプログラムで使用されるすべてのAPIをサポートしていません。ただし、このサポートの有無はプラットフォームによって異なります。このため、<command>lspci</command>などの少数のアプリケーションは、正しく機能するように64ビットプログラムとして<phrase os="sles">非ppc 64プラットフォームでコンパイルする必要があります。IBM System zでは、32ビットカーネルABIで利用できないioctlsがあります。</phrase>
  </para>

  <para>
   64ビットカーネルでは、このカーネル用に特別にコンパイルされた64ビットカーネルモジュールしかロードできません。したがって、32ビットカーネルモジュールを使用することはできません。
  </para>

  <tip>
   <title>カーネルロード可能モジュール</title>
   <para>
    一部のアプリケーションには、カーネルでロード可能な個々のモジュールが必要です。64ビットシステム環境でそのような32ビットアプリケーションを使用する予定がある場合は、このアプリケーションおよびSUSEのプロバイダに問い合わせて、このモジュール向けのカーネルでロード可能な64ビットバージョンのモジュールと32ビットコンパイルバージョンのカーネルAPIを入手できるかを確認してください。
   </para>
  </tip>
 </sect1>
</chapter>
