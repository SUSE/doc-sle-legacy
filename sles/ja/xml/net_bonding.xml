<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sect1 PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<sect1 xml:base="net_bonding.xml" id="sec-bond">
 <title>ボンディングデバイスの設定</title>

 <para>
  システムによって、通常のEthernetデバイスの規格のデータセキュリティ/可用性の要件を超えるネットワーク接続の実装が望ましいことがあります。その場合、数台のEthernetデバイスを集めて1つのボンディングデバイスを設定できます。
 </para>

 <para>
  ボンディングデバイスの設定には、ボンディングモジュールオプションを使用します。ボンディングデバイスの振る舞いは、主にボンディングデバイスのモードによって影響されます。デフォルトの動作は、<systemitem>mode=active-backup</systemitem>であり、アクティブなスレーブに障害が発生すると、別のスレーブデバイスがアクティブになります。
 </para>

 <tip>
  <title>ボンディングとXen</title>
  <para>
   ボンディングデバイスの使用が有用なのは、利用可能なネットワークカードが複数あるマシンの場合のみです。大半の設定では、Domain0でのみボンディング設定を使用する必要があることになります。VMゲストシステムに複数のネットワークカードが割り当てられている場合のみ、VMゲストでのボンド設定が役立つことがあります。
  </para>
 </tip>

 <para>
  ボンディングデバイスを設定するには、次の手順に従います。
 </para>

 <procedure>
  <step performance="required">
   <para>
    <menuchoice><guimenu>YaST</guimenu><guimenu>ネットワークデバイス</guimenu><guimenu>ネットワーク設定</guimenu></menuchoice>の順に選択します。
   </para>
  </step>
  <step performance="required">
   <para>
    <guimenu>追加</guimenu>を使用し、<guimenu>デバイスの型</guimenu>を<guimenu>ボンド</guimenu>に変更します。<guimenu>次へ</guimenu>で続行します。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step performance="required">
   <para>
    IPアドレスをボンディングデバイスに割り当てる方法を選択します。3つの方法から選択できます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      IPアドレスなし
     </para>
    </listitem>
    <listitem>
     <para>
      可変IPアドレス(DHCPまたはZeroconf)
     </para>
    </listitem>
    <listitem>
     <para>
      固定IPアドレス
     </para>
    </listitem>
   </itemizedlist>
   <para>
    ご使用の環境に適合する方法を使用します。
   </para>
  </step>
  <step performance="required">
   <para>
    <guimenu>ボンドスレーブ</guimenu>タブで該当するチェックボックスをオンにして、ボンドに含めるEthernetデバイスを選択します。
   </para>
  </step>
  <step performance="required">
   <para>
    <guimenu>ボンドドライバオプション</guimenu>を編集します。設定には次のモードを使用できます。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      balance-rr
     </para>
    </listitem>
    <listitem>
     <para>
      active-backup
     </para>
    </listitem>
    <listitem>
     <para>
      balance-xor
     </para>
    </listitem>
    <listitem>
     <para>
      ブロードキャスト
     </para>
    </listitem>
    <listitem>
     <para>
      802.3ad
     </para>
    </listitem>
    <listitem>
     <para>
      balance-tlb
     </para>
    </listitem>
    <listitem>
     <para>
      balance-alb
     </para>
    </listitem>
   </itemizedlist>
  </step>
  <step performance="required">
   <para>
    パラメータ<literal>miimon=100</literal>が<guimenu>ボンドドライバオプション</guimenu>に追加されていることを確認します。 このパラメータがないと、データの整合性が定期的にチェックされません。
   </para>
  </step>
  <step performance="required">
   <para>
    <guimenu>次へ</guimenu>をクリックし、<guimenu>OK</guimenu>でYaSTを終了して、デバイスを作成します。
   </para>
  </step>
 </procedure>

 <para>
  すべてのモードと他の多数のオプションの詳細は、<guimenu>Linux Ethernet Bonding Driver HOWTO</guimenu>に記載されています。このドキュメントは、kernel-sourceをインストールすると、<filename>/usr/src/linux/Documentation/networking/bonding.txt</filename>で読むことができます。<systemitem/>
 </para>

 <sect2>
  <title>ボンディングスレーブのホットプラグ</title>
  <para>
   特定のネットワーク環境(高可用性など)では、ボンディングスレーブインタフェースを別のものに置換しなければならないことがあります。ネットワークデバイスで頻繁に障害が発生するなどの理由があります。解決方法として、ボンディングスレーブのホットプラグを設定します。
  </para>
  <para>
   ボンドは以下のように(<command>man 5 ifcfg-bonding</command>に従って)通常通りに設定されます。たとえば、
  </para>
<screen>
ifcfg-bond0   
          STARTMODE='auto' # or 'onboot'  
          BOOTPROTO='static'   
          IPADDR='192.168.0.1/24'   
          BONDING_MASTER='yes'   
          BONDING_SLAVE_0='eth0'   
          BONDING_SLAVE_1='eth1'   
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'
</screen>
  <para>
   ただし、スレーブは<literal>STARTMODE=hotplug</literal>および<literal>BOOTPROTO=none</literal>で指定されます。
  </para>
<screen>
ifcfg-eth0   
          STARTMODE='hotplug'   
          BOOTPROTO='none'   

ifcfg-eth1   
          STARTMODE='hotplug'   
          BOOTPROTO='none'
</screen>
  <para>
   <literal>BOOTPROTO=none</literal>はethtoolオプション(提供されている場合)を使用しますが、<command>ifup eth0</command>でリンクを設定しません。 これは、スレーブインタフェースがボンドマスターによって制御されるためです。
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal>により、スレーブインタフェースが利用可能になるとすぐに、ボンドに自動的に追加されます。
  </para>
  <para>
   MACアドレスではなく、バスIDでデバイスを照合するように、<systemitem>/etc/udev/rules.d/70-persistent-net.rules</systemitem>の<filename>udev</filename>ルールを変更する必要があります(<systemitem>hwinfo --netcard</systemitem>に表示されるudev <command>KERNELS</command>キーワードを"SysFS BusID"とします)。これによって障害のあるハードウェアを置換(同じスロットで、MACが異なるネットワークカードを使用)できるようになり、ボンドがすべてのスレーブのMACアドレスを変更するので混乱を避けられます。
  </para>
  <para>
   たとえば、
  </para>
<screen>
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"
</screen>
  <para>
   ブート時に<filename>/etc/init.d/network</filename>はホットプラグスレーブを待機しませんが、ボンドの準備が整うのを待機します。これには少なくとも1つのスレーブが利用可能であることが必要です。スレーブインタフェースの1つがシステムから削除されると(NICドライバからアンバインド、NICドライバの<command>rmmod</command>、または実際のPCIホットプラグ取り外し)、カーネルによってボンドから自動的に削除されます。システムに新しいカードが追加されると(スロットのハードウェアが置換されると)、<systemitem>udev</systemitem>は、バスベースの永続名規則を使って名前をスレーブ名に変更し、<command>ifup</command>を呼び出します。<command>ifup</command>呼び出しによって、ボンドに自動的に追加されます。
  </para>
 </sect2>


</sect1>
