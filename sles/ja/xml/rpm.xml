<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sect1 PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<sect1 xml:base="rpm.xml" id="sec-rpm">
 <title>RPM—パッケージマネージャ</title><indexterm id="idx-RPM" class="startofrange"> <primary>RPM</primary> </indexterm> <indexterm> <primary>パッケージ</primary> <secondary>RPMs</secondary> </indexterm> <indexterm> <primary>パッケージ</primary> <secondary>パッケージマネージャ</secondary> </indexterm> <indexterm> <primary>コマンド</primary> <secondary>rpm</secondary> </indexterm>

 <para>
  RPM (RPM Package Manager)がソフトウェアパッケージを管理するのに使用されます。RPMの主要コマンドは、<command>rpm</command>と<command>rpmbuild</command>です。ユーザ、システム管理者、およびパッケージの作成者は、強力なRPMデータベースでクエリーを行って、インストールされているソフトウェアに関する情報を取得できます。
 </para><indexterm> <primary>rpmbuild</primary> </indexterm> <indexterm> <primary>コマンド</primary> <secondary>rpmbuild</secondary> </indexterm>

 <para>
  基本的に<command>rpm</command>には、ソフトウェアパッケージのインストール、アンインストール、アップデート、RPMデータベースの再構築、RPMベースまたは個別のRPMアーカイブの照会、パッケージの整合性チェック、およびパッケージへの署名の5種類のモードがあります。<command>rpmbuild</command>は、元のソースからインストール可能なパッケージを作成する場合に使用します。
 </para>

 <para>
  インストール可能なRPMアーカイブは、特殊なバイナリ形式でパックされています。それらのアーカイブは、インストールするプログラムファイルとある種のメタ情報で構成されます。メタ情報は、ソフトウェアパッケージを設定するために<command>rpm</command>によってインストール時に使用されるか、または文書化の目的でRPMデータベースに格納されています。通常、RPMアーカイブには拡張子<filename>.rpm</filename>が付けられます。
 </para><indexterm> <primary>パッケージ</primary> <secondary>LSB</secondary> </indexterm> <indexterm> <primary>LSB</primary> <secondary>パッケージのインストール</secondary> </indexterm>

 <tip>
  <title>ソフトウェア開発パッケージ</title>
  <para>
   多くのパッケージにおいて、ソフトウェア開発に必要なコンポーネント(ライブラリ、ヘッダ、インクルードファイルなど)は、別々のパッケージに入れられています。それらの開発パッケージは、最新のGNOMEパッケージのように、ソフトウェアを自分自身でコンパイルする場合にのみ、必要になります。それらのパッケージは、名前の拡張子<literal>-devel</literal>で識別できます(<systemitem class="resource">alsa-devel</systemitem>パッケージ、<systemitem class="resource">gimp-devel</systemitem>パッケージ、<systemitem class="resource">libkde4-devel</systemitem>.パッケージなど)。
  </para>
 </tip>

 <sect2 id="sec-rpm-package-auth">
  <title>パッケージの信頼性の検証</title><indexterm> <primary>RPM</primary><secondary>検証</secondary></indexterm><indexterm><primary>パッケージ</primary><secondary>検証 </secondary></indexterm>
  <para>
   RPMパッケージにはGPG署名があります。RPMパッケージの署名を検証するには、<command>rpm --checksig <replaceable>パッケージ</replaceable>-1.2.3.rpm</command>コマンドを使用して、Novell/SUSEまたはその他の信頼できるツールから送信されたパッケージかどうか判別します。これは、インターネットからアップデートパッケージを入手する場合には、特に推奨されます。
  </para>
 </sect2>

 <sect2 id="sec-rpm-packages-manage">
  <title>パッケージの管理:インストール、アップデート、およびアンインストール</title><indexterm> <primary>インストール</primary> <secondary>パッケージ</secondary> </indexterm> <indexterm> <primary>パッケージ</primary> <secondary>インストール</secondary> </indexterm> <indexterm> <primary>パッケージ</primary> <secondary>アンインストール</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>rpmorig</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>rpmsave</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>rpmnew</secondary> </indexterm>
  <para>
   通常RPMアーカイブのインストールはとても簡単です。<command>rpm -i <replaceable>package</replaceable>.rpm</command>の用に入力します。このコマンドで、パッケージをインストールできます。ただし、依存関係が満たされており、他のパッケージとの競合がない場合に限られます。<command>rpm</command>では、依存関係の要件を満たすためにインストールしなければならないパッケージがエラーメッセージで要求されます。バックグランドで、RPMデータベースは競合が起きないようにします。ある特定のファイルは、1つのパッケージだけにしか属せません。別のオプションを選択すると、<command>rpm</command>にこれらのデフォルト値を無視させることができますが、この処置を行うのは専門知識のある人に限られます。それ以外の人が行うと、システムの整合性を危うくするリスクが発生し、システムアップデート機能が損なわれる可能性があります。
  </para><indexterm> <primary>RPM</primary> <secondary>依存関係</secondary></indexterm>
  <para>
   <option>-U</option>または<option>--upgrade</option>と<option>-F</option>または<option>--freshen</option>の各オプションは、パッケージをアップデートするのに使用できます(たとえば、<command>rpm -F <replaceable>package</replaceable>.rpm</command>)。このコマンドは、古いバージョンのファイルを削除し、新しいファイルをただちにインストールします。2つのバージョン間の違いは、<option>-U</option>がシステムに存在していなかったパッケージをインストールするのに対して、<option>-F</option>がインストールされていたパッケージを単にアップデートする点にあります。アップデートする際、<command>rpm</command>は、以下のストラテジーに基づいて設定ファイルを注意深くアップデートします。
  </para><indexterm> <primary>RPM</primary> <secondary>アップデート</secondary></indexterm>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     設定ファイルがシステム管理者によって変更されていない場合、<command>rpm</command>は新しいバージョンの適切なファイルをインストールします。システム管理者は、何も行う必要はありません。
    </para>
   </listitem>
   <listitem>
    <para>
     アップデートの前に設定ファイルがシステム管理者によって変更されている場合、<command>rpm</command>は変更されたファイルに拡張子<filename>.rpmorig</filename>または<filename>.rpmsave</filename>(バックアップファイル)を付けて保存し、新しいパッケージからファイルをインストールします。ただしこれは、元々インストールされていたファイルと新しいファイルのバージョンが異なる場合に限ります。異なる場合は、バックアップファイル(<filename>.rpmorig</filename>または<filename>.rpmsave</filename>)と新たにインストールされたファイルを比較して、新しいファイルに再度、変更を加えます。後ですべての<filename>.rpmorig</filename>と<filename>.rpmsave</filename>ファイルを必ず削除して、今後のアップデートで問題が起きないようにします。
    </para>
   </listitem>
   <listitem>
    <para>
     設定ファイルがすでに存在しており、<emphasis>また</emphasis><option>noreplace</option>ラベルが<filename>.spec</filename>ファイルで指定されている場合、<filename>.rpmnew</filename>ファイルが作成されます。
    </para>
   </listitem>
  </itemizedlist>
  <para>
   アップデートが終了したら、<filename>.rpmsave</filename>ファイルと<filename>.rpmnew</filename>ファイルは、比較した後、将来のアップデートの妨げにならないように削除する必要があります。ファイルがRPMデータベースで認識されなかった場合、ファイルには拡張子<filename>.rpmorig</filename>が付けられます。
  </para>
  <para>
   認識された場合には、<filename>.rpmsave</filename>が付けられます。言い換えれば、<filename>.rpmorig</filename>は、RPM以外の形式からRPMにアップデートした結果として付けられます。<filename>.rpmsave</filename>は、古いRPMから新しいRPMにアップデートした結果として付けられます。<filename>.rpmnew</filename>は、システム管理者が設定ファイルに変更を加えたかどうかについて、何の情報も提供しません。それらのファイルのリストは、<filename>/var/adm/rpmconfigcheck</filename>にあります。設定ファイルの中には(<filename>/etc/httpd/httpd.conf</filename>など)、操作が継続できるように上書きされないものがあります。
  </para>
  <para>
   -U<option>スイッチは、単に</option>-e<emphasis>オプションでアンインストールして、</emphasis>-i<option>オプションでインストールする操作と同じでは</option>ありません<option>。</option>可能なときは必ず<option>-U</option>を使用します。
  </para>
  <para>
   パッケージを削除するには、「<command>rpm -e <replaceable>package</replaceable></command>.<command>rpm</command>」と入力します。解決されていない依存関係がない場合にパッケージのみを削除します。他のアプリケーションがTcl/Tkを必要とする限り、Tcl/Tkを削除することは理論的に不可能です。その場合でも、RPMはデータベースに援助を要求します。他の依存関係が<emphasis>ない</emphasis>場合でも、また、どのような理由があってもそのような削除が不可能であれば、<option>--rebuilddb</option>オプションを使用してRPMデータベースを再構築するのがよいでしょう。
  </para><indexterm> <primary>RPM</primary> <secondary>アンインストール</secondary> </indexterm> <indexterm> <primary>RPM</primary> <secondary>データベース</secondary> <tertiary>再構築</tertiary> </indexterm>
 </sect2>

 <sect2 id="sec-rpm-patches">
  <title>RPMとパッチ</title><indexterm> <primary>RPM</primary> <secondary>パッチ</secondary></indexterm>
  <para>
   システムの運用上のセキュリティを保証するには、ときどきアップデートパッケージをシステムにインストールする必要があります。以前は、パッケージ内のバグは、パッケージ全体を交換しなければ取り除けませんでした。バグのある小さなファイルが含まれる大きなパッケージでは、このようなシナリオに陥りがちでした。しかし、SUSE RPMを使用すると、パッケージ内にパッチをインストールできます。
  </para>
  <para>
   最も重要な考慮事項について、<command>pine</command>を例として説明します。
  </para>
  <variablelist>
   <varlistentry>
    <term>パッチRPMはシステムに適したものか。</term>
    <listitem>
     <para>
      これを検査するには、はじめにインストールされたパッケージでクエリーを行います。<command>pine</command>では、次のコマンドを実行します。
     </para>
<screen>rpm -q pine
pine-4.44-188</screen>
     <para>
      パッチRPMがこのバージョンの<command>pine</command>に適しているかどうかを検証します。
     </para>
<screen>rpm -qp --basedon pine-4.44-224.i586.patch.rpm
pine = 4.44-188
pine = 4.44-195
pine = 4.44-207</screen>
     <para>
      このパッチは、3種類のバージョンのpineに適しています。例でインストールされたバージョンもリストされています。パッチはインストールできます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>どのファイルがパッチで置き換えられるか。</term>
    <listitem>
     <para>
      パッチの影響を受けるファイルは、パッチRPMで簡単に見つけられます。<command>rpmの</command><option>-P</option>パラメータを使用すると、特殊なパッチ機能を選択できます。次のコマンドでファイルをリストします。
     </para>
<screen>rpm -qpPl pine-4.44-224.i586.patch.rpm
/etc/pine.conf
/etc/pine.conf.fixed
/usr/bin/pine</screen>
     <para>
      パッチがすでにインストールされていれば、次のコマンドを使用します。
     </para>
<screen>rpm -qPl pine
/etc/pine.conf
/etc/pine.conf.fixed
/usr/bin/pine</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>パッチRPMをどのようにシステムにインストールするか。</term>
    <listitem>
     <para>
      パッチRPMは、通常のRPMと同様に使用されます。唯一の違いは、適切なRPMがすでにインストールされていなければならない点です。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>
     どのパッチがシステムにインストールされており、それらはどのパッケージバージョンのものか。
    </term>
    <listitem>
     <para>
      システムにインストールされているすべてのパッチのリストは、コマンド<command>rpm <option>-qPa</option></command>で表示できます。(この例のように)新しいシステムに1つのパッチだけがインストールされている場合、リストは次のようになります。
     </para>
<screen>rpm -qPa
pine-4.44-224</screen>
     <para>
      後日、オリジナルとしてインストールされていたパッケージのバージョンを知りたい場合、その情報はRPMデータベースから得られます。<command>pine</command>の場合、その情報は次のコマンドで表示できます。
     </para>
<screen>rpm -q --basedon pine
pine = 4.44-188</screen>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   RPMのパッチ機能に関する情報を含む詳細な情報は、<command>man rpm</command>コマンドと<command>rpmbuild</command>コマンドのマニュアルページで収集できます。
  </para>
  <note>
   <title><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の公式アップデート</title>
   <para>
    アップデートのダウンロードサイズをできる限り小さくするため、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>の公式アップデートはパッチRPMとしてではなく、デルタRPMパッケージとして提供されます。詳細については、<xref linkend="sec-rpm-delta"/>を参照してください。
   </para>
  </note>
 </sect2>

 <sect2 id="sec-rpm-delta">
  <title>デルタRPMパッケージ</title><indexterm> <primary>RPM</primary> <secondary>deltarpm</secondary> </indexterm> <indexterm> <primary>deltarpm</primary> </indexterm>
  <para>
   デルタRPMパッケージには、RPMパッケージの新旧バージョン間の違いが含まれています。デルタRPMを古いRPMに適用すると、まったく新しいRPMになります。デルタRPMは、インストールされているRPMとも互換性があるので、古いRPMのコピーを保管する必要はありません。デルタRPMパッケージは、パッチRPMよりもさらに小さく、パッケージをインターネット上で転送するのに便利です。欠点は、デルタRPMが組み込まれたアップデート操作の場合、そのままのRPMまたはパッチRPMに比べて、CPUサイクルの消費が目立って多くなることです。
  </para>
  <para>
   <command>prepdeltarpm</command>、<command>writedeltarpm</command>、および<command>applydeltarpm</command>バイナリは、デルタRPMスィート(<systemitem>deltarpm</systemitem>パッケージ)の一部であり、デルタRPMパッケージの作成と適用に際して役立ちます。次のコマンドを使用して、<filename>new.delta.rpm</filename>というデルタRPMを作成します。次のコマンドでは、<filename>old.rpm</filename>および<filename>new.rpm</filename>が存在することが前提となります。
  </para>
<screen>prepdeltarpm -s seq -i info old.rpm &gt; old.cpio
prepdeltarpm -f new.rpm &gt; new.cpio
xdelta delta -0 old.cpio new.cpio delta
writedeltarpm new.rpm delta info new.delta.rpm</screen>
  <para>
   最後に、一時作業ファイル<filename>old.cpio</filename>、<filename>new.cpio</filename>、および<filename>delta</filename>を削除します。
  </para>
  <para>
   古いパッケージがすでにインストールされていれば、<command>applydeltarpm</command>を使用して、ファイルシステムから新たにRPMを構築できます。
  </para>
<screen>applydeltarpm new.delta.rpm new.rpm</screen>
  <para>
   ファイルシステムにアクセスすることなく、古いRPMから構築するには、<option>-r</option>オプションを使用します。
  </para>
<screen>applydeltarpm -r old.rpm new.delta.rpm new.rpm</screen>
  <para>
   技術的な詳細については、<filename>/usr/share/doc/packages/deltarpm/README</filename>を参照してください。
  </para>
 </sect2>

 <sect2 id="sec-rpm-query">
  <title>RPMクエリー</title><indexterm> <primary>RPM</primary> <secondary>クエリー</secondary> </indexterm>
  <para>
   <option>-q</option>オプションを使用すると、<command>rpm</command>はクエリを開始し、(<option>-p</option>オプションを追加することにより)RPMアーカイブを検査できるようにして、インストールされたパッケージのRPMデータベースでクエリを行えるようにします。必要な情報の種類を指定する複数のスイッチを使用できます。詳細については、<xref linkend="tab-rpm-query"/>を参照してください。
  </para>
  <table id="tab-rpm-query">
   <title>最も重要なRPMクエリーのオプション</title>
   <tgroup cols="2">
    <tbody>
     <row>
      <entry>
       <para>
        <option>-i</option>
       </para>
      </entry>
      <entry>
       <para>
        パッケージ情報
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-l</option>
       </para>
      </entry>
      <entry>
       <para>
        ファイルリスト
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-f FILE</option>
       </para>
      </entry>
      <entry>
       <para>
        ファイル<replaceable>FILE</replaceable>を含むパッケージでクエリーを行います(<replaceable>FILE</replaceable>にはフルパスを指定する必要があります)。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-s</option>
       </para>
      </entry>
      <entry>
       <para>
        ステータス情報を含むファイルリスト(<option>-l</option>を暗示指定)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-d</option>
       </para>
      </entry>
      <entry>
       <para>
        ドキュメントファイルだけをリストします (<literal>-l</literal>を暗示指定)。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>-c</option>
       </para>
      </entry>
      <entry>
       <para>
        設定ファイルだけをリストします(<option>-l</option>を暗示指定)。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--dump</option>
       </para>
      </entry>
      <entry>
       <para>
        詳細情報を含むファイルリスト(<option>-l</option>、<option>-c</option>、または<option>-d</option> と共に使用します)
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--provides</option>
       </para>
      </entry>
      <entry>
       <para>
        他のパッケージが<option>--requires</option>で要求できるパッケージの機能をリストします。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--requires</option>, <option>-R</option>
       </para>
      </entry>
      <entry>
       <para>
        パッケージが要求する機能
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>--scripts</option>
       </para>
      </entry>
      <entry>
       <para>
        インストールスクリプト(preinstall、postinstall、uninstall)
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <para>
   たとえば、コマンド<command>rpm -q -i wget</command>は、<xref linkend="aus-update-rpm-i"/>に示された情報を表示します。
  </para>
  <example id="aus-update-rpm-i">
   <title>rpm -q -i wget</title>
<screen>Name        : wget                         Relocations: (not relocatable)
Version     : 1.11.4                            Vendor: openSUSE
Release     : 1.70                          Build Date: Sat 01 Aug 2009 09:49:48 CEST
Install Date: Thu 06 Aug 2009 14:53:24 CEST      Build Host: build18
Group       : Productivity/Networking/Web/Utilities   Source RPM: wget-1.11.4-1.70.src.rpm
Size        : 1525431                          License: GPL v3 or later
Signature   : RSA/8, Sat 01 Aug 2009 09:50:04 CEST, Key ID b88b2fd43dbdc284
Packager    : http://bugs.opensuse.org
URL         : http://www.gnu.org/software/wget/
Summary     : A Tool for Mirroring FTP and HTTP Servers
Description :
Wget enables you to retrieve WWW documents or FTP files from a server.
This can be done in script files or via the command line.
[...]</screen>
  </example>
  <para>
   オプション<option>-f</option>が機能するのは、フルパスで完全なファイル名を指定した場合だけです。必要な数のファイル名を指定します。たとえば、次のコマンドを実行します。
  </para>
<screen>rpm -q -f /bin/rpm /usr/bin/wget</screen>
  <para>
   出力は次のとおりです。
  </para>
<screen>rpm-4.8.0-4.3.x86_64
wget-1.11.4-11.18.x86_64</screen>
  <para>
   ファイル名の一部分しかわからない場合は、<xref linkend="dat-rpm-search"/>に示すようなシェルスクリプトを使用します。実行するときに、ファイル名の一部を、パラメータとして示されるスクリプトに渡します。
  </para>
  <example id="dat-rpm-search">
   <title>パッケージを検索するスクリプト</title>
<screen>#! /bin/sh
for i in $(rpm -q -a -l | grep $1); do
    echo "\"$i\" is in package:"
    rpm -q -f $i
    echo ""
done</screen>
  </example>
  <para>
   <command>rpm -q --changelog rpm </command>コマンドは、特定のパッケージ (この場合は<literal>rpm</literal>パッケージ)に関する詳細な変更情報を日付順に一覧しますの詳細なリストを表示します。

  </para>
  <para>
   インストールされたRPMデータベースを使うと、確認検査を行うことができます。それらの検査は、<option>-V</option>、<option>-y</option>、または<option>--verify</option>オプションを使用して開始します。このオプションを使うと、<command>rpm</command>は、パッケージ内にあり、インストール以降変更されたことがあるすべてのファイルを表示します。<command>rpm</command>は、次の変更に関するヒントを表示するのに、8文字の記号を使用します。
  </para><indexterm> <primary>RPM</primary> <secondary>検証</secondary></indexterm>
  <table id="tab-rpm-verify">
   <title>RPM確認オプション</title>
   <tgroup cols="2">
    <tbody>
     <row>
      <entry>
       <para>
        <option>5</option>
       </para>
      </entry>
      <entry>
       <para>
        MD5チェックサム
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>S</option>
       </para>
      </entry>
      <entry>
       <para>
        ファイルサイズ
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>L</option>
       </para>
      </entry>
      <entry>
       <para>
        シンボリックリンク
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>T</option>
       </para>
      </entry>
      <entry>
       <para>
        変更時間
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>D</option>
       </para>
      </entry>
      <entry>
       <para>
        メジャーデバイス番号とマイナーデバイス番号
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>U</option>
       </para>
      </entry>
      <entry>
       <para>
        所有者
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>G</option>
       </para>
      </entry>
      <entry>
       <para>
        グループ
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        <option>M</option>
       </para>
      </entry>
      <entry>
       <para>
        モード (許可とファイルタイプ)
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
  <para>
   設定ファイルの場合は、文字<option>c</option>が表示されます。<filename>/etc/wgetrc</filename> (<systemitem class="resource">wget</systemitem>パッケージ)の変更例を以下に示します。
  </para>
<screen>rpm -V wget
S.5....T c /etc/wgetrc</screen>
  <para>
   RPMデータベースのファイルは、<filename>/var/lib/rpm</filename>に格納されています。パーティション<filename>/usr</filename>のサイズが 1 GBであれば、このデータベースは、完全なアップデート後、およそ 30 MB占有します。データベースが予期していたよりもはるかに大きい場合は、オプション<option>--rebuilddb</option>でデータベースを再構築するようにします。再構築する前に、古いデータベースのバックアップを作成しておきます。cron<command>スクリプトの</command>cron.daily<command>は、データベースのコピー(gzip でパックされる)を毎日作成し、</command>/var/adm/backup/rpmdb<filename>に格納します。</filename>コピー数は<filename>/etc/sysconfig/backup</filename>にある変数<systemitem>MAX_RPMDB_BACKUPS</systemitem>で制御します(デフォルト:<option>5</option>)。1つのバックアップのサイズは、1GBの<filename>/usr</filename>に対しておよそ1MBです。
  </para><indexterm> <primary>RPM</primary> <secondary>データベース</secondary> <tertiary>再構築</tertiary> </indexterm>
 </sect2>

 <sect2 id="sec-rpm-sources">
  <title>ソースパッケージのインストールとコンパイル</title><indexterm> <primary>パッケージ</primary> <secondary>コンパイル</secondary> </indexterm> <indexterm> <primary>ソース</primary> <secondary>コンパイル</secondary> </indexterm> <indexterm> <primary>ソフトウェア</primary> <secondary>コンパイル</secondary> </indexterm> <indexterm> <primary>spm</primary> </indexterm>
  <para>
   すべてのソースパッケージには、拡張子<filename>.src.rpm</filename> (ソース RPM)が付けられています。
  </para>
  <note>
   <title>インストール済みのソースパッケージ</title>
   <para>
    ソースパッケージは、インストールメディアからハードディスクにコピーされ、YaSTを使用して展開できます。ただし、ソースパッケージは、パッケージマネージャでインストール済み(<literal>[i]</literal>)というマークは付きません。これは、ソースパッケージがRPMデータベースに入れられないためです。<emphasis>インストールされた</emphasis>オペレーティングシステムソフトウェアだけがRPMデータベースにリストされます。ソースパッケージを<quote>インストールする</quote>場合、ソースコードだけがシステムに追加されます。
   </para>
  </note>
  <para>
   (<filename>/etc/rpmrc</filename>などのファイルでカスタム設定を指定していない限り)以下のディレクトリが、<filename>/usr/src/packages</filename>の下で<command>rpm</command>と<command>rpmbuild</command>から使用可能でなければなりません。
  </para>
  <variablelist>
   <varlistentry>
    <term><filename>SOURCES</filename>
    </term>
    <listitem>
     <para>
      オリジナルのソース(<filename>.tar.gz</filename>ファイルや<filename>.tar.gz</filename>ファイルなど)とディストリビューション固有の調整ファイル(ほとんどの場合<filename>.dif</filename>ファイルや<filename>.patch</filename>ファイル)用です。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>SPECS</filename>
    </term>
    <listitem>
     <para>
      <emphasis>ビルド</emphasis>処理 を制御する、メタMakefileに類似した<filename>.spec</filename>ファイル用です。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>BUILD</filename>
    </term>
    <listitem>
     <para>
      すべてのソースは、このディレクトリでアンパック、パッチ、およびコンパイルされます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>RPMS</filename>
    </term>
    <listitem>
     <para>
      完成したバイナリパッケージが格納されます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>SRPMS</filename><indexterm><primary>RPM</primary><secondary>SRPMS</secondary> </indexterm></term>
    <listitem>
     <para>
      ソースRPMが格納されます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   YaSTでソースパッケージをインストールすると、必要なコンポーネントがすべて<filename>/usr/src/packages</filename>にインストールされます。 <filename>SOURCES</filename>内のソースおよび調整ファイルと<filename>SPECS</filename>内の関連<filename>.spec</filename>ファイルです。
  </para>
  <warning>
   <para>
    システムコンポーネント(<systemitem class="resource">glibc</systemitem>、<systemitem class="resource">rpm</systemitem>、<systemitem class="resource">sysvinit</systemitem>など)で実験してはいけません。システムが正しく動作しなくなります。
   </para>
  </warning>
  <para>
   次の例は、<filename>wget.src.rpm</filename>パッケージを使用します。ソースパッケージをインストールすると、次のようなファイルが生成されます。
  </para>
<screen>/usr/src/packages/SOURCES/wget-1.11.4.tar.bz2
/usr/src/packages/SOURCES/wgetrc.patch
/usr/src/packages/SPECS/wget.spec</screen>
  <para>
   <command>rpmbuild -b <replaceable>X</replaceable> /usr/src/packages/SPECS/wget.spec</command>コマンドは、コンパイルを開始します。<replaceable>X</replaceable>は、ビルド処理のさまざまな段階に対して使用されるワイルドカードです(詳細については、<option>--help</option>の出力またはRPMのドキュメントを参照してください)。以下に簡単な説明を示します。
  </para>
  <variablelist>
   <varlistentry>
    <term><option>-bp</option>
    </term>
    <listitem>
     <para>
      <filename>/usr/src/packages/BUILD</filename>内のソースを用意します。アンパック、パッチしてください。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-bc</option>
    </term>
    <listitem>
     <para>
      <option>-bp</option>と同じですが、コンパイルを実行します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-bi</option>
    </term>
    <listitem>
     <para>
      <option>-bp</option>と同じですが、ビルドしたソフトウェアをインストールします。警告:パッケージがBuildRoot機能をサポートしていない場合は、設定ファイルが上書きされることがあります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-bb</option>
    </term>
    <listitem>
     <para>
      <option>-bi</option>と同じですが、バイナリパッケージを作成します。コンパイルに成功すると、バイナリパッケージは、<filename>/usr/src/packages/RPMS</filename>に作成されるはずです。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>-ba</option>
    </term>
    <listitem>
     <para>
      -bb<option>と同じですが、ソース RPMを作成します。</option>コンパイルに成功すると、バイナリは<filename>/usr/src/packages/SRPMS</filename>に作成されるはずです。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>--short-circuit</option>
    </term>
    <listitem>
     <para>
      一部のステップをスキップします。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   作成されたバイナリRPMは、<command>rpm<option> -i</option></command>コマンドまたは<command>rpm<option> -U</option></command>コマンドでインストールできます。rpm<command>を使用したインストールは、RPMデータベースに登場します。</command>
  </para>
 </sect2>

 <sect2 id="sec-rpm-build">
  <title>buildによるRPMパッケージのコンパイル</title><indexterm> <primary>パッケージ</primary><secondary>buildによるコンパイル</secondary> </indexterm>
  <para>
   多くのパッケージにつきものの不都合は、ビルド処理中に不要なファイルが稼働中のシステムに追加されてしまうことです。これを回避するには、パッケージのビルド先の定義済みの環境を作成する<systemitem>build</systemitem>を使用します。このchroot環境を確立するには、<command>build</command> スクリプトが完全なパッケージツリーと共に提供されなければなりません。パッケージツリーは、NFS経由で、またはDVDから ハードディスク上で利用できるようにすることができます。<command>build --rpms <replaceable>directory</replaceable></command>で、位置を指定します。<command>rpm</command>と異なり、<command>build</command>コマンドは、ソースディレクトリで<filename>.spec</filename>ファイルを検索します。<filename>/media/dvd</filename>の下でシステムにマウントされているDVDを使用して(上記の例と同様に)<filename>wget</filename>をビルドするには、次のコマンドを<systemitem class="username">root</systemitem>として使用します。
  </para>
<screen>cd /usr/src/packages/SOURCES/
mv ../SPECS/wget.spec .
build --rpms /media/dvd/suse/ wget.spec</screen>
  <para>
   これで、最小限の環境が<filename>/var/tmp/build-root</filename>に確立されます。パッケージは、この環境でビルドされます。処理が完了すると、ビルドされたパッケージは<filename>/var/tmp/build-root/usr/src/packages/RPMS</filename>に格納されます。
  </para>
  <para>
   build<command>スクリプトでは、他のオプションも多数使用できます。</command>たとえば、スクリプトがユーザ独自のRPMを処理するようにするには、ビルド環境の初期化を省略するか、<command>rpm</command>コマンドの実行を上記のビルド段階のいずれかに制限します。<command>build <option>--help</option></command>コマンドと<command>man build</command>コマンドで、詳細な情報が得られます。
  </para>
 </sect2>

 <sect2 id="sec-rpm-tools">
  <title>RPMアーカイブとRPMデータベース用のツール</title><indexterm> <primary>RPM</primary> <secondary>ツール</secondary></indexterm>
  <para>
   Midnight Commander (<command>mc</command>)は、RPMアーカイブの内容を表示し、それらの一部をコピーできます。アーカイブを仮想ファイルシステムとして表し、Midnight Commanderの通常のメニューオプションを使用できます。<filename>F3</filename>キーを使用して<keycap>HEADER</keycap>を表示します。カーソルキーと<keycap>Enter</keycap>キーを使ってアーカイブ構造を表示します。<keycap>F5</keycap>キーを使用してアーカイブコンポーネントをコピーします。
  </para>
  <para>


   フル機能のパッケージマネージャをYaSTモジュールとして使用できます詳細については、<xref linkend="cha-y2-sw"/>を参照してください。
  </para><indexterm class="endofrange" startref="idx-RPM"/>

 </sect2>
</sect1>
