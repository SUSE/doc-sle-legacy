<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE sect1
[
   <!ENTITY % entities SYSTEM "entity-decl.ent">
   %entities;
]>


<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<section xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="zseries_rescue_initrd.xml" xml:id="sec-zseries-rescue">
 <title>IBM System z:　initrdのレスキューシステムとしての使用</title>

 <para>
  SUSE® Linux Enterprise Server for IBM System zのカーネルをアップグレードまたは変更した場合、何らかの原因でシステムが不整合な状態で再起動されると、インストールされているシステムのIPL標準処理が失敗する可能性があります。一般的にこの問題は、アップデートされたSUSE Linux Enterprise Serverカーネルをインストールした後で、IPLレコードをアップデートするziplプログラムをまだ実行していない場合に発生します。この場合、レスキューシステムとして標準のインストールパッケージを使用して、そこからziplプログラムを実行してIPLレコードをアップデートしてください。
 </para><indexterm> <primary>レスキューシステム</primary> </indexterm>

 <section xml:id="sec-zseries-rescue-ipling">
  <title>レスキューシステムのIPL処理</title>
  <important>
   <title>インストールデータを利用できるようにする</title>
   <para>
    この方法を使用する場合、SUSE Linux Enterprise Server for IBM System zのインストールデータが利用可能でなければなりません。詳細については、<xref linkend="sec-prep-makeavail"/>を参照してください。また、SUSE Linux Enterprise Serverのルートファイルシステムを含むデバイスのチャネル番号、およびデバイス内のパーティション番号が必要になります。
   </para>
  </important>
  <para>
   まず、SUSE Linux Enterprise Server for IBM System zのインストールシステムをIPL (再起動)します(<xref linkend="sec-zseries-prep"/>を参照)。IPL処理すると、ネットワークアダプタのリストが表示されます。
  </para>
  <para>
   レスキューシステムを開始するには<guimenu>インストール処理またはシステムを開始する</guimenu>を選択してから<guimenu>レスキューシステムを開始する</guimenu>を選択します。次に、インストール環境に応じて、ネットワークアダプタやインストールソースに関するパラメータを指定する必要があります。レスキューシステムがロードされ、ログインプロンプトが表示されます。
  </para>
  <screen>Skipped services in runlevel 3:  nfs nfsboot

Rescue login:</screen>
  <para>
   <systemitem class="username">root</systemitem>として、パスワードを指定しないでログインすることができます。
  </para>
 </section>

 <section xml:id="sec-zseries-rescue-configure-disks">
  <title>ディスクの設定</title>
  <para>
   この状態では、設定されているディスクはありません。作業を続行する前に、ディスクを設定する必要があります。
  </para>
  <procedure>
   <title>DASDの設定</title>
   <step>
    <para>
     DASDを設定するには、以下のコマンドを使用します。
    </para>
    <screen>dasd_configure 0.0.0150 1 0</screen>
    <para>
     ここで、「0.0.0150」は、DASDが接続されているチャネルを表します。<literal>1</literal>は、ディスクをアクティブにすることを表しています(ここに<literal>0</literal>を指定すると、ディスクが無効になる)。<literal>0</literal>は、ディスクに<quote>DIAGモード</quote>でアクセスしないことを表します(ここに<literal>1</literal>を指定すると、ディスクへのDAIGアクセスが有効になります)。
    </para>
   </step>
   <step>
    <para>
     DASDがオンラインになり(<command>cat /proc/partitions</command>で確認)、コマンドを使用できるようになります。
    </para>
   </step>
  </procedure>
  <procedure>
   <title>zFCPディスクの設定</title>
   <step>
    <para>
     zFCPディスクを設定するには、まずzFCPアダプタを設定する必要があります。そのためには次のコマンドを使用します。
    </para>
    <screen>zfcp_host_configure 0.0.4000 1</screen>
    <para>
     <literal>0.0.4000</literal>はアダプタが接続されているチャネルを、<literal>1</literal>(ここに<literal>0</literal>を指定するとアダプタが無効になる)はアクティブにすることを示します。
    </para>
   </step>
   <step>
    <para>
     アダプタをアクティブにしたら、ディスクを設定することができます。そのためには次のコマンドを使用します。
    </para>
    <screen>zfcp_disk_configure 0.0.4000 1234567887654321 8765432100000000  1</screen>
    <para>
     <literal>0.0.4000</literal>は前に使われていたチャネルIDを、<literal>1234567887654321</literal>はWWPN(World wide Port Number)を、そして<literal>8765432100000000</literal>はLUN(論理ユニット番号)を表しています。<literal>1</literal>(ここに<literal>0</literal>を指定するとディスクが無効になる)は、ディスクをアクティブにすることを表しています。
    </para>
   </step>
   <step>
    <para>
     zFCPディスクがオンラインになり(<command>cat /proc/partitions</command>で確認)、コマンドを使用できるようになります。
    </para>
   </step>
  </procedure>
 </section>

 <section xml:id="sec-zseries-rescue-mount">
  <title>ルートデバイスのマウント</title>
  <para>
   必要なディスクがすべてオンラインになったら、ルートデバイスをマウントします。ここでは、DASDの2番目のパーティション(<literal>/dev/dasda2</literal>)にルートデバイスがあると仮定します。この場合、使用するコマンドは<command>mount /dev/dasda2 /mnt</command>になります。
  </para>
  <important>
   <title>ファイルシステムの整合性</title>
   <para>
    インストール済みシステムが正しくシャットダウンされなかった場合は、マウント前にファイルシステムの整合性を確認しておくことをお勧めします。整合性を確認することによって、予期せぬ事態によるデータ消失の危険を回避することができます。この例では、<command>fsck</command> <option>/dev/dasda2</option>コマンドを実行して、ファイルシステムの整合性を確認します。
   </para>
  </important>
  <para>
   mount<command>コマンドを実行するだけでも、ファイルシステムが正しくマウントされたかどうかを確認することができます。</command>
  </para>
  <example xml:id="ex-zseries-rescue-mount-mount-output">
   <title>mountコマンドの出力</title>
   <screen>SuSE Instsys suse:/ # mount
shmfs on /newroot type shm (rw,nr_inodes=10240)
devpts on /dev/pts type devpts (rw)
virtual-proc-filesystem on /proc type proc (rw)
/dev/dasda2 on /mnt type reiserfs (rw)</screen>
  </example>
 </section>

 <section xml:id="sec-zseries-rescue-chroot">
  <title>マウントされているファイルシステムの変更</title>
  <para>
   <literal>zipl</literal>コマンド実行時に、レスキューシステムからではなく、インストール済みシステムのルートデバイスから設定ファイルを読み込ませるためには、<command>chroot</command>コマンドを使ってルートデバイスをインストール済みシステムに変更します。
  </para>
  <example xml:id="ex-zseries-rescue-chroot">
   <title>chrootを使ったマウントするファイルシステムの変更</title>
   <screen>SuSE Instsys suse:/ # cd /mnt 
SuSE Instsys suse:/mnt # chroot /mnt</screen>
  </example>
 </section>

 <section xml:id="sec-zseries-rescue-zipl">
  <title>ziplの実行</title>
  <para>
   次に、<command>zipl</command>を実行して、IPLレコードを正しい値に書き換えます。
  </para>
  <example xml:id="ex-zseries-rescue-zipl">
   <title>ziplを使ったIPLレコードのインストール</title>
   <screen>sh-2.05b# zipl 
building bootmap : /boot/zipl/bootmap 
adding Kernel Image : /boot/kernel/image located at 0x00010000 
adding Ramdisk : /boot/initrd located at 0x00800000 
adding Parmline : /boot/zipl/parmfile located at 0x00001000 
Bootloader for ECKD type devices with z/OS compatible layout installed. 
Syncing disks.... 
...done</screen>
  </example>
 </section>

 <section xml:id="sec-zseries-rescue-exit">
  <title>レスキューシステムの終了</title>
  <para>
   レスキューシステムを終了するには、まず<command>chroot</command>コマンドで開かれたシェルを<command>exit</command>コマンドで終了します。データ消失を防ぐために、<command>sync</command>コマンドを使って、バッファ上にあるまだ書き込まれていないデータをすべてディスクに書き込みます。次に、レスキューシステムのルートディレクトリに移動して、SUSE Linux Enterprise Server for IBM System zルートデバイスをアンマウントします。
  </para>
  <example xml:id="ex-zseries-rescue-exit-umount">
   <title>ファイルシステムのアンマウント</title>
   <screen>SuSE Instsys suse:/mnt # cd / 
SuSE Instsys suse:/ # umount /mnt</screen>
  </example>
  <para>
   最後に、<command>halt</command>コマンドを実行して、レスキューシステムを終了します。<xref linkend="sec-s390-inst-reipl"/>で説明されているように、SUSE Linux Enterprise ServerシステムのIPL処理が行われます。
  </para>
 </section>
</section>
