<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="automated_upgrade.xml" id="cha.update.auto" os="sles">
 <title>Mise à niveau automatique de SUSE Linux Enterprise 11 SP2 vers la version 11 SP3</title>
 <para>
  La procédure suivante permet d'effectuer une mise à niveau de masse sans surveillance de SUSE Linux Enterprise 11 SP2 vers SUSE Linux Enterprise 11 SP3. Plusieurs étapes de préparation sont nécessaires pour créer un profil AutoYaST adapté. Enfin, AutoYaST exécutera le processus de mise à niveau.
 </para>
 <sect1 id="sec.update.auto.prep_autoyast">
  <title>Préparation du profil AutoYaST</title>

  <para>
   Le profil AutoYaST utilise le même format de fichier que l'installation AutoYaST pour la mise à niveau automatique. <phrase os="sled;sles">Pour plus d'informations sur AutoYaST, reportez-vous au <xref linkend="cha.deployment.autoinst"/> et au manuel <xref linkend="book.autoyast"/>.</phrase>
  </para>

  <para>
   Toutefois, pour des raisons évidentes, il est inutile de configurer certaines parties du système (comme le partitionnement) pendant la mise à niveau. Par ailleurs, il est utile de définir des options spécifiques à la mise à niveau via le profil AutoYaST.
  </para>

  <sect2>
   <title>Mise à niveau</title>
   <para>
    Les options de mise à niveau définissent le comportement du résolveur de dépendances pendant la mise à niveau :
   </para>
<screen>&lt;upgrade&gt;
  &lt;only_installed_packages
    config:type="boolean"&gt;false&lt;/only_installed_packages&gt;
  &lt;stop_on_solver_conflict
    config:type="boolean"&gt;true&lt;/stop_on_solver_conflict&gt;
&lt;/upgrade&gt;</screen>
   <variablelist>
    <varlistentry>
     <term><literal>only_installed_packages</literal>
     </term>
     <listitem>
      <para>
       Définissez la valeur sur <literal>true</literal> pour les mises à niveau basées sur des paquetages (recommandé pour les mises à niveau vers le service pack suivant du même produit) ou sur <literal>false</literal> pour les mises à niveau basées sur des modèles (recommandé pour les mises à niveau entre deux versions d'un produit, comme depuis SLES10 vers SLES11).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>stop_on_solver_conflict</literal>
     </term>
     <listitem>
      <para>
       Détermine l'affichage de la proposition en cas d'échec de la résolution des dépendances de paquetages de façon interactive (il est recommandé de définir la valeur sur <literal>true</literal>, même si ceci peut entraîner un processus interactif pendant lequel l'utilisateur doit résoudre les conflits manuellement).
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2>
   <title>Sélection des logiciels</title>
   <para>
    Les options de sélection des logiciels déterminent les composants à sélectionner ou à désélectionner en plus des résultats du résolveur :
   </para>
<screen>&lt;software&gt;
  &lt;packages config:type="list"&gt;
    &lt;package&gt;autoyast2-installation&lt;/package&gt;
    &lt;package&gt;apparmor-profile-editor&lt;/package&gt;
  &lt;/packages&gt;
  &lt;patterns config:type="list"&gt;
    &lt;pattern&gt;base&lt;/pattern&gt;
  &lt;/patterns&gt;
  &lt;remove-packages config:type="list"/&gt;
  &lt;remove-patterns config:type="list"/&gt;
&lt;/software&gt;</screen>
   <para>
    Il est particulièrement important de définir des paquetages ou des modèles à sélectionner ou à désélectionner pour résoudre les conflits de paquetages et éviter ainsi d'avoir recours à une intervention interactive. Une fois la mise à niveau exécutée, le fichier <filename>autoupg_updated.xml</filename> qui vient d'être créé contient ces paquetages et ces modèles en plus de ceux qui ont été sélectionnés ou désélectionnés pour toute autre raison.
   </para>
  </sect2>

  <sect2>
   <title>Sauvegarde avant la mise à niveau</title>
   <para>
    Les options de sauvegarde avant la mise à niveau correspondent aux fonctionnalités de la proposition de mise à niveau.
   </para>
<screen>&lt;backup&gt;
  &lt;sysconfig config:type="boolean"&gt;true&lt;/sysconfig&gt;
  &lt;modified config:type="boolean"&gt;true&lt;/modified&gt;
  &lt;remove_old config:type="boolean"&gt;false&lt;/remove_old&gt;
&lt;/backup&gt;</screen>
   <variablelist>
    <varlistentry>
     <term><literal>sysconfig</literal>
     </term>
     <listitem>
      <para>
       Détermine si sysconfig sera sauvegardé avant la mise à niveau.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>modified</literal>
     </term>
     <listitem>
      <para>
       Détermine si les fichiers de configuration modifiés seront sauvegardés avant la mise à niveau.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><literal>remove_old</literal>
     </term>
     <listitem>
      <para>
       Détermine si les anciennes sauvegardes seront supprimées des précédentes mises à niveau.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 id="sec.update.auto.run">
  <title>Exécution de la mise à niveau automatique</title>

  <para>
   Pour commencer la mise à niveau automatique, démarrez le support d'installation, puis transférez le profil AutoYaST vers le système. Il existe deux façons de transférer le profil vers le système :
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     Transférez le profil vers la ligne de commande du kernel de la même façon que pour l'installation AutoYaST (utilisez le paramètre <literal>autoupgrade=1</literal> <filename>autoyast=http://host/path/profile.xml</filename>). Pour System z, il s'agit de la seule possibilité.
    </para>
   </listitem>
   <listitem>
    <para>
     Transférez le paramètre <literal>autoupgrade=1</literal> vers la ligne de commande du kernel. Avant de commencer la mise à niveau, copiez le profil sur <filename>/root/autoupg.xml</filename>. Vous n'aurez plus besoin de paramètres de kernel supplémentaires.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Cette dernière approche vous permet de disposer d'une seule ligne de commande du kernel d'installation, même pour des machines différentes ; il vous suffit de copier le profil approprié sur son système de fichiers.
  </para>

  <para>
   Tant qu'un seul système SUSE Linux Enterprise est installé sur votre machine, il n'y aura aucun conflit de paquetage. Si vous n'avez pas défini le profil de façon à interrompre la proposition de mise à niveau, le processus complet ne sera pas interactif. Si vous accédez à la proposition de mise à niveau, vous pouvez modifier ses paramètres de mise à niveau.
  </para>

  <para>
   Une fois la mise à niveau terminée, YaST écrit le fichier <filename>/root/autoupg-updated.xml</filename>, qui contient le profil et les modifications de sélection des logiciels appliquées à la proposition. Ceci se révèle particulièrement utile dans le cadre des mises à niveau de masse avec la même sélection de paquetages. De cette façon, les résolutions de conflits depuis une machine peuvent être facilement appliquées sur d'autres machines, ce qui entraîne une résolution automatique de ces conflits et une mise à niveau non interactive.
  </para>

  <para>
   Si plusieurs systèmes SUSE Linux Enterprise sont installés sur la machine, il vous sera toujours demandé de sélectionner celui que vous souhaitez mettre à niveau. Il n'existe aucun moyen de le sélectionner à l'avance.
  </para>
 </sect1>
 <sect1 id="sec.update.auto.grub">
  <title>Section de menu GRUB pour le démarrage dans la mise à niveau</title>

  <para>
   Une autre façon de démarrer le système consiste à créer une section supplémentaire dans le menu GRUB (il en est de même pour les autres chargeurs de démarrage et architectures), ce qui lance l'installation. Les exemples supposent l'existence d'une partition <filename>/boot</filename> distincte qui est référencée dans GRUB sous la forme <literal>(hd0,0)</literal> :
  </para>

<screen>title Upgrade
    root (hd0,0)
    kernel /upgrade/linux
    install=<replaceable>inst_source_url</replaceable> autoupgrade=1
    autoyast=<replaceable>autoyast_profile_url</replaceable> vga=0x314
    initrd /upgrade/initrd
  </screen>

  <para>
   L'exemple ci-dessus suppose que le kernel d'installation et l'élément d'installation <systemitem>initrd</systemitem> se trouvent dans le répertoire <filename>/boot/upgrade</filename>.
  </para>

  <para>
   Sous System z, vous devez ajouter les paramètres au fichier PARM, en procédant de la même manière que pour une installation pilotée par AutoYaST.
  </para>
 </sect1>
 <sect1 id="sec.update.auto.2nd-stage">
  <title>Seconde étape de la mise à niveau</title>

  <para>
   La mise à niveau automatique par défaut n'exécute pas les changements de configuration pendant la seconde étape. La seule exception est la configuration réseau, qui doit être définie de façon à être préservée dans le profil de mise à niveau AutoYaST.
  </para>

  <para>
   Si l'ajustement de la configuration de certaines zones du système est nécessaire après la mise à niveau (comme la configuration d'un nouveau service), ajoutez les sections appropriées au profil AutoYaST pour la mise à niveau et la configuration des zones du système sélectionnées sera enregistrée pendant la mise à niveau.
  </para>

  <warning>
   <title>la configuration fournie par AutoYaST remplace la configuration existante.</title>
   <para>
    Notez que la configuration existante de cette zone du système sera remplacée et donc détruite par la configuration fournie par AutoYaST.
   </para>
  </warning>

  <para>
   Normalement, le seul ajustement de configuration qui doit être présent dans le profil AutoYaST est l'enregistrement du système auprès de l'outil SMT (Subscription Management Tool) ou de Novell Customer Center (NCC). Si celui-ci est manquant, le système n'accédera pas au dépôt de mise à jour et les mises à jour seront impossibles, sauf si elles sont reconfigurées ultérieurement.
  </para>
 </sect1>
 <sect1 id="sec.update.auto.limitations">
  <title>Restrictions et astuces</title>

  <para/>

  <sect2>
   <title>NetworkManager et enregistrement</title>
   <para>
    Si vous utilisez NetworkManager pour gérer les périphériques et les connexions réseau, la connexion réseau ne sera pas disponible lors de la seconde étape de la mise à niveau. Ceci empêche le système d'exécuter l'enregistrement.
   </para>
  </sect2>

  <sect2>
   <title>Nettoyage de la configuration de la mise à niveau</title>
   <para>
    Si vous apportez des modifications à votre système pour déclencher le processus de mise à niveau (par exemple, en ajoutant une nouvelle section au menu du chargeur de démarrage), vous souhaiterez probablement les supprimer après la mise à niveau.
   </para>
   <para>
    Vous pouvez le faire automatiquement via un script de post-installation. Vous trouverez des exemples à la <xref linkend="createprofile.scripts"/>. Un exemple de script nettoyant l'élément <filename>menu.lst</filename> de GRUB est inclus dans le fichier d'exemple <filename>autoupg.xml</filename>. Assurez-vous que le script correspond à votre configuration et qu'il ne supprime pas plus d'éléments que vous ne le souhaitez.
   </para>
  </sect2>

  <sect2>
   <title>Pour plus d'informations</title>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Documentation Linuxrc : <ulink url="http://en.opensuse.org/SDB:Linuxrc"/>
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
</chapter>
