<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
    type="text/xml"
    title="Profiling step"
?>
<!DOCTYPE chapter
[
   <!ENTITY % entities SYSTEM "entity-decl.ent">
   %entities;
]>


<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.1" xml:base="image_kiwi.xml" xml:id="cha-kiwi"><title>KIWI</title><info><abstract>
  <para>
   KIWI es un sistema para crear imágenes del sistema operativo. Una imagen es un directorio con un archivo que contiene el sistema operativo, sus aplicaciones y configuraciones, la estructura del sistema de archivos del sistema operativo, posibles metadatos adicionales y también, según el tipo de imagen, la geometría del disco y los datos de la tabla de particiones. Con KIWI es posible crear discos LiveCD o LiveDVD, memorias USB, discos virtuales para reproducir sistemas virtuales completos como VMware, imágenes XEN para la paravirtualización en un hipervisor y un entorno PXE para arrancar desde la red.
  </para>

 </abstract></info>
 
 


 <section xml:id="sec-kiwi-prereq">
  <title>Requisitos previos de KIWI</title>

  <para>
   Para crear imágenes con KIWI, es preciso que se cumplan las siguientes condiciones previas:
  </para>

  <orderedlist spacing="normal">
   <listitem>
    <para>
     Debe haber espacio suficiente en el disco para la operación.
    </para>
   </listitem>
   <listitem>
    <para>
     KIWI se divide en varios paquetes, dirigidos a tipos de imágenes distintos. En cualquier caso, se necesita el paquete básico <systemitem class="resource">kiwi</systemitem>. Según la imagen objetivo, se necesitan los paquetes siguientes:
    </para>
    <informaltable>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>
         <para>
          Tipo de imagen
         </para>
        </entry>
        <entry>
         <para>
          Nombre del paquete
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          Medios de instalación
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-oemboot</systemitem>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Virtualización
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-xenboot</systemitem>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Memorias USB
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-usbboot</systemitem>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Cliente de red
         </para>
        </entry>
        <entry>
         <para>
          <systemitem>kiwi-desc-netboot</systemitem>
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </informaltable>
   </listitem>
   <listitem>
    <para>
     Instale el paquete <systemitem class="resource">kiwi-doc</systemitem>. Encontrará ejemplos de configuración que le servirán para darle una idea de la estructura y el contenido.
    </para>
   </listitem>
   <listitem>
    <para>
     Familiarícese con el archivo de configuración de KIWI y su estructura. Se basa en un esquema RELAX NG y hay documentación al respecto en el paquete <systemitem class="resource">kiwi</systemitem> de <filename>/usr/share/doc/packages/kiwi/kiwi.html</filename>. Si desea crear el archivo de configuración desde cero o si quiere insertar elementos o atributos, necesita este documento.
    </para>
   </listitem>
  </orderedlist>
 </section>
 <section xml:id="sec-kiwi-process">
  <title>Descripción del proceso de creación de KIWI</title>

  <para>
   El proceso de creación de KIWI consta de tres pasos:
  </para>

  <orderedlist spacing="normal">
   <listitem>
    <formalpara>
     <title>Extensión física (preparación)</title>
     <para>
      Esta etapa sirve para preparar el contenido del nuevo sistema de archivos. Durante este paso se crea el directorio raíz, se determina qué paquetes se instalarán en la imagen y qué archivos de configuración de usuario se incluirán.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Extensión lógica (creación)</title>
     <para>
      Esta etapa requiere que se haya realizado correctamente el paso de preparación. En este paso se crea la imagen del sistema operativo según el primer paso.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Distribución</title>
     <para>
      El tipo de imagen resultante se puede distribuir de distintas formas, por ejemplo, instalándose en un disco duro o reproduciéndose en un sistema de virtualización (VMware, Qemu, VirtualBox).
     </para>
    </formalpara>
   </listitem>
  </orderedlist>
 </section>
 <section xml:id="sec-kiwi-imagedesc">
  <title>Descripción de la imagen</title>

  <para>
   KIWI necesita una descripción de la imagen para crear un tipo de imagen. La descripción es un directorio que contiene al menos un archivo <filename>config.xml</filename> o, de forma alternativa, con la extensión <filename>*.kiwi</filename>.
  </para>

  <section xml:id="sec-kiwi-imagedescr-contents">
   <title>Contenido de la descripción de la imagen</title>
   <para>
    En la tabla siguiente se incluye más información opcional. Sin embargo, la mayoría de esta información es obligatoria para que el sistema operativo funcione correctamente más adelante:
   </para>
   <table xml:id="tab-kiwi-imagedesc">
    <title>Archivos y directorios adicionales para la descripción de la imagen</title>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>
        <para>
         Archivo o directorio
        </para>
       </entry>
       <entry>
        <para>
         Descripción
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         <filename>config/</filename>
        </para>
       </entry>
       <entry>
        <para>
         Subdirectorio opcional. Contiene guiones Bash que se ejecutan después de instalar todos los paquetes de imagen.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config.sh</filename>
        </para>
       </entry>
       <entry>
        <para>
         Guion de configuración opcional durante la creación de la extensión física.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config.xml</filename>
        </para>
       </entry>
       <entry>
        <para>
         Archivo de configuración de cada descripción de la imagen. Se explica en la <xref linkend="sec-kiwi-config-xml" xrefstyle="select:label"/>.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-cdroot.tgz</filename>
        </para>
       </entry>
       <entry>
        <para>
         Archivo que solo se usa para las imágenes ISO.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-cdroot.sh</filename>
        </para>
       </entry>
       <entry>
        <para>
         Permite manipular los datos extraídos de <filename>config-cdroot.tgz</filename>.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-yast-autoyast.xml</filename>
        </para>
       </entry>
       <entry>
        <para>
         Archivo de configuración creado por AutoYaST.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>config-yast-firstboot.xml</filename>
        </para>
       </entry>
       <entry>
        <para>
         Archivo de configuración para controlar el servidor Firstboot de YaST.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>images.sh</filename>
        </para>
       </entry>
       <entry>
        <para>
         Guión de configuración opcional durante la creación del paso de preparación.
        </para>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         <filename>root/</filename>
        </para>
       </entry>
       <entry>
        <para>
         Contiene otros directorios, archivos especiales y guiones que se modifican <emphasis>después</emphasis> de la instalación de todos los paquetes de imagen.
        </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </section>

  <section xml:id="sec-kiwi-config-xml">
   <title>Archivo <filename>config.xml</filename></title>
   <para>
    Toda la información sobre una descripción de imagen se guarda en el archivo XML de configuración central <filename>config.xml</filename>. Cada vez que se ejecuta KIWI, el archivo <filename>config.xml</filename> se valida con un esquema RELAX NG (consulte <link xlink:href="http://www.relaxng.org"/> para obtener más información sobre el lenguaje de este esquema). Por lo tanto, se recomienda usar un editor de XML adecuado que admita RELAX NG o la documentación sobre el esquema del archivo HTML <filename>/usr/share/doc/packages/kiwi/schema/kiwi.xsd.html</filename>.
   </para>
   <para>
    El archivo de configuración está compuesto por varias partes:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>

     <para>
      Una descripción del autor, información de contacto y una breve explicación.
     </para>
    </listitem>
    <listitem>

     <para>
      Las preferencias necesarias para la etapa de extensión lógica.
     </para>
    </listitem>
    <listitem>

     <para>
      Información sobre los usuarios, sus nombres, sus directorios personales y sus contraseñas.
     </para>
    </listitem>
    <listitem>

     <para>
      Enlaces a repositorios.
     </para>
    </listitem>
    <listitem>

     <para>
      Una lista de paquetes usados para el tipo de imagen definida.
     </para>
    </listitem>
    <listitem>
     <para>
      Otros datos menos importantes que se pueden ver en el archivo HTML mencionado anteriormente de la documentación del esquema RELAX NG.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    En el siguiente ejemplo se muestra un esquema del archivo:
   </para>
   <example xml:id="ex-kiwi-config">
    <title>Archivo de configuración de KIWI</title>
<screen>&lt;image schemeversion="2.0" name="..."&gt; <co xml:id="co-kiwi-config-image"/>
  &lt;description type="system"&gt; <co xml:id="co-kiwi-config-description"/>
    &lt;author&gt;...&lt;/author&gt;
    &lt;contact&gt;...&lt;/contact&gt;
    &lt;specification&gt;...&lt;/specification&gt;
  &lt;/description&gt;
  &lt;preferences&gt; <co xml:id="co-kiwi-config-preferences"/>
    &lt;type primary="true" boot="..." flags="..."&gt;iso&lt;/type&gt;
    &lt;type boot="..." filesystem="ext3" format="vmdk"&gt;vmx&lt;/type&gt;
    &lt;type boot="..." filesystem="ext3"&gt;xen&lt;/type&gt;
    &lt;type boot="..." filesystem="squashfs" flags="unified"&gt;oem&lt;/type&gt;
    &lt;version&gt;2.7.0&lt;/version&gt;
    &lt;size unit="M"&gt;780&lt;/size&gt;
    &lt;packagemanager&gt;zypper&lt;/packagemanager&gt;
    &lt;rpm-check-signatures&gt;False&lt;/rpm-check-signatures&gt;
    &lt;rpm-force&gt;False&lt;/rpm-force&gt;
    &lt;locale&gt;en_US.UTF-8&lt;/locale&gt;
    &lt;oem-swap&gt;no&lt;/oem-swap&gt;
    &lt;oem-boot-title&gt;USB&lt;/oem-boot-title&gt;
  &lt;/preferences&gt;
  &lt;users group="users"&gt; <co xml:id="co-kiwi-config-users"/>
    &lt;user name="root" pwd="" home="/root"/&gt;
  &lt;/users&gt;
  &lt;repository type="rpm-md"&gt; <co xml:id="co-kiwi-config-repository"/>
    &lt;source path="/home/rpmdir"/&gt;
  &lt;/repository&gt;
  &lt;packages type="image" patternPackageType="onlyRequired"&gt; <co xml:id="co-kiwi-config-packages"/>
    &lt;package name="yast2-live-installer"/&gt;
    &lt;package name="pam"/&gt;
    &lt;!-- List of packages reduced --&gt;
  &lt;/packages&gt;</screen>
   </example>
   <calloutlist>
    <callout arearefs="co-kiwi-config-image">
     <para>
      El elemento raíz de todos los archivos de configuración de KIWI. Todos los archivos requieren el número de versión. Se puede usar un atributo <literal>kiwirevision</literal> opcional para especificar una revisión SVN de KIWI.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-description">
     <para>
      Contiene descripciones obligatorias con información sobre el creador de estas descripciones de imagen, su dirección de contacto y una breve explicación.
     </para>
    </callout>

    <callout arearefs="co-kiwi-config-preferences">
     <para>
      Contiene preferencias obligatorias con información sobre la versión de la imagen, el gestor de paquetes usado, los tipos de imagen admitidos y otros ajustes.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-users">
     <para>
      El elemento opcional <literal>users</literal> contiene una lista de todos los usuarios añadidos a la imagen. El elemento <literal>user</literal> contiene el nombre, la vía a su directorio personal, la contraseña y la shell.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-repository">
     <para>
      Contiene una lista obligatoria de repositorios usados por el gestor de paquetes.
     </para>
    </callout>
    <callout arearefs="co-kiwi-config-packages">
     <para>
      Contiene una lista obligatoria de paquetes incluidos en la imagen.
     </para>
    </callout>
   </calloutlist>
   <para>
    En el archivo HTML de las páginas anteriores hay más detalles sobre el archivo de configuración.
   </para>
  </section>
 </section>
 <section xml:id="sec-kiwi-creating">
  <title>Creación de dispositivos con KIWI</title>

  <para>
   En esta sección se describe cómo crear dispositivos con KIWI. Un dispositivo es un sistema operativo diseñado específicamente para una tarea concreta. Por ejemplo, se puede crear un dispositivo orientado a programas ofimáticos.
  </para>

  <section xml:id="sec-kiwi-img-createrepo">
   <title>Creación de un origen de instalación local</title>
   <para>
    Todos los ejemplos de los paquetes <systemitem class="resource">kiwi-doc</systemitem> requieren un origen de instalación válido para poder crear una imagen. Normalmente los ejemplos se conectan a un recurso de red. Cuanto más ancho de banda tenga la red, más rápida será la creación de la imagen. Si no dispone de una red rápida, o si no quiere usarla, cree un recurso de instalación local. Proceda de la siguiente manera:
   </para>
   <procedure>
    <step>
     <para>
      Recopile el DVD de instalación.
     </para>
    </step>
    <step>
     <para>
      Abra una shell y conviértase en usuario <systemitem class="username">Root</systemitem>.
     </para>
    </step>
    <step>
     <para>
      Cree el directorio de instalación local. Los ejemplo usan normalmente la vía <filename>/image/CDs/full-<replaceable>VERSIÓN</replaceable>-<replaceable>ARQUITECTURA</replaceable></filename>. Sustituya las variables <replaceable>VERSIÓN</replaceable> y <replaceable>ARQUITECTURA</replaceable> por sus valores respectivos.
     </para>
    </step>
    <step>
     <para>
      Monte el medio. Sustituya la variable <replaceable>DRIVE</replaceable> por el dispositivo correspondiente (normalmente <filename>dvd,</filename> <filename>cdrom,</filename> etc.):
     </para>
<screen>mount -o loop /dev/<replaceable>DRIVE</replaceable> /mnt</screen>
    </step>
    <step>
     <para>
      Copie todo el contenido del medio en el directorio de instalación:
     </para>
<screen>cp -a /mnt/* /images/CDs/full-<replaceable>VERSION</replaceable>-<replaceable>ARCH</replaceable></screen>
    </step>
   </procedure>
   <para>
    Para usar un origen de instalación local, solo necesita habilitarlo en el elemento <literal>repository</literal>:
   </para>



<screen>&lt;repository type="..."&gt;
  &lt;!-- Remove the comment markers in the next line --&gt;
  &lt;!-- &lt;source path="/image/CDs/full-<replaceable>VERSION</replaceable>-<replaceable>ARCH</replaceable>" --&gt;
  &lt;source path="opensuse://openSUSE:11.0/standard"/&gt; 
&lt;/repository&gt;</screen>
  </section>

  <section xml:id="sec-kiwi-img">
   <title>Creación de una imagen</title>
   <para>
    Una imagen es una imagen de disco virtual que contiene todas las particiones, la información del cargador de arranque y los paquetes presentes en un disco real. Para crear una imagen ISO, siga estos pasos:
   </para>
   <procedure xml:id="pr-kiwi-img">

    <step>
     <para>
      Instale los paquetes <systemitem class="resource">kiwi</systemitem> y <systemitem class="resource">kiwi-doc</systemitem> y resuelva las posibles dependencias.
     </para>
    </step>
    <step>
     <para>
      Abra una shell y conviértase en usuario <systemitem class="username">Root</systemitem>.
     </para>
    </step>
    <step>
     <para>
      Copie el directorio <filename>/usr/share/doc/packages/kiwi/examples/suse-11.0/suse-oem-preload</filename> en el directorio actual.
     </para>
    </step>
    <step>
     <para>
      Abra el archivo <filename>config.xml</filename> y busque el elemento <literal>repository</literal>. Si desea usar un origen de instalación local, consulte la <xref xrefstyle="select: label" linkend="sec-kiwi-img-createrepo"/> para obtener más información.
     </para>
    </step>
    <step xml:id="st-kiwi-prep">
     <para>
      Ejecute KIWI con el comando siguiente para preparar la primera etapa (<quote>la extensión física</quote>):
     </para>
<screen>kiwi --prepare suse-oem-preload --root oem</screen>
    </step>
    <step>
     <para>
      Cree la imagen ISO:
     </para>
<screen>kiwi --create oem --type iso --destdir /tmp/myoem</screen>
    </step>
   </procedure>
  </section>

  <section xml:id="sec-kiwi-img-nfs">
   <title>Creación de una imagen de carga previa con NFS</title>
   <para>
    Para crear una imagen con la función NFS, siga estos pasos:
   </para>
   <procedure xml:id="pr-kiwi-img-nfs">
    <step>
     <para>
      Abra una shell y conviértase en usuario <systemitem class="username">Root</systemitem>.
     </para>
    </step>
    <step>
     <para>
      Copie el directorio <filename>/usr/share/doc/packages/kiwi/examples/suse-11.1/suse-oem-preload</filename> en el directorio actual.
     </para>
    </step>
    <step>
     <para>
      Abra el archivo <filename>suse-oem-preload/config.xml</filename> y busque el elemento <literal>packages</literal> con el atributo <literal>type="image"</literal>.
     </para>
    </step>
    <step>
     <para>
      Inserte esta línea entre <literal>&lt;packages type="image"&gt;</literal> y <literal>&lt;/packages&gt;</literal> y guarde el archivo:
     </para>
<screen>&lt;package name="nfs-client"/&gt;</screen>
    </step>
    <step>
     <para>
      Vuelva a generar la imagen como se describe en el <xref linkend="st-kiwi-prep"/>.
     </para>
    </step>
   </procedure>
  </section>
 </section>
 <section xml:id="sec-kiwi-moreinfo">
  <title>Información adicional</title>
  <para>
   Encontrará más información en los documentos siguiente del portal KIWI, en <link xlink:href="http://en.opensuse.org/Portal:KIWI"/>.
  </para>
 </section>
</chapter>
