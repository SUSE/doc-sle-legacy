<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="deployment_kiwi.xml" id="cha.autokiwi">

 <title>Distribución automatizada de imágenes de carga previa</title>
 <abstract>
  <para>
   Con KIWI puede crear imágenes del sistema operativo. En este capítulo se describe el proceso de distribución de una imagen del sistema a un equipo cliente vacío. Para ello, se debe crear una imagen cargada de carga previa que incluya una imagen RAW arrancable. Este archivo contiene dos partes importantes: una tabla de partición y el sistema operativo real. La imagen RAW se escribe en el disco duro vacío y el sistema operativo se extiende en el espacio de disco restante al arrancar por primera vez.
  </para>

 </abstract>
 <para>
  Para crear una imagen de este tipo, consulte la <xref linkend="sec.kiwi.img"/>. Cuando se crea la imagen ISO, el archivo RAW se encuentra en la carpeta de destino. Hay muchas formas de volcar una imagen RAW en un disco.
 </para>
 <itemizedlist mark="bullet" spacing="normal">
  <listitem>
   <para>
    Conectar el disco a un servidor de distribución y copiar solo la imagen al dispositivo RAW.
   </para>
  </listitem>
  <listitem>
   <para>
    Proporcionar la imagen RAW mediante un servidor HTTP o FTP y volcarla en el disco del equipo cliente.
   </para>
  </listitem>
  <listitem>
   <para>
    Crear una imagen de arranque en red para obtener la imagen y volcarla en el disco. Este método es útil para la distribución masiva.
   </para>
  </listitem>
  <listitem>
   <para>
    Arrancar un disco de rescate y realizar un volcado manual desde la imagen de rescate.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Para empezar rápidamente, es conveniente usar uno de los métodos descritos en la <xref linkend="sec.autokiwi.manual"/>.
 </para>
 <sect1 id="sec.autokiwi.manual">
  <title>Distribución manual del sistema a partir de una imagen de rescate</title>

  <variablelist>
   <varlistentry>
    <term>Distribución con un archivo ISO generado desde KIWI:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Grabe la imagen ISO que obtenga del proceso de creación de KIWI, consulte la <xref linkend="sec.kiwi.img"/> del CD/DVD.
       </para>
      </listitem>
      <listitem>
       <para>
        Arranque desde este medio en el equipo cliente.
       </para>
      </listitem>
      <listitem>
       <para>
        Seleccione el disco duro que se usará para la instalación.
       </para>
      </listitem>
      <listitem>
       <para>
        Reinicie el equipo cliente y arranque desde el disco duro.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Distribución por un sistema de rescate:</term>
    <listitem>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Arranque el equipo cliente con un sistema de rescate. Estos sistemas están disponibles en todos los CD o DVD de instalación de SUSE.
       </para>
      </listitem>
      <listitem>
       <para>
        Entre a la sesión como usuario <systemitem class="username">Root</systemitem>. No introduzca la contraseña.
       </para>
      </listitem>
      <listitem>
       <para>
        Configure la red. Si dispone de DHCP en la red, basta con usar el comando <command>ifup-dhcp eth0</command>. Si debe hacerlo manualmente, use el comando <command>ip</command> para configurar la red. El DHCP inicial de salida también indica la dirección IP del equipo.
       </para>
      </listitem>
      <listitem>
       <para>
        Realice la escucha en un puerto de la red que no se utilice, como el <systemitem>1234</systemitem>, y vuelque los datos entrantes en el disco con el comando siguiente:
       </para>
<screen>netcat -l -p 1234 &gt; /dev/sda</screen>
      </listitem>
      <listitem>
       <para>
        En el servidor generador de imágenes, envíe la imagen RAW al equipo cliente con el comando:
       </para>
<screen>netcat &lt;IP of client&gt; 1234 &lt; $HOME/preload_image/&lt;image_name&gt;</screen>
      </listitem>
      <listitem>
       <para>
        Cuando se haya transferido la imagen, retire el sistema de rescate de la unidad de CD o DVD y apague el equipo cliente. Al volver a arrancar, el cargador de arranque <literal>GRUB</literal> se debe iniciar en el cliente y el sistema Firstboot se hará cargo del proceso.
       </para>
      </listitem>
     </orderedlist>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1>
  <title>Distribución automática con arranque PXE</title>

  <para>
   Si va a efectuar varias instalaciones de un sistema operativo en hardware de características similares, resulta útil dedicar algún tiempo a preparar una distribución masiva del sistema operativo, ya que se ahorrará tiempo en la distribución. Este capítulo describe este proceso. El objetivo es simplemente conectar un equipo, conectarlo a una red, iniciar un arranque en red y esperar a que se apague.
  </para>

  <para>
   Las siguientes acciones se deben efectuar en orden para realizar esta tarea correctamente:
  </para>

  <variablelist>
   <varlistentry>
    <term>Instalar un servidor de arranque e instalación</term>
    <listitem>
     <para>
      Se necesita un equipo dedicado, que debe estar preparado para ofrecer arranque PXE, así como un servidor FTP o Web que proporcione la imagen de carga previa. Resulta útil asignar suficiente memoria al equipo para que pueda alojar todos los datos de instalación necesarios. Para realizar una instalación por defecto, debe haber al menos 4 GB de memoria. Es posible realizar todas las tareas necesarias con SUSE Linux Enterprise Server. Para obtener más información, consulte la <xref linkend="sec.autokiwi.instserver"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Preparar una imagen de carga previa</term>
    <listitem>
     <para>
      La instalación en sí se realiza copiando una imagen RAW del sistema operativo en el disco duro nuevo. Se deben haber preparado y probado con cuidado todas las funciones y ajustes. Para proporcionar una imagen de estas características, se puede usar KIWI (disponible en el SDK del sistema operativo SUSE Linux Enterprise). Hay disponible más información sobre la creación de imágenes con KIWI en el <xref linkend="cha.kiwi"/>. Para obtener más información sobre los requisitos de la imagen de carga previa, consulte la <xref linkend="sec.autokiwi.preloadimage"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Crear un sistema inicial para la distribución</term>
    <listitem>
     <para>
      Para esta tarea se necesita experiencia con Linux. En la <xref linkend="sec.autokiwi.initrd"/> hay una descripción de cómo se puede llevar a cabo esta tarea mediante una instalación de ejemplo.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Configurar el servidor de arranque para la distribución automática</term>
    <listitem>
     <para>
      Se debe indicar al arranque PXE que arranque el sistema de instalación, que a su vez, tomará la imagen de precarga del servidor y la copiará en el disco duro.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <sect2 id="sec.autokiwi.instserver">
   <title>Configuración de un servidor de arranque e instalación</title>
   <para>
    Para realizar esta tarea después de la instalación de SUSE Linux Enterprise Server hay que efectuar cuatro pasos en orden:
   </para>
   <procedure id="proc.autokiwi.instserver">
    <step performance="required">
     <para>
      Configure el origen de la instalación tal y como se describe en la <xref linkend="sec.deployment.remoteinst.instserver"/>. Seleccione un servidor de red HTTP o FTP.
     </para>
    </step>
    <step performance="required">
     <para>
      Configure un servidor TFTP para alojar la imagen de arranque (esta imagen se creará en un paso más adelante). Este aspecto se describe en la <xref linkend="sec.deployment.remoteinst.boot.tftp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Configure un servidor DHCP para que asigne direcciones IP a todos los equipos e indique la ubicación del servidor TFTP al sistema de destino. Este aspecto se describe en la <xref linkend="sec.deployment.remoteinst.boot.dhcp"/>.
     </para>
    </step>
    <step performance="required">
     <para>
      Prepare el arranque PXE del servidor de instalación. Esto se describe con más detalle en la <xref linkend="sec.deployment.remoteinst.boot.pxe"/>.
     </para>
    </step>
   </procedure>
   <para>
    Tenga en cuenta que el proceso de instalación en sí se beneficiará en gran medida si proporciona memoria suficiente en este equipo para que aloje la imagen de carga previa. Asimismo, si usa Gigabit Ethernet, el proceso de distribución será mucho más rápido que si usa redes más lentas.
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.preloadimage">
   <title>Creación de una imagen de carga previa</title>
   <para>
    El proceso de creación de imágenes con KIWI se describe en la <xref linkend="sec.kiwi.img"/>. Sin embargo, para crear un imagen útil para distribución masiva, hay que tener en cuenta muchos aspectos:
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Una imagen de carga previa típica usará el siguiente tipo:
     </para>
<screen>&lt;type primary="true" filesystem="ext3" boot="oemboot/suse-SLES11"&gt;vmx&lt;/type&gt;</screen>
    </listitem>
    <listitem>
     <para>
      Durante la configuración de una imagen de carga previa, el proceso de creación de la imagen se ejecuta varias veces. Los repositorios necesarios para crear la imagen deben estar disponibles en el equipo local.
     </para>
    </listitem>
    <listitem>
     <para>
      Según el uso que se vaya a dar a la carga previa, se debe dedicar tiempo a configurar Firstboot. Encontrará más información sobre Firstboot en el <xref linkend="cha.deployment_firstboot"/>. Con este método puede necesitar también que el usuario realice configuraciones iniciales durante el primer arranque del sistema.
     </para>
    </listitem>
    <listitem>
     <para>
      Se pueden configurar muchas funciones adicionales en la imagen, como añadir repositorios de actualización o realizar una actualización en el arranque inicial. Sin embargo, resulta imposible describir todas las posibilidades en este documento. Además, y según lo que se necesite, la creación de la imagen de carga previa requiere un conocimiento profundo del sistema de creación de imágenes KIWI, así como de otras tecnologías usadas en.<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    La imagen real que se distribuirá debe estar disponible desde el servidor FTP o HTTP proporcionado en el servidor de instalación.
   </para>
  </sect2>

  <sect2 id="sec.autokiwi.initrd">
   <title>Creación de un sistema inicial para distribuir una imagen de carga previa</title>
   <para>
    Para poder ejecutar una distribución automática, hay que iniciar un sistema Linux inicial en el equipo de destino. Durante una instalación típica, el núcleo y el sistema de archivos RAM inicial se leen desde un medio de arranque y los inicia el BIOS. La funcionalidad necesaria se puede implementar en el sistema de archivos RAM que, junto al núcleo, servirá de sistema de inicio.
   </para>
   <para>
    Las funciones principales que debe proporcionar el sistema inicial son: habilitar el acceso al disco duro y hacer que la conexión de red esté disponible. Ambas funciones dependen del hardware en el que vaya a realizar la distribución. En teoría, es posible crear un sistema inicial desde cero, pero para facilitar esta tarea, también es posible modificar el sistema de archivos RAM inicial que usa el equipo durante el arranque.
   </para>
   <para>
    El procedimiento siguiente es solo un ejemplo de cómo crear el sistema de archivos RAM inicial necesario:
   </para>
   <procedure>
    <step performance="required">
     <para>
      Realice una instalación estándar de <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise Server</phrase></phrase> en el sistema de destino.
     </para>
    </step>
    <step performance="required">
     <para>
      Instale el paquete <systemitem>busybox</systemitem> en el sistema.
     </para>
    </step>
    <step performance="required">
     <para>
      Cree un sistema de archivos RAM nuevo con el comando siguiente:
     </para>
<screen>mkinitrd -f busybox -D eth0</screen>
     <para>
      Fíjese en que eth0 representa el dispositivo Ethernet al que está conectado el cable de red. El parámetro <systemitem>-f busybox</systemitem> añade el binario de llamada múltiple <systemitem>busybox</systemitem> al sistema de archivos. Tras realizar esta acción, hay disponible muchos comandos unix estándar en el sistema.
     </para>
    </step>
    <step performance="required">
     <para>
      Copie el nuevo sistema de archivos RAM y el núcleo en el servidor de arranque mediante el comando:
     </para>
<screen>scp /boot/initrd /boot/vmlinuz pxe.example.com:</screen>
     <para>
      Sustituya pxe.example.com por el nombre del servidor de arranque local o la dirección IP.
     </para>
    </step>
    <step performance="required">
     <para>
      Entre en el servidor de arranque como usuario <systemitem class="username">root</systemitem> y cree un directorio donde pueda modificar el sistema de archivos RAM:
     </para>
<screen>mkdir ~/bootimage</screen>
    </step>
    <step performance="required">
     <para>
      Cambie el directorio de trabajo a este directorio mediante el comando <command>cd ~/bootimage</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Desempaquete el sistema de archivos RAM inicial copiado anteriormente mediante el comando:
     </para>
<screen>zcat ../initrd | cpio -i</screen>
    </step>
    <step performance="required">
     <para>
      Edite el archivo <filename>run_all.sh</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Busque la línea siguiente y suprímala, así como el resto del archivo:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 21-nfs.sh </screen>
    </step>
    <step performance="required">
     <para>
      Añada las siguientes líneas al final de los archivos <filename>run_all.sh</filename>:
     </para>
<screen>[ "$debug" ] &amp;&amp; echo preping 92-install.sh
[ "$debug" ] &amp;&amp; echo running 92-install.sh
source boot/92-install.sh
[ "$modules" ] &amp;&amp; load_modules
     </screen>
    </step>
    <step performance="required">
     <para>
      Cree un guion <filename>boot/92-install.sh</filename> nuevo con este contenido:
     </para>
<screen>#!/bin/bash
if [ "$(get_param rawimage)" ]; then
  rawimage=$(get_param rawimage)
  if  [ "$(get_param rawdevice)" ]; then
    rawdevice=$(get_param rawdevice)
    echo "wget -O ${rawdevice} ${rawimage}"
    wget -O ${rawdevice} ${rawimage}
    sync
    sleep 5
    echo "DONE"
  fi
fi
# /bin/bash
/bin/poweroff -f
</screen>
    </step>
    <step performance="required">
     <para>
      Si desea disponer de una shell de depuración antes de que el equipo se apague, elimine el signo de comentario situado delante de <filename>/bin/bash</filename>.
     </para>
    </step>
    <step performance="required">
     <para>
      Haga ejecutable este guion mediante el comando <command>chmod 755 boot/92-install.sh</command>.
     </para>
    </step>
    <step performance="required">
     <para>
      Cree un sistema de archivos RAM inicial con los comandos:
     </para>
<screen>mkdir -p /srv/tftpboot
find . | cpio --quiet -H newc -o | gzip -9 -n &gt; \
/srv/tftpboot/initrd.boot</screen>
    </step>
    <step performance="required">
     <para>
      Copie el núcleo a este directorio:
     </para>
<screen>cp ../vmlinuz /srv/tftpboot/linux.boot</screen>
    </step>
   </procedure>
   <para>
    El sistema de archivos RAM inicial ya está preparado para aceptar dos nuevos parámetros de línea de comandos de núcleo. El parámetro <systemitem>rawimage=&lt;URL&gt;</systemitem> se usa para identificar la ubicación de la imagen de carga previa. Se puede usar cualquier URL que wget entienda. El parámetro <systemitem>rawdevice=&lt;device&gt;</systemitem> se usa para identificar el dispositivo de bloque para el disco duro en el equipo de destino.
   </para>
  </sect2>

  <sect2>
   <title>Configuración del servidor de arranque</title>
   <para>
    Sobre la configuración del servidor de arranque se trata en detalle en varios capítulos descritos en la <xref linkend="sec.autokiwi.instserver"/>. Esta sección ofrece una lista de verificación que cubre los pasos necesarios para configurar el sistema.
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      Configure un servidor DHCP. La subred donde se han instalado los equipos necesita estas líneas adicionales:
     </para>
<screen>filename "pxelinux.0";
next-server 192.168.1.115;</screen>
     <para>
      En este ejemplo, 192.168.1.115 es la dirección IP del servidor PXE pxe.example.com.
     </para>
    </listitem>
    <listitem>
     <para>
      Configure un servidor PXE como se describe en la <xref linkend="sec.deployment.remoteinst.boot.pxe"/>. Al editar <filename>/srv/tftpboot/pxelinux.cfg/default</filename>, añada las entradas siguientes:
     </para>
<screen>default bootinstall
label bootinstall
  kernel linux.boot
  append initrd=initrd.boot \
  rawimage=ftp://192.168.1.115/preload/preloadimage.raw rawdevice=/dev/sda</screen>
    </listitem>
    <listitem>
     <para>
      Configure un servidor FTP y copie la imagen de carga previa preparada en <filename>/srv/ftp/preload/preloadimage.raw</filename>.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Pruebe la configuración arrancando el sistema de destino con el arranque de red PXE. De esta forma se copia automáticamente la imagen de precarga preparada en el disco duro y se apaga el equipo cuando está listo.
   </para>
  </sect2>


 </sect1>







</chapter>
