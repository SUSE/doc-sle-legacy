<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sect1 PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<sect1 xml:base="net_bonding.xml" id="sec.bond">
 <title>设置联接设备</title>

 <para>
  对于某些系统，需要实施高于典型以太网设备的标准数据安全性或可用性要求的网络连接。在这些情况下，可以将多个以太网设备聚合到单个绑定设备。
 </para>

 <para>
  联接设备的配置通过联接模块选项来完成。其行为主要受联接设备模式的影响。默认情况下是 <systemitem>mode=active-backup</systemitem>，即如果活动从属设备发生故障，则其他从属设备将变成活动从属设备。
 </para>

 <tip>
  <title>联接和 Xen</title>
  <para>
   联接设备只对于有多个真实网卡可用的计算机有效。这意味着在大多数配置中，您仅应在 Domain0 中使用联接配置。换言之，只有当您将多个网卡指派给一个 VM Guest 系统时，在 VM Guest 中设置联接才有效。
  </para>
 </tip>

 <para>
  要配置联接设备，请使用以下过程：
 </para>

 <procedure>
  <step performance="required">
   <para>
    运行 <menuchoice><guimenu>YaST</guimenu> <guimenu>网络设备</guimenu> <guimenu>网络设置</guimenu></menuchoice>。
   </para>
  </step>
  <step performance="required">
   <para>
    使用<guimenu>添加</guimenu>并将<guimenu>设备类型</guimenu>更改为<guimenu>联接</guimenu>。按<guimenu>下一步</guimenu>继续。
   </para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step performance="required">
   <para>
    选择如何为联接设备指派 IP 地址。有三种方法可供选择：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      无 IP 地址
     </para>
    </listitem>
    <listitem>
     <para>
      动态地址（使用 DHCP 或 Zeroconf）
     </para>
    </listitem>
    <listitem>
     <para>
      静态指派的 IP 地址
     </para>
    </listitem>
   </itemizedlist>
   <para>
    请使用最适合您环境的方法。
   </para>
  </step>
  <step performance="required">
   <para>
    在<guimenu>联接从属</guimenu>选项卡中，通过激活相关复选框选择应加入到联接中的以太网设备。
   </para>
  </step>
  <step performance="required">
   <para>
    编辑<guimenu>联接驱动程序选项</guimenu>。以下模式可用于配置：
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      balance-rr
     </para>
    </listitem>
    <listitem>
     <para>
      active-backup
     </para>
    </listitem>
    <listitem>
     <para>
      balance-xor
     </para>
    </listitem>
    <listitem>
     <para>
      broadcast
     </para>
    </listitem>
    <listitem>
     <para>
      802.3ad
     </para>
    </listitem>
    <listitem>
     <para>
      balance-tlb
     </para>
    </listitem>
    <listitem>
     <para>
      balance-alb
     </para>
    </listitem>
   </itemizedlist>
  </step>
  <step performance="required">
   <para>
    确保将参数 <literal>miimon=100</literal> 添加到<guimenu>联接驱动程序选项</guimenu>。如果没有此参数，则不会定期检查数据完整性。
   </para>
  </step>
  <step performance="required">
   <para>
    单击<guimenu>下一步</guimenu>，然后单击<guimenu>确定</guimenu>退出 YaST 以创建设备。
   </para>
  </step>
 </procedure>

 <para>
  有关所有模式以及更多选项的详细说明，可在安装 <systemitem>kernel-source</systemitem> 程序包后参见 <filename>/usr/src linux/Documentation/networking/bonding.txt</filename> 中的 <guimenu>Linux 以太网联接驱动程序操作指南</guimenu>。
 </para>

 <sect2>
  <title>联接从属的热插拔</title>
  <para>
   在特定网络环境（如高可用性）下，有几种情况需要替换联接从属接口。原因可能在于网络设备持续故障。解决方案是设置联接从属的热插拔。
  </para>
  <para>
   按常规配置联接（按照 <command>man 5 ifcfg-bonding</command>），例如：
  </para>
<screen>
ifcfg-bond0   
          STARTMODE='auto' # or 'onboot'  
          BOOTPROTO='static'   
          IPADDR='192.168.0.1/24'   
          BONDING_MASTER='yes'   
          BONDING_SLAVE_0='eth0'   
          BONDING_SLAVE_1='eth1'   
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'
</screen>
  <para>
   但要使用 <literal>STARTMODE=hotplug</literal> 和 <literal>BOOTPROTO=none</literal> 指定从属：
  </para>
<screen>
ifcfg-eth0   
          STARTMODE='hotplug'   
          BOOTPROTO='none'   

ifcfg-eth1   
          STARTMODE='hotplug'   
          BOOTPROTO='none'
</screen>
  <para>
   <literal>BOOTPROTO=none</literal> 使用 ethtool 选项（如果提供），但不要在 <command>ifup eth0</command> 上设置链路，因为从属接口由联接主接口控制。
  </para>
  <para>
   <literal>STARTMODE=hotplug</literal> 会让从属接口在可用之时自动加入联接。
  </para>
  <para>
   必须更改 <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> 中的 <systemitem>udev</systemitem> 规则，使之按照总线 ID（udev <systemitem>KERNELS</systemitem> 关键字等于使用 <command>hwinfo --netcard</command> 后出现的“SysFS BusID”）而不是 MAC 地址与设备匹配。这样变更后便可替换有问题的硬件（插在相同插槽中的网卡具有不同的 MAC），并可避免在联接更改其所有从属接口的 MAC 地址时产生混淆。
  </para>
  <para>
   例如：
  </para>
<screen>
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"
</screen>
  <para>
   在引导时，<filename>/etc/init.d/network</filename> 不会等待热插拔从属接口，但会等待联接准备就绪，而这需要至少有一个从属接口可用。当从系统中去除一个从属接口时（从 NIC 驱动程序拆开联结、执行 NIC 驱动程序的 <command>rmmod</command> 命令或 PCI 热插拔去除为 true），内核会自动从联接中将其去除。当向系统添加新网卡时（替换插槽中的硬件），<systemitem>udev</systemitem> 会使用基于总线的网卡设备名称规则将其重命名为从属接口的名称，并为其调用 <command>ifup</command> 命令。<command>ifup</command> 命令会自动调用以将新网卡加入联接。
  </para>
 </sect2>


</sect1>
