<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="depl_smt.xml" id="cha.smt">
 <title>订阅管理</title>

 <para>
  任何运行 SUSE Linux Enterprise Server 11 或 SUSE Linux Enterprise Desktop 11 的计算机都可配置为注册到本地订阅管理工具服务器来下载软件更新，而不是直接与 Novell Customer Center 和 NU 服务器通讯。要使用 SMT 服务器来进行客户端注册并将其当作本地更新源，必须先在您的网络中配置 SMT 服务器。SMT 服务器软件作为 SUSE Linux Enterprise Server 的外接式附件分发，《<emphasis>Subscription Management Tool Guide</emphasis>》（Subscription Management Tool 指南）中描述了有关它的配置。要配置为注册到 SMT 服务器，不需要在客户端上安装任何外接式附件。
 </para>
 <para>
  要将客户端注册到 SMT 服务器，需要为客户端配备此服务器的 URL。因为在注册过程中，客户端和服务器通过 HTTPS 协议进行通讯，所以还需要确保客户端信任服务器的证书。如果 SMT 服务器设置为使用默认服务器证书，则可在 SMT 服务器上通过 HTTP 协议获得 CA 证书，网址为：<literal>http://<replaceable>FQDN</replaceable>/smt.crt</literal>。在这种情况下，您无需关注该证书：除非另有配置，否则注册过程将自动从那里下载 CA 证书。如果证书由某个外部证书颁发机构颁发，则必须输入该服务器的 CA 证书的路径。
 </para>
 <note>
  <title>注册到 <literal>*.novell.com</literal> 子域</title>
  <para>
   如果试图注册到任何 <literal>*.novell.com</literal> 子域，注册过程中不会下载证书（出于安全原因），也不会进行证书处理。在此类情况下，请使用其他域名或纯 IP 地址。
  </para>
 </note>
 <para>
  有几种方式可以提供此信息并将客户端计算机配置为使用 SMT。第一种方式是在引导时通过内核参数提供所需信息。第二种方式是使用 AutoYaST 配置文件配置客户端。还有一个通过 Subscription Management Tool 分发的脚本 <command>clientSetup4SMT.sh</command>，它可以在客户端运行，使其注册到某个指定的 SMT 服务器。以下几节中描述了这些方法：
 </para>
 <sect1 id="smt.client.parameters">
  <title>使用内核参数访问 SMT 服务器</title>

  <para>
   任何客户端都可以通过在计算机引导过程中提供以下内核参数来配置为使用 SMT：<literal>regurl</literal> 和 <literal>regcert</literal>。第一个参数是必需的，第二个是可选的。
  </para>

  <variablelist>
   <varlistentry>
    <term>regurl</term>
    <listitem>
     <para>
      SMT 服务器的 URL。URL 的格式如下：<literal>https://<replaceable>FQDN</replaceable>/center/regsvc/</literal>，其中 <replaceable>FQDN</replaceable> 是 SMT 服务器的完全限定主机名。它必须与 SMT 服务器上使用的服务器证书的 FQDN 相同。示例：
     </para>
<screen>regurl=https://smt.example.com/center/regsvc/</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>regcert</term>
    <listitem>
     <para>
      SMT 服务器的 CA 证书的位置。指定以下位置之一：
     </para>
     <variablelist>
      <varlistentry>
       <term>URL</term>
       <listitem>
        <para>
         可以下载证书的远程位置（http、https 或 ftp）。示例：
        </para>
<screen>regcert=http://smt.example.com/smt.crt</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>软盘</term>
       <listitem>
        <para>
         指定软盘上的位置。必须在引导时插入软盘（如果没有软盘，系统将不会提示您插入）。值必须以字符串 <literal>floppy</literal> 开头，后跟证书的路径。示例：
        </para>
<screen>regcert=floppy/smt/smt-ca.crt</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>本地路径</term>
       <listitem>
        <para>
         本地计算机上证书的绝对路径。示例：
        </para>
<screen>regcert=/data/inst/smt/smt-ca.cert</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>交互式</term>
       <listitem>
        <para>
         使用 <literal>ask</literal> 可在安装期间打开一个弹出菜单，您可在其中指定证书的路径。请勿将此选项用于 AutoYaST。示例：
        </para>
<screen>regcert=ask</screen>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>停用证书安装</term>
       <listitem>
        <para>
         如果证书将由外接式附件产品安装，或您将使用由正式证书颁发机构颁发的证书，请使用<literal>已完成</literal>选项。示例：
        </para>
<screen>regcert=done</screen>
       </listitem>
      </varlistentry>
     </variablelist>
    </listitem>
   </varlistentry>
  </variablelist>

  <warning>
   <title>当心键入错误</title>
   <para>
    确保您输入的值是正确的。如果尚未正确指定 <literal>regurl</literal>，更新源的注册将失败。
   </para>
   <para>
    如果输入了错误的 <literal>regcert</literal> 值，系统将提示您输入证书的本地路径。如果根本未指定 <literal>regcert</literal>，它将默认为 <literal>http://<replaceable>FQDN</replaceable>/smt.crt</literal>，其中 <literal>FQDN</literal> 是 SMT 服务器的名称。
   </para>
  </warning>

  <warning>
   <title>SMT 服务器证书的更改</title>
   <para>
    如果 SMT 服务器从某个新的不可信 CA 获得了新证书，客户端需要获取这个新 CA 证书文件。此操作会在注册过程中自动完成，但前提是安装时使用 URL 获取证书或忽略了 <literal>regcert</literal> 参数因而使用了默认 URL。如果使用任何其他方法（如软盘或本地路径）装载了证书，将不会更新 CA 证书。
   </para>
  </warning>
 </sect1>
 <sect1 id="smt.client.autoyast">
  <title>使用 AutoYaST 配置文件配置客户端</title>

  <para>
   通过 AutoYaST 配置文件，可将客户端配置为注册到 SMT 服务器。关于创建 AutoYaST 配置文件和准备自动安装的一般信息，请参见<xref linkend="cha.deployment.autoinst"/>。本节仅介绍特定于 SMT 的配置。
  </para>

  <para>
   要使用 AutoYaST 配置特定于 SMT 的数据，请遵循以下步骤：
  </para>

  <procedure>
   <step performance="required">
    <para>
     以 <systemitem class="username">root</systemitem> 身份启动 YaST，然后选择<menuchoice> <guimenu>杂项</guimenu> <guimenu>自动安装</guimenu> </menuchoice>启动图形 AutoYaST 前端。
    </para>
    <para>
     如果要从命令行启动图形 AutoYaST 前端，可以使用 <command>yast2 autoyast</command> 命令来完成。

    </para>
   </step>
   <step performance="required">
    <para>
     通过<menuchoice><guimenu>文件</guimenu><guimenu>打开</guimenu></menuchoice>打开现有的配置文件，通过<menuchoice><guimenu>工具</guimenu><guimenu>创建参考配置文件</guimenu></menuchoice>基于当前系统配置创建一个配置文件，或者只使用空的配置文件。
    </para>
   </step>
   <step performance="required">
    <para>
     选择<menuchoice><guimenu>支持</guimenu><guimenu>Novell Customer Center 配置</guimenu></menuchoice>。将显示当前配置的概述。
    </para>
   </step>
   <step performance="required">
    <para>
     单击<guimenu>编辑</guimenu>。
    </para>
   </step>
   <step performance="required">

    <para>
     要在安装时自动注册，选择<guimenu>运行产品注册</guimenu>。通过<guimenu>硬件配置文件</guimenu>和<guimenu>可选信息</guimenu>，您可以包含系统中的信息。
    </para>
   </step>
   <step performance="required">
    <para>
     设置 <guimenu>SMT 服务器</guimenu>的 URL，并设置 <guimenu>SMT 证书</guimenu>的位置（可选）。可能的值与内核参数 <literal>regurl</literal> 和 <literal>regcert</literal> 的值相同（请参见<xref linkend="smt.client.parameters"/>）。唯一的例外是，<literal>regcert</literal> 的 <literal>ask</literal> 值在 AutoYaST 中不起作用，因为设置为该值将需要用户的交互。如果使用该值，将跳过注册过程。
    </para>
   </step>
   <step performance="required">
    <para>
     执行部署系统所需的所有其他配置。
    </para>
   </step>
   <step performance="required">
    <para>
     选择<menuchoice> <guimenu>文件</guimenu> <guimenu>另存为</guimenu> </menuchoice>，然后输入配置文件的名称，如 <filename>autoinst.xml</filename>。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="smt.client.clientsetupscript">
  <title>使用脚本 clientSetup4SMT.sh 配置客户端</title>

  <para>
   SMT 随附了 <command>/usr/share/doc/packages/smt/clientSetup4SMT.sh</command> 脚本。通过此脚本，可以将客户端计算机配置为使用 SMT 服务器或将其重新配置为使用其他 SMT 服务器。
  </para>

  <para>
   要通过 <command>clientSetup4SMT.sh</command> 脚本将客户端计算机配置为使用 SMT，请遵循以下步骤：
  </para>

  <procedure>
   <step performance="required">
    <para>
     将 <filename>/usr/share/doc/packages/smt/clientSetup4SMT.sh</filename> 脚本从 SMT 服务器复制到客户端计算机。
    </para>
   </step>
   <step performance="required">
    <para>
     在客户端计算机上以 <systemitem class="username">root</systemitem> 身份执行该脚本。执行脚本的方式有两种。第一种情况，脚本名称后跟注册 URL：<command>./clientSetup4SMT.sh <replaceable>registration_URL_</replaceable></command>，例如，<command>./clientSetup4SMT.sh https://smt.example.com/center/regsvc</command>。第二种情况，脚本名称后跟 <option>--host</option> 选项，接着后跟 SMT 服务器的主机名：<command>./clientSetup4SMT.sh --host <replaceable>server_hostname</replaceable></command>，例如，<command>./clientSetup4SMT.sh --host smt.example.com</command>。
    </para>
    
    <important>
     <title><option>--host</option> 参数</title>
     <para>
      对于需要使用 <option>--host</option> 参数提供的主机名，其名称应与证书颁发对象的名称相同。此外，如果证书中的名称是完全限定的主机名（例如 smt.example.com），此处也要这样输入 — 输入<quote>简称</quote>(smt) 会导致 <command>clientSetup4SMT.sh</command> 脚本失败。 
     </para>
    </important>
    
   </step>
   <step performance="required">
    <para>
     该脚本下载服务器的 CA 证书。通过按 <keycap>y</keycap> 键接受它。
    </para>
   </step>
   <step performance="required">
    <para>
     该脚本在客户端执行所有必需的修改。但是，注册本身不是由该脚本执行的。
    </para>
   </step>
   <step performance="required">
    <para>
     通过在客户端执行 <command>suse_register</command> 或运行 <command>yast2 inst_suse_register</command> 模块来执行注册。
    </para>
   </step>
  </procedure>




 </sect1>
 <sect1>
  <title>将客户端注册到 SMT 测试环境</title>

  <para>
   要将客户端配置为注册到测试环境而非生产环境，通过进行以下设置在客户端计算机上修改 <filename>/etc/suseRegister.conf</filename>：
   
   
  </para>

<screen>register = command=register&amp;testenv=1</screen>

  <para>
   有关在测试环境中使用 SMT 的更多信息，请参见《<emphasis>Subscription Management Tool Guide</emphasis>》（Subscription Management Tool 指南）。
  </para>
 </sect1>
</chapter>
